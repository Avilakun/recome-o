<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunter x Hunter RPG Sheet</title>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['Orbitron', 'sans-serif'],
              sans: ['Rajdhani', 'sans-serif'],
            },
            colors: {
              'neon-green': '#00ff9d',
              'neon-blue': '#00f0ff',
              'neon-red': '#ff0055',
              'neon-yellow': '#ffe600',
              'neon-theme': 'var(--theme-color-hex, #00ff9d)',
              'neon-dark': '#0a0a0f',
              'neon-card': '#0e0e14',
            }
          }
        }
      }
    </script>

    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color-hex: #00ff9d;
            --theme-rgb: 0, 255, 157;
        }

        body {
            background-color: #050505;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* App-like feel */
        }

        /* Utilit√°rios de Scroll */
        .custom-scrollbar { overflow-y: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Anima√ß√µes simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs limpos */
        input, select { background: transparent; outline: none; }
        
        /* Containers */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px; /* Mobile width constraint on desktop */
            margin: 0 auto;
            background-color: #0a0a0f;
            position: relative;
            border-left: 1px solid #1f2937;
            border-right: 1px solid #1f2937;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- O conte√∫do ser√° injetado aqui via JavaScript -->
    </div>

    <!-- DB e L√≥gica -->
    <script>
        // --- DADOS DO SISTEMA ---
        const SYSTEM_DB = {
            classes: [
                { id: 'INTENSIFICA√á√ÉO', color: '#00ff9d', desc: 'Focado em fortalecer o corpo.' },
                { id: 'TRANSFORMA√á√ÉO', color: '#d946ef', desc: 'Muda propriedades da aura.' },
                { id: 'MATERIALIZA√á√ÉO', color: '#ff0055', desc: 'Cria objetos f√≠sicos.' },
                { id: 'ESPECIALIZA√á√ÉO', color: '#00f0ff', desc: 'Capacidades √∫nicas.' },
                { id: 'MANIPULA√á√ÉO', color: '#9ca3af', desc: 'Controla seres ou objetos.' },
                { id: 'EMISS√ÉO', color: '#ffe600', desc: 'Projeta aura longe.' }
            ],
            xpTable: [50, 150, 350, 500, 800, 1000, 1500, 2500, 3200, 4000, 5000, 6500],
            racas: [
                { nome: "Humano Comum", mods: {FOR:1, DES:1, CON:1, INT:1, SAB:1, CAR:1} },
                { nome: "Fanalis", mods: {FOR:4, DES:2, CON:-2, INT:-2, SAB:-2, CAR:-2} },
                { nome: "Kurta", mods: {INT:2} },
                { nome: "Neans", mods: {INT:2} },
                { nome: "Chimera Ant", mods: {CON:2, FOR:1} }
            ],
            skills: [
                'Acrobacia', 'Arcanismo', 'Atletismo', 'Atua√ß√£o', 'Engana√ß√£o',
                'Furtividade', 'Hist√≥ria', 'Intimida√ß√£o', 'Intui√ß√£o', 'Investiga√ß√£o',
                'Lidar com Animais', 'Medicina', 'Natureza', 'Percep√ß√£o', 'Persuas√£o',
                'Prestidigita√ß√£o', 'Religi√£o', 'Sobreviv√™ncia'
            ]
        };

        // --- ESTADO GLOBAL ---
        const state = {
            view: 'LIST', // LIST, CREATOR, SHEET
            activeTab: 'FICHA',
            characters: [],
            currentChar: null,
            creatorStep: 0,
            tempChar: null // Usado no criador
        };

        // --- GERENCIAMENTO DE STORAGE ---
        function loadCharacters() {
            const chars = [];
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('hxhrpg_')) {
                    try {
                        chars.push(JSON.parse(localStorage.getItem(key)));
                    } catch(e) { console.error(e); }
                }
            }
            state.characters = chars.sort((a,b) => new Date(b.lastMod) - new Date(a.lastMod));
        }

        function saveCharacter(char) {
            char.lastMod = new Date().toISOString();
            localStorage.setItem('hxhrpg_' + char.id, JSON.stringify(char));
            loadCharacters();
        }

        function deleteCharacter(id) {
            if(confirm('Tem certeza que deseja apagar esta ficha?')) {
                localStorage.removeItem('hxhrpg_' + id);
                loadCharacters();
                if (state.currentChar && state.currentChar.id === id) {
                    state.view = 'LIST';
                    state.currentChar = null;
                }
                render();
            }
        }

        // --- UTILIT√ÅRIOS ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        
        function getMod(val) { return Math.floor((val - 10) / 2); }
        function getModStr(val) { const m = getMod(val); return m >= 0 ? `+${m}` : `${m}`; }

        function setThemeColor(hex) {
            document.documentElement.style.setProperty('--theme-color-hex', hex);
        }

        // --- RENDERIZADORES (VIEWS) ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; // Limpa tudo

            if (state.view === 'LIST') {
                renderList(app);
            } else if (state.view === 'CREATOR') {
                renderCreator(app);
            } else if (state.view === 'SHEET') {
                renderSheet(app);
            }

            // Re-inicializa √≠cones Lucide ap√≥s injetar HTML
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // 1. LISTA DE PERSONAGENS (LOBBY)
        function renderList(container) {
            const level0 = state.characters.filter(c => c.level === 0);
            const levelHigh = state.characters.filter(c => c.level > 0);

            let html = `
                <div class="p-6 flex flex-col h-full fade-in">
                    <div class="text-center mb-8 mt-4">
                        <h1 class="font-display font-black text-3xl tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">HxH 5e RPG</h1>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Banco de Dados</p>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scrollbar space-y-8 pb-20">
            `;

            // SE√á√ÉO: INICIANTES (N√çVEL 0)
            html += `
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="circle-dashed" class="text-gray-500 w-4 h-4"></i>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Iniciantes (N√≠vel 0)</h2>
                    </div>
            `;

            if (level0.length === 0) {
                html += `
                    <div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">
                        Nenhuma ficha de n√≠vel 0 encontrada.
                    </div>
                `;
            } else {
                level0.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-gray-600 transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')">
                            <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500">
                                <i data-lucide="user" size="16"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-display font-bold text-white text-base">${char.name}</h3>
                                <p class="text-[10px] text-gray-400 uppercase">${char.race} ‚Ä¢ <span style="color:${color}">${char.class}</span></p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors">
                                <i data-lucide="trash-2" size="16"></i>
                            </button>
                        </div>
                    `;
                });
            }
            html += `</div>`;

            // SE√á√ÉO: USU√ÅRIOS DE NEN (N√çVEL 1+)
            html += `
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="zap" class="text-neon-green w-4 h-4"></i>
                        <h2 class="text-xs font-bold text-neon-green uppercase tracking-widest">Usu√°rios de Nen (N√≠vel 1-12)</h2>
                    </div>
            `;

            if (levelHigh.length === 0) {
                html += `
                    <div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">
                        Nenhum Hunter registrado.
                    </div>
                `;
            } else {
                levelHigh.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-[${color}] transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')" style="border-left: 3px solid ${color}">
                            <div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500">
                                <i data-lucide="shield" size="16"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-display font-bold text-white text-base">${char.name}</h3>
                                <p class="text-[10px] text-gray-400 uppercase">LVL ${char.level} ‚Ä¢ <span style="color:${color}">${char.class}</span></p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors">
                                <i data-lucide="trash-2" size="16"></i>
                            </button>
                        </div>
                    `;
                });
            }
            html += `</div>`;

            html += `
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent max-w-[480px] mx-auto">
                        <button onclick="startCreator()" class="w-full py-4 bg-neon-green text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 shadow-[0_0_20px_rgba(0,255,157,0.4)] transition-all flex items-center justify-center gap-2">
                            <i data-lucide="plus"></i> CRIAR NOVA FICHA
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // 2. CRIADOR DE PERSONAGENS (5 ETAPAS)
        function renderCreator(container) {
            if (!state.tempChar) {
                state.tempChar = {
                    name: '',
                    class: 'INTENSIFICA√á√ÉO',
                    race: 'Humano Comum',
                    attributes: { FOR:10, DES:10, CON:10, INT:10, SAB:10, CAR:10 },
                    skills: [] // Lista de strings
                };
            }

            const step = state.creatorStep;
            let contentHtml = '';
            let title = '';

            // ETAPA 0: IDENTIDADE
            if (step === 0) {
                title = 'IDENTIDADE';
                contentHtml = `
                    <div class="space-y-6 text-center animate-in slide-in-from-right duration-300">
                        <div class="relative">
                             <input type="text" id="creator-name" value="${state.tempChar.name}" placeholder="Nome do Personagem" class="w-full bg-gray-800 border-2 border-gray-700 rounded-xl p-4 text-white text-center font-bold focus:border-neon-green focus:shadow-[0_0_15px_rgba(0,255,157,0.2)] transition-all" oninput="state.tempChar.name = this.value">
                        </div>
                        
                        <div>
                            <p class="text-xs text-gray-400 uppercase font-bold mb-3 tracking-widest">Tipo de Nen / Classe</p>
                            <div class="grid grid-cols-2 gap-2">
                                ${SYSTEM_DB.classes.map(c => `
                                    <button onclick="setCreatorClass('${c.id}')" class="p-3 rounded-lg border text-[10px] font-bold transition-all ${state.tempChar.class === c.id ? `bg-gray-800 text-white transform scale-[1.02]` : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}" style="border-color: ${state.tempChar.class === c.id ? c.color : '#1f2937'}; box-shadow: ${state.tempChar.class === c.id ? `0 0 10px ${c.color}40` : 'none'}">
                                        ${c.id}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 italic border-t border-gray-800 pt-4">"${SYSTEM_DB.classes.find(c => c.id === state.tempChar.class).desc}"</p>
                    </div>
                `;
            }
            // ETAPA 1: RA√áA
            else if (step === 1) {
                title = 'RA√áA';
                contentHtml = `
                    <div class="space-y-3 animate-in slide-in-from-right duration-300">
                        ${SYSTEM_DB.racas.map(r => `
                            <div onclick="state.tempChar.race = '${r.nome}'; render();" class="p-4 rounded-xl border cursor-pointer transition-all ${state.tempChar.race === r.nome ? 'bg-neon-green/10 border-neon-green shadow-[inset_0_0_20px_rgba(0,255,157,0.1)]' : 'bg-gray-900 border-gray-800 hover:border-gray-700'}">
                                <div class="font-bold text-white flex justify-between items-center">
                                    ${r.nome}
                                    ${state.tempChar.race === r.nome ? '<div class="bg-neon-green text-black rounded-full p-0.5"><i data-lucide="check" size="12"></i></div>' : ''}
                                </div>
                                <div class="text-[10px] text-gray-400 mt-2 flex flex-wrap gap-2">
                                    ${Object.entries(r.mods || {}).map(([k,v]) => `
                                        <span class="bg-black/30 px-2 py-0.5 rounded border border-gray-700">${k} ${v>0?'+':''}${v}</span>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            // ETAPA 2: ATRIBUTOS
            else if (step === 2) {
                title = 'ATRIBUTOS';
                contentHtml = `
                    <div class="space-y-4 text-center animate-in slide-in-from-right duration-300">
                        <div class="bg-gray-900/50 p-4 rounded-xl border border-dashed border-gray-700 mb-6">
                            <p class="text-xs text-gray-400">Distribua os pontos base do seu personagem.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            ${Object.keys(state.tempChar.attributes).map(attr => `
                                <div class="bg-gray-900 p-3 rounded-xl border border-gray-700 hover:border-gray-500 transition-colors">
                                    <div class="text-xs font-bold text-gray-500 mb-1 tracking-wider">${attr}</div>
                                    <div class="flex items-center justify-between">
                                        <button onclick="updateCreatorAttr('${attr}', -1)" class="w-8 h-8 bg-gray-800 rounded text-white hover:bg-gray-700 flex items-center justify-center border border-gray-600 active:scale-95 transition-transform"><i data-lucide="minus" size="14"></i></button>
                                        <span class="text-xl font-bold text-white font-display w-8">${state.tempChar.attributes[attr]}</span>
                                        <button onclick="updateCreatorAttr('${attr}', 1)" class="w-8 h-8 bg-gray-800 rounded text-white hover:bg-gray-700 flex items-center justify-center border border-gray-600 active:scale-95 transition-transform"><i data-lucide="plus" size="14"></i></button>
                                    </div>
                                    <div class="text-[10px] font-bold text-neon-green mt-2 bg-neon-green/10 rounded py-0.5 border border-neon-green/20">Mod: ${getModStr(state.tempChar.attributes[attr])}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            // ETAPA 3: PER√çCIAS (NOVO)
            else if (step === 3) {
                title = 'PER√çCIAS';
                const selectedCount = state.tempChar.skills.length;
                const maxSkills = 3;
                contentHtml = `
                    <div class="space-y-2 animate-in slide-in-from-right duration-300">
                        <div class="text-center mb-4 sticky top-0 bg-gray-950 pb-2 border-b border-gray-800 z-10">
                            <span class="text-xs uppercase tracking-widest ${selectedCount > maxSkills ? 'text-red-500' : 'text-neon-green'}">
                                Selecionado: ${selectedCount} / ${maxSkills}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 gap-2 pb-4">
                            ${SYSTEM_DB.skills.map(skill => {
                                const isSelected = state.tempChar.skills.includes(skill);
                                return `
                                <div onclick="toggleCreatorSkill('${skill}')" class="flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${isSelected ? 'bg-neon-green/10 border-neon-green text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}">
                                    <span class="text-sm font-medium">${skill}</span>
                                    ${isSelected ? '<i data-lucide="check-circle" size="16" class="text-neon-green"></i>' : '<i data-lucide="circle" size="16"></i>'}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            // ETAPA 4: REVIS√ÉO (NOVO)
            else if (step === 4) {
                title = 'REVIS√ÉO';
                const color = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class).color;
                contentHtml = `
                    <div class="space-y-6 animate-in slide-in-from-right duration-300">
                        <div class="text-center">
                            <h2 class="text-3xl font-display font-bold text-white mb-1">${state.tempChar.name || 'Sem Nome'}</h2>
                            <span class="bg-[${color}]/20 text-[${color}] px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest border border-[${color}]/30">${state.tempChar.class}</span>
                        </div>

                        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 space-y-4">
                            <div class="flex justify-between border-b border-gray-800 pb-2">
                                <span class="text-xs text-gray-500 uppercase">Ra√ßa</span>
                                <span class="text-sm font-bold text-white">${state.tempChar.race}</span>
                            </div>
                            
                            <div>
                                <span class="text-xs text-gray-500 uppercase block mb-2">Atributos</span>
                                <div class="grid grid-cols-6 gap-1 text-center">
                                    ${Object.entries(state.tempChar.attributes).map(([k,v]) => `
                                        <div class="bg-black rounded p-1">
                                            <div class="text-[8px] text-gray-500">${k}</div>
                                            <div class="text-xs font-bold text-white">${v}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <span class="text-xs text-gray-500 uppercase block mb-2">Per√≠cias (${state.tempChar.skills.length})</span>
                                <div class="flex flex-wrap gap-1">
                                    ${state.tempChar.skills.length > 0 ? state.tempChar.skills.map(s => `
                                        <span class="text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-700">${s}</span>
                                    `).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhuma selecionada</span>'}
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-neon-green/5 border border-neon-green/20 rounded-xl text-center">
                            <p class="text-xs text-neon-green">Pronto para iniciar sua jornada Hunter?</p>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="flex flex-col h-full bg-gray-950 fade-in">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                        <button onclick="state.view='LIST'; render()" class="text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-bold text-gray-500 tracking-widest mb-1">CRIADOR DE FICHA</span>
                            <div class="flex gap-1">
                                ${[0,1,2,3,4].map(i => `
                                    <div class="w-8 h-1 rounded-full ${i <= step ? 'bg-neon-green' : 'bg-gray-800'} transition-all duration-300"></div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="w-6"></div>
                    </div>
                    
                    <div class="flex-1 p-6 overflow-y-auto custom-scrollbar relative">
                        <h2 class="text-xl font-display font-bold text-white text-center mb-6 tracking-widest">${title}</h2>
                        ${contentHtml}
                    </div>

                    <div class="p-6 border-t border-gray-800 flex gap-4 bg-gray-900/50">
                        ${step > 0 ? `<button onclick="state.creatorStep--; render()" class="flex-1 py-4 bg-gray-800 rounded-xl text-white font-bold hover:bg-gray-700 transition-colors text-xs uppercase tracking-wider">VOLTAR</button>` : ''}
                        
                        ${step < 4 
                            ? `<button onclick="nextCreatorStep()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl hover:brightness-110 transition-colors text-xs uppercase tracking-wider">PR√ìXIMO</button>`
                            : `<button onclick="finishCreator()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl shadow-[0_0_20px_rgba(var(--theme-rgb),0.4)] hover:brightness-110 transition-colors text-xs uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="save" size="16"></i> FINALIZAR</button>`
                        }
                    </div>
                </div>
            `;
        }

        // 3. FICHA DO PERSONAGEM (SHEET)
        function renderSheet(container) {
            const char = state.currentChar;
            const clsData = SYSTEM_DB.classes.find(c => c.id === char.class);
            const themeColor = clsData ? clsData.color : '#00ff9d';
            setThemeColor(themeColor);

            // Calcula barras
            const nextXp = char.xp_next || 100;
            const xpPct = Math.min(100, (char.xp / nextXp) * 100);

            // Conte√∫do da Aba
            let tabContent = '';
            
            if (state.activeTab === 'FICHA') {
                tabContent = `
                    <div class="grid grid-cols-2 gap-3 p-4 fade-in">
                        ${Object.entries(char.attributes).map(([key, attr]) => {
                            const mod = getMod(attr.value);
                            return `
                            <div class="bg-gray-900/60 border border-gray-800 rounded-2xl p-4 flex flex-col items-center relative hover:border-[${themeColor}] transition-colors group select-none" ondblclick="rollDice('${key}', ${mod})">
                                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 group-hover:text-[${themeColor}] transition-colors">${key}</span>
                                <div class="flex items-center gap-3">
                                    <button onclick="updateSheetAttr('${key}', -1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="minus" size="12"></i></button>
                                    <span class="text-3xl font-display font-bold text-white shadow-black drop-shadow-lg">${attr.value}</span>
                                    <button onclick="updateSheetAttr('${key}', 1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="plus" size="12"></i></button>
                                </div>
                                <div class="mt-2 bg-gray-800 px-3 py-0.5 rounded-full text-xs font-bold text-[${themeColor}] border border-gray-700">
                                    ${mod >= 0 ? '+'+mod : mod}
                                </div>
                                <!-- Shield Toggle -->
                                <button onclick="toggleSave('${key}')" class="absolute top-2 right-2 ${attr.save ? `text-[${themeColor}]` : 'text-gray-700'}">
                                    <i data-lucide="shield" size="14" class="${attr.save ? 'fill-current opacity-20' : ''}"></i>
                                    ${attr.save ? `<span class="absolute -bottom-2 -right-1 text-[8px] font-bold">+2</span>` : ''}
                                </button>
                            </div>
                            `;
                        }).join('')}
                        <div class="col-span-2 mt-4">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 px-2">Per√≠cias Treinadas</h3>
                            <div class="flex flex-wrap gap-2 px-2">
                                ${char.skills && char.skills.length > 0 ? char.skills.map(skill => `
                                    <span class="bg-gray-800 border border-gray-700 px-3 py-1 rounded-lg text-xs text-gray-300 flex items-center gap-1">
                                        <i data-lucide="check" size="10" class="text-[${themeColor}]"></i> ${skill}
                                    </span>
                                `).join('') : '<span class="text-xs text-gray-600 italic">Nenhuma per√≠cia treinada.</span>'}
                            </div>
                        </div>
                    </div>
                `;
            } 
            else if (state.activeTab === 'INV') {
                tabContent = `
                    <div class="p-4 fade-in space-y-4">
                        <div class="flex gap-2">
                            <input type="text" id="new-item-name" placeholder="Nome do item..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-[${themeColor}]">
                            <button onclick="addItem()" class="bg-[${themeColor}] text-black px-4 rounded-lg font-bold hover:brightness-110"><i data-lucide="plus"></i></button>
                        </div>
                        <div class="space-y-2">
                            ${char.inventory.length === 0 ? '<div class="text-center text-gray-600 text-xs py-8 border border-dashed border-gray-800 rounded-xl">Mochila vazia.</div>' : ''}
                            ${char.inventory.map((item, idx) => `
                                <div class="bg-gray-900 border border-gray-800 rounded-xl p-3 flex justify-between items-center">
                                    <span class="text-sm font-bold text-white">${item.name}</span>
                                    <div class="flex items-center gap-3">
                                        <button onclick="updateItemQty(${idx}, -1)" class="text-gray-500 hover:text-white"><i data-lucide="minus" size="14"></i></button>
                                        <span class="text-sm w-4 text-center">${item.qty}</span>
                                        <button onclick="updateItemQty(${idx}, 1)" class="text-gray-500 hover:text-white"><i data-lucide="plus" size="14"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-gray-800 text-xs text-gray-400">
                            <span class="uppercase font-bold tracking-widest">Jenny (Dinheiro)</span>
                            <div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-700">
                                <span class="text-[${themeColor}] font-bold">$</span>
                                <input type="number" value="${char.money}" onchange="updateMoney(this.value)" class="w-24 text-right bg-transparent text-white font-mono outline-none">
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.activeTab === 'DADOS') {
                tabContent = `
                    <div class="p-4 fade-in h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-950 pb-2 border-b border-gray-800 z-10">
                            <h3 class="font-bold text-white uppercase tracking-wider text-xs">Hist√≥rico de Rolagens</h3>
                            <button onclick="clearHistory()" class="text-[10px] text-red-500 uppercase font-bold hover:text-red-400 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Limpar Log</button>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-2 text-sm pb-4">
                            ${char.history.length === 0 ? '<div class="text-center text-gray-600 italic py-10">Sem rolagens recentes.</div>' : ''}
                            ${char.history.slice().reverse().map(h => `
                                <div class="bg-gray-900/50 p-3 rounded-lg border-l-2 border-[${themeColor}] flex flex-col gap-1">
                                    <div class="flex justify-between text-[10px] text-gray-500">
                                        <span>${h.time}</span>
                                        <span class="uppercase font-bold tracking-wider text-gray-400">${h.label}</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-1">
                                        <div class="flex flex-col">
                                            <span class="text-xs text-gray-500">Resultado</span>
                                            <span class="text-2xl font-bold ${h.dice===20?'text-neon-yellow':h.dice===1?'text-neon-red':'text-white'} font-display">${h.total}</span>
                                        </div>
                                        <div class="text-right">
                                             <span class="text-xs text-gray-600 block">D20 + Mod</span>
                                             <span class="text-gray-300 font-mono text-sm">[${h.dice}] ${h.mod>=0?'+':''}${h.mod}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            else {
                tabContent = `<div class="flex flex-col items-center justify-center h-full text-gray-600 fade-in gap-4">
                    <i data-lucide="construction" size="48" class="opacity-20"></i>
                    <span class="text-xs uppercase tracking-widest">Em desenvolvimento</span>
                </div>`;
            }

            container.innerHTML = `
                <div class="flex flex-col h-full bg-gray-950">
                    <!-- HEADER -->
                    <div class="relative pt-8 pb-4 px-6 bg-gradient-to-b from-gray-900 to-transparent">
                        <button onclick="state.view='LIST'; render()" class="absolute top-4 left-4 text-gray-500 hover:text-white bg-black/30 p-2 rounded-full backdrop-blur-sm"><i data-lucide="arrow-left" size="20"></i></button>
                        
                        <div class="mt-4">
                            <h1 class="font-display font-black text-2xl text-white uppercase tracking-wider truncate drop-shadow-lg">${char.name}</h1>
                            <div class="flex items-center gap-3 mt-2">
                                <div class="h-2 flex-1 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                                    <div class="h-full bg-[${themeColor}] shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]" style="width: ${xpPct}%"></div>
                                </div>
                                <div class="flex flex-col items-end leading-none">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">N√≠vel</span>
                                    <span class="text-lg font-display font-bold text-white">${char.level}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VITALS -->
                    <div class="grid grid-cols-4 gap-1 px-2 py-2 border-t border-b border-gray-800 bg-[#0e0e14]">
                        ${renderVitalBlock('PV', char.vitals.hp, char.vitals.hpMax, 'text-neon-red')}
                        ${renderVitalBlock('AURA', char.vitals.aura, char.vitals.auraMax, `text-[${themeColor}]`)}
                        ${renderVitalBlock('SAN', char.vitals.san, char.vitals.sanMax, 'text-white')}
                        ${renderVitalBlock('CA', char.vitals.ca, null, 'text-white')}
                    </div>

                    <!-- TAB CONTENT AREA -->
                    <div class="flex-1 overflow-y-auto custom-scrollbar relative">
                        ${tabContent}
                    </div>

                    <!-- BOTTOM NAV -->
                    <div class="h-16 bg-[#0e0e14] border-t border-gray-800 flex items-center justify-around px-2 relative z-50">
                        ${renderNavItem('FICHA', 'user', themeColor)}
                        ${renderNavItem('NEN', 'flame', themeColor)}
                        ${renderNavItem('TRACOS', 'star', themeColor)}
                        ${renderNavItem('INV', 'backpack', themeColor)}
                        ${renderNavItem('DADOS', 'dices', themeColor)}
                    </div>
                </div>
            `;
        }

        // Helpers de renderiza√ß√£o
        function renderVitalBlock(label, val, max, colorClass) {
            return `
                <div class="flex flex-col items-center justify-center py-1">
                    <span class="text-[8px] font-bold text-gray-500 uppercase tracking-wider mb-1">${label}</span>
                    <div class="flex items-center gap-1 bg-gray-900/50 px-2 py-1 rounded border border-gray-800">
                        ${max ? `<button onclick="updateVital('${label.toLowerCase()}', -1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-left" size="10"></i></button>` : ''}
                        <span class="font-display font-bold text-sm ${colorClass} w-6 text-center">${val}</span>
                        ${max ? `<button onclick="updateVital('${label.toLowerCase()}', 1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-right" size="10"></i></button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderNavItem(id, icon, color) {
            const active = state.activeTab === id;
            return `
                <button onclick="setTab('${id}')" class="flex flex-col items-center justify-center w-full h-full gap-1 group relative">
                    ${active ? `<div class="absolute top-0 w-8 h-0.5 bg-[${color}] shadow-[0_0_10px_${color}]"></div>` : ''}
                    <i data-lucide="${icon}" size="${active ? 20 : 18}" class="${active ? `text-[${color}] drop-shadow-[0_0_5px_${color}]` : 'text-gray-600 group-hover:text-gray-400'} transition-all"></i>
                    <span class="text-[7px] font-bold tracking-widest ${active ? `text-[${color}]` : 'text-gray-600'}">${id}</span>
                </button>
            `;
        }

        // --- L√ìGICA DE A√á√ÉO (CONTROLLERS) ---

        // Character List Logic
        function selectChar(id) {
            state.currentChar = state.characters.find(c => c.id === id);
            state.view = 'SHEET';
            state.activeTab = 'FICHA';
            render();
        }

        // Creator Logic
        function startCreator() {
            state.creatorStep = 0;
            state.tempChar = null; // Reset
            state.view = 'CREATOR';
            render();
        }

        function setCreatorClass(cls) {
            state.tempChar.class = cls;
            render();
        }

        function updateCreatorAttr(attr, delta) {
            const val = state.tempChar.attributes[attr];
            if (val + delta >= 1 && val + delta <= 20) {
                state.tempChar.attributes[attr] += delta;
                render();
            }
        }

        function toggleCreatorSkill(skill) {
            const idx = state.tempChar.skills.indexOf(skill);
            if (idx >= 0) {
                state.tempChar.skills.splice(idx, 1);
            } else {
                if (state.tempChar.skills.length >= 3) {
                    alert("Voc√™ s√≥ pode escolher 3 per√≠cias iniciais.");
                    return;
                }
                state.tempChar.skills.push(skill);
            }
            render();
        }

        function nextCreatorStep() {
            if (state.creatorStep === 0 && !state.tempChar.name) {
                alert("D√™ um nome ao personagem!");
                return;
            }
            state.creatorStep++;
            render();
        }

        function finishCreator() {
            const newChar = {
                id: generateId(),
                name: state.tempChar.name,
                class: state.tempChar.class,
                race: state.tempChar.race,
                level: 0,
                xp: 0,
                xp_next: 50,
                money: 0,
                attributes: {},
                skills: state.tempChar.skills,
                vitals: {
                    hp: 10 + getMod(state.tempChar.attributes.CON), hpMax: 10 + getMod(state.tempChar.attributes.CON),
                    aura: 100, auraMax: 100,
                    san: 10 + getMod(state.tempChar.attributes.INT), sanMax: 10 + getMod(state.tempChar.attributes.INT),
                    ca: 10 + getMod(state.tempChar.attributes.CON)
                },
                inventory: [],
                history: []
            };

            // Map simple attributes to object structure
            Object.entries(state.tempChar.attributes).forEach(([k,v]) => {
                newChar.attributes[k] = { value: v, save: false };
            });

            saveCharacter(newChar);
            state.currentChar = newChar; // Load it immediately
            state.view = 'SHEET';
            state.activeTab = 'FICHA';
            render();
        }

        // Sheet Logic
        function setTab(tab) {
            state.activeTab = tab;
            render();
        }

        function updateSheetAttr(key, delta) {
            state.currentChar.attributes[key].value += delta;
            saveCharacter(state.currentChar);
            render();
        }

        function toggleSave(key) {
            state.currentChar.attributes[key].save = !state.currentChar.attributes[key].save;
            saveCharacter(state.currentChar);
            render();
        }

        function updateVital(type, delta) {
            const v = state.currentChar.vitals;
            if (type === 'pv') { v.hp += delta; } // Simplified, should respect max
            if (type === 'aura') { v.aura += delta; }
            if (type === 'san') { v.san += delta; }
            saveCharacter(state.currentChar);
            render();
        }

        function addItem() {
            const name = document.getElementById('new-item-name').value;
            if (name) {
                state.currentChar.inventory.push({ name, qty: 1 });
                saveCharacter(state.currentChar);
                render();
            }
        }

        function updateItemQty(idx, delta) {
            const item = state.currentChar.inventory[idx];
            item.qty += delta;
            if (item.qty <= 0) {
                state.currentChar.inventory.splice(idx, 1);
            }
            saveCharacter(state.currentChar);
            render();
        }

        function updateMoney(val) {
            state.currentChar.money = parseInt(val) || 0;
            saveCharacter(state.currentChar);
        }

        function rollDice(attrName, mod) {
            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + mod;
            const entry = {
                time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}),
                label: attrName,
                dice: d20,
                mod: mod,
                total: total
            };
            state.currentChar.history.push(entry);
            if (state.currentChar.history.length > 50) state.currentChar.history.shift();
            
            saveCharacter(state.currentChar);
            
            // Show result (simple alert for single file app, ideally a modal)
            alert(`üé≤ ${attrName}\n\n[${d20}] + ${mod} = ${total}`);
            
            // Go to dice tab to see history
            state.activeTab = 'DADOS';
            render();
        }

        function clearHistory() {
            if(confirm('Limpar hist√≥rico?')) {
                state.currentChar.history = [];
                saveCharacter(state.currentChar);
                render();
            }
        }

        // --- INICIALIZA√á√ÉO ---
        window.addEventListener('DOMContentLoaded', () => {
            loadCharacters();
            render();
        });

    </script>
</body>
</html>
