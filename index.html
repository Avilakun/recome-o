<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunter x Hunter RPG Sheet</title>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['Orbitron', 'sans-serif'],
              sans: ['Rajdhani', 'sans-serif'],
            },
            colors: {
              'neon-green': '#00ff9d',
              'neon-blue': '#00f0ff',
              'neon-red': '#ff0055',
              'neon-yellow': '#ffe600',
              'neon-theme': 'var(--theme-color-hex, #00ff9d)',
              'neon-dark': '#0a0a0f',
              'neon-card': '#0e0e14',
            }
          }
        }
      }
    </script>

    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color-hex: #00ff9d;
            --theme-rgb: 0, 255, 157;
        }

        body {
            background-color: #050505;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* App-like feel */
        }

        /* Utilitários de Scroll */
        .custom-scrollbar { overflow-y: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animações simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs limpos */
        input, select { background: transparent; outline: none; }
        
        /* Containers */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px; /* Mobile width constraint on desktop */
            margin: 0 auto;
            background-color: #0a0a0f;
            position: relative;
            border-left: 1px solid #1f2937;
            border-right: 1px solid #1f2937;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Nen Hexagon Styles */
        .nen-node {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .nen-node:active {
            transform: scale(0.95) !important;
        }
        
        /* Pool Animation */
        .pool-item-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 1000px; /* Arbitrary large number */
            opacity: 1;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- O conteúdo será injetado aqui via JavaScript -->
    </div>

    <!-- DB e Lógica -->
    <script>
        // --- DADOS DO SISTEMA ---
        const SYSTEM_DB = {
            classes: [
                { id: 'INTENSIFICAÇÃO', color: '#00ff9d', label: 'INTENSIFICAÇÃO', angle: 270, desc: 'Aura expressa maior poder, cura e resistência' }, 
                { id: 'TRANSFORMAÇÃO', color: '#d946ef', label: 'TRANSFORMAÇÃO', angle: 330, desc: 'Aura assume outra(s) propriedades(s)' },
                { id: 'MATERIALIZAÇÃO', color: '#ff0055', label: 'MATERIALIZAÇÃO', angle: 30, desc: 'Aura cria e altera matéria física' },
                { id: 'ESPECIALIZAÇÃO', color: '#00f0ff', label: 'ESPECIALIZAÇÃO', angle: 90, desc: 'Aura se apresenta de maneira inovadora' },
                { id: 'MANIPULAÇÃO', color: '#9ca3af', label: 'MANIPULAÇÃO', angle: 150, desc: 'Aura manipula objetos, matéria ou seres vivos' },
                { id: 'EMISSÃO', color: '#ffe600', label: 'EMISSÃO', angle: 210, desc: 'Aura se mantém forte fora do corpo e em longas distâncias' }
            ],
            xpTable: [50, 150, 350, 500, 800, 1000, 1500, 2500, 3200, 4000, 5000, 6500],
            racas: [
                // Humanos e Tribos
                {
                    nome: "Humano Comum",
                    descricao: "Raça mais comum no mundo, com variações de aparências e características físicas.",
                    aumento_atributo: { "FOR": 1, "DES": 1, "CON": 1, "INT": 1, "SAB": 1, "CAR": 1 },
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Fanalis",
                    descricao: "Composição física descomunal e cabelos vermelhos.",
                    aumento_atributo: { "FOR": 4, "CON": 2, "DES": -2, "INT": -2, "SAB": -2, "CAR": -2 },
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Gyudondond",
                    descricao: "Conhecidos como 'Homens Flauta'.",
                    aumento_atributo: "Distribua 3 pontos em qualquer atributo",
                    caracteristicas: [
                        { nome: "Alarido de Guerra", efeito: "Pode utilizar Intimidação como ação de movimento ao performar uma dança." }
                    ],
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Imuchack",
                    descricao: "Guerreiros de até 4 metros que vivem em áreas gélidas.",
                    aumento_atributo: { "FOR": 2, "CON": 1, "INT": -2 },
                    opcoes_caracteristica: [
                        { nome: "Imunidade ao Frio", efeito: "Imune a baixas temperaturas e dano de gelo/frio." },
                        { nome: "Caça Aquática", efeito: "Sem penalidade de movimento para nadar; prende respiração por mais tempo." }
                    ],
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                // Clãs Especiais
                {
                    nome: "Kurta",
                    descricao: "Aldeões conhecidos pelos Olhos Escarlates.",
                    aumento_atributo: { "INT_ou_SAB": 2 },
                    caracteristicas: [
                        { nome: "Mudança Escarlate", efeito: "+1 em todos os atributos enquanto os olhos estiverem vermelhos." },
                        { nome: "Caça Fascinante", efeito: "Pode ser procurado e caçado caso descubram sua origem." },
                        { nome: "Sofrimento Profundo", efeito: "Gatilhos emocionais ativam os olhos." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Clãs Especiais"
                },
                // Formigas Quimera
                {
                    nome: "Formiga Quimera",
                    descricao: "Iniciam sem Antecedentes. Não recebem aumento de atributo direto.",
                    aumento_atributo: "Nenhum (Ver Regra Especial)",
                    hierarquia_config: [
                        "Peões/Soldados: 1 slot traço",
                        "Oficiais: 2 slots traços",
                        "Líderes de Esquadrão: 3 slots traços",
                        "Guardas Reais: 5 slots traços"
                    ],
                    caracteristicas: [
                            { nome: "Arma natural", efeito: "Bico, Cauda, Chifres, Garras, Ferrão ou Tentáculos." },
                            { nome: "Corpo Adaptável", efeito: "Mudança corporal ou resistência a impacto." },
                            { nome: "Criatura de Cerco", efeito: "Dano crítico em construções e Constructos." },
                            { nome: "Destreza animal", efeito: "Vantagem em TR de Destreza." },
                            { nome: "Escudo Natural", efeito: "Resistência a dano cortante, perfurante e/ou impacto." },
                            { nome: "Evasão", efeito: "+2 na Reação de Esquiva." },
                            { nome: "Investida", efeito: "Aumenta dano ou aplica condição com base no deslocamento." },
                            { nome: "Rasante", efeito: "Ataque aéreo sem provocar AdO." },
                            { nome: "Regeneração", efeito: "Recuperação gradual de vida." },
                            { nome: "Telepatia", efeito: "Comunicação entre espécies." },
                            { nome: "Veneno/Peçonha", efeito: "Aplicação de veneno no contato." }
                    ],
                    fonte: "[1, 2]",
                    categoria: "Formigas Quimera"
                },
                // Modificados e Fantasia
                {
                    nome: "Wormorfos",
                    descricao: "Humanos modificados geneticamente ('povo verme').",
                    aumento_atributo: "Não recebem aumento",
                    caracteristicas: [
                        { nome: "Visão", efeito: "Ecolocalização de 3m; não depende de visão/audição no solo." },
                        { nome: "Corpo Malemolente", efeito: "Resistência a dano de impacto/concussão." },
                        { nome: "Enterrada", efeito: "Agarre contra CA; ação bônus para submergir." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Elfos e Meio-Elfos",
                    descricao: "Seres com herança feérica.",
                    aumento_atributo: "Escolha +2 em DES, SAB, INT ou CAR",
                    caracteristicas: [
                        { nome: "Ancestral Feérico", efeito: "Vantagem contra intimidação e persuasão." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Meio-Orcs",
                    descricao: "Guerreiros robustos com ancestralidade orc.",
                    aumento_atributo: { "FOR": 1, "CON": 1 },
                    caracteristicas: [
                        { nome: "Resistência Implacável", efeito: "Se reduzido a 0 HP, volta para 1 HP (Proficiência/dia)." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Anões",
                    descricao: "Seres robustos habitantes das montanhas.",
                    aumento_atributo: { "CON": 2 },
                    caracteristicas: [
                        { nome: "Resiliência Anã", efeito: "Vantagem contra venenos e resistência a dano de veneno." }
                    ],
                    fonte: "[7]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Draconatos",
                    descricao: "Humanoides com herança de dragões.",
                    aumento_atributo: "Escolha +2 em FOR, DES ou CAR",
                    caracteristicas: [
                        { nome: "Arma de Sopro", efeito: "2d6 dano (escala no nv 6 e 11).", tabela_ancestral: "Tipo de dragão define elemento" }
                    ],
                    fonte: "[7]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Halflings (Pequeninos)",
                    descricao: "Pequenos e ágeis, conhecidos pela sorte.",
                    aumento_atributo: { "DES": 1, "INT": 2 },
                    opcoes_caracteristica: [
                        { nome: "Sortudo", efeito: "Rerolar 1 natural em ataques/testes." },
                        { nome: "Bravura", efeito: "Vantagem contra medo/intimidação." },
                        { nome: "Agilidade Halfling", efeito: "Mover-se pelo espaço de criaturas maiores." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Gnomos",
                    descricao: "Pequenos inventores e ilusionistas.",
                    aumento_atributo: "Escolha +2 em DES ou INT",
                    caracteristicas: [
                        { nome: "Esperteza Gnômica", efeito: "Vantagem em INT, SAB e CAR contra magia." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Golias",
                    descricao: "Gigantes das montanhas com pele de pedra.",
                    aumento_atributo: "Escolha +2 em FOR ou CON",
                    caracteristicas: [
                        { nome: "Resistência de Pedra", efeito: "Reação para reduzir dano físico pela metade." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                // Tecnológicos e Sobrenaturais
                {
                    nome: "Neans (Andróides)",
                    descricao: "Constructos quase indistinguíveis de humanos.",
                    aumento_atributo: "Varia (Atualização de Disco)",
                    caracteristicas: [
                        { nome: "Atualização de Disco Rígido", efeito: "Altera todos os pontos de atributo no início de cada dia." },
                        { nome: "Curto Circuito", efeito: "Dano elétrico causa curto; sem exaustão biológica." }
                    ],
                    fonte: "[8, 9]",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                {
                    nome: "Vampiros",
                    descricao: "Seres noturnos que se alimentam de aura e sangue.",
                    aumento_atributo: { "INT": 2, "Físico": 1 },
                    caracteristicas: [
                        { nome: "Sugar Aura", efeito: "Ação Bônus, Mordida, Rouba 10% da aura." },
                        { nome: "Exposição Solar", efeito: "-CA quando exposto ao sol." }
                    ],
                    fonte: "[8, 9]",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                {
                    nome: "Djins",
                    descricao: "Criaturas de Nen Post-Mortem.",
                    aumento_atributo: "Escolha +2 em SAB ou CAR",
                    caracteristicas: [
                        { nome: "Interpretação Travessa", efeito: "Rolar dado aleatório com Restrições para ignorar sorte (1x/dia)." }
                    ],
                    fonte: "Extra",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                // Raças Incomuns
                {
                    nome: "Bugbears",
                    descricao: "Humanoides peludos e brutais.",
                    aumento_atributo: { "FOR": 2, "DES": 1 },
                    caracteristicas: [
                        { nome: "Ataque Surpresa", efeito: "+2d6 de dano no primeiro ataque contra alvo surpreso." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Dahllans (Meio-Dríades)",
                    descricao: "Seres ligados à natureza com pele de casca.",
                    aumento_atributo: { "SAB": 4, "INT": -1, "CAR": -1 },
                    caracteristicas: [
                        { nome: "Herança Natural", efeito: "Visão na penumbra 18m." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Firbolgs",
                    descricao: "Guardiões da natureza gentis e gigantes.",
                    aumento_atributo: { "SAB": 2, "FOR": 1 },
                    caracteristicas: [
                        { nome: "Passo Oculto", efeito: "Ação bônus para ficar invisível até o próximo turno." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Goblins",
                    descricao: "Pequenos, maliciosos e adaptáveis.",
                    aumento_atributo: "Escolha +2 em FOR, DES ou CAR",
                    caracteristicas: [
                        { nome: "Fúria do Pequeno Nanico", efeito: "Bônus de dano contra alvos maiores (1x/descanso)." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                }
            ],
            skills: [
                'TR de FOR', 'TR de DES', 'TR de CON', 'TR de INT', 'TR de SAB', 'TR de CAR',
                'Acrobacia', 'Arcanismo', 'Atletismo', 'Atuação', 'Enganação',
                'Furtividade', 'História', 'Intimidação', 'Intuição', 'Investigação',
                'Lidar com Animais', 'Medicina', 'Natureza', 'Percepção', 'Persuasão',
                'Prestidigitação', 'Religião', 'Sobrevivência'
            ],
            otherSkills: [
                'Etiqueta', 'Pilotagem', 'Tecnologia', 'Ocultismo', 'Falsificação', 'Jogos', 'Instrumentos'
            ],
            pointBuyCosts: {
                30: 50, 29: 47, 28: 44, 27: 41, 26: 38, 25: 35, 24: 32, 23: 29, 22: 26, 21: 23,
                20: 20, 19: 17, 18: 14, 17: 11, 16: 8, 15: 6, 14: 4, 13: 3, 12: 2, 11: 1,
                10: 0, 9: -1, 8: -2, 7: -4, 6: -6, 5: -8, 4: -11, 3: -14, 2: -17, 1: -20
            }
        };

        // --- ESTADO GLOBAL ---
        const state = {
            view: 'LIST', // LIST, CREATOR, SHEET
            activeTab: 'FICHA',
            characters: [],
            currentChar: null,
            creatorStep: 0,
            tempChar: null, // Usado no criador
            attrTab: 'ROLAGEM',
            attrMethodLocked: false,
            attrPool: [], 
            selectedPoolIdx: null,
            openSkillAccordion: 'MAIN'
        };

        // --- GERENCIAMENTO DE STORAGE ---
        function loadCharacters() {
            const chars = [];
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('hxhrpg_')) {
                    try { chars.push(JSON.parse(localStorage.getItem(key))); } catch(e) {}
                }
            }
            state.characters = chars.sort((a,b) => new Date(b.lastMod) - new Date(a.lastMod));
        }

        function saveCharacter(char) {
            char.lastMod = new Date().toISOString();
            localStorage.setItem('hxhrpg_' + char.id, JSON.stringify(char));
            loadCharacters();
        }

        function deleteCharacter(id) {
            if(confirm('Tem certeza que deseja apagar esta ficha?')) {
                localStorage.removeItem('hxhrpg_' + id);
                loadCharacters();
                if (state.currentChar && state.currentChar.id === id) {
                    state.view = 'LIST';
                    state.currentChar = null;
                }
                render();
            }
        }

        // --- UTILITÁRIOS ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function getMod(val) { return val ? Math.floor((val - 10) / 2) : 0; }
        function getModStr(val) { const m = getMod(val); return m >= 0 ? `+${m}` : `${m}`; }
        function getPointBuyCost(val) { return SYSTEM_DB.pointBuyCosts[val] !== undefined ? SYSTEM_DB.pointBuyCosts[val] : 0; }
        
        function calculateTotalCost(attrs) {
            let total = 0;
            Object.values(attrs).forEach(val => { total += getPointBuyCost(val); });
            return total;
        }

        function setThemeColor(hex) {
            document.documentElement.style.setProperty('--theme-color-hex', hex);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if(result) {
                const r = parseInt(result[1], 16);
                const g = parseInt(result[2], 16);
                const b = parseInt(result[3], 16);
                document.documentElement.style.setProperty('--theme-rgb', `${r}, ${g}, ${b}`);
            }
        }

        function getNenPercentages(selectedId) {
            const types = ['INTENSIFICAÇÃO', 'TRANSFORMAÇÃO', 'MATERIALIZAÇÃO', 'ESPECIALIZAÇÃO', 'MANIPULAÇÃO', 'EMISSÃO'];
            const selectedIndex = types.indexOf(selectedId);
            const matrix = {};
            types.forEach((type, index) => {
                let diff = Math.abs(index - selectedIndex);
                if (diff > 3) diff = 6 - diff;
                let pct = 0;
                if (diff === 0) pct = 100; else if (diff === 1) pct = 80; else if (diff === 2) pct = 60; else if (diff === 3) pct = 40;
                if (type === 'ESPECIALIZAÇÃO' && diff !== 0) {
                    pct = 0;
                    if (selectedId === 'MATERIALIZAÇÃO' || selectedId === 'MANIPULAÇÃO') pct = 1;
                }
                matrix[type] = pct;
            });
            return matrix;
        }

        // --- RENDERIZADORES ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.view === 'LIST') renderList(app);
            else if (state.view === 'CREATOR') renderCreator(app);
            else if (state.view === 'SHEET') renderSheet(app);
            if (window.lucide) lucide.createIcons();
        }

        function renderList(container) {
            setThemeColor('#00ff9d');
            const level0 = state.characters.filter(c => c.level === 0);
            const levelHigh = state.characters.filter(c => c.level > 0);
            let html = `
                <div class="p-6 flex flex-col h-full fade-in">
                    <div class="text-center mb-8 mt-4">
                        <h1 class="font-display font-black text-3xl tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">HxH 5e RPG</h1>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Banco de Dados</p>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar space-y-8 pb-20">
            `;
            html += `<div><div class="flex items-center gap-2 mb-3"><i data-lucide="circle-dashed" class="text-gray-500 w-4 h-4"></i><h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Iniciantes (Nível 0)</h2></div>`;
            if (level0.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhuma ficha de nível 0 encontrada.</div>`;
            else {
                level0.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-gray-600 transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')"><div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="user" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">${char.race} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div><div><div class="flex items-center gap-2 mb-3"><i data-lucide="zap" class="text-neon-green w-4 h-4"></i><h2 class="text-xs font-bold text-neon-green uppercase tracking-widest">Usuários de Nen (Nível 1-12)</h2></div>`;
            if (levelHigh.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhum Hunter registrado.</div>`;
            else {
                levelHigh.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-[${color}] transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')" style="border-left: 3px solid ${color}"><div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="shield" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">LVL ${char.level} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div></div><div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent max-w-[480px] mx-auto"><button onclick="startCreator()" class="w-full py-4 bg-neon-green text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 shadow-[0_0_20px_rgba(0,255,157,0.4)] transition-all flex items-center justify-center gap-2"><i data-lucide="plus"></i> CRIAR NOVA FICHA</button></div></div>`;
            container.innerHTML = html;
        }

        function renderCreator(container) {
            if (!state.tempChar) {
                state.tempChar = { name: '', class: 'INTENSIFICAÇÃO', race: 'Humano Comum', attributes: { FOR:10, DES:10, CON:10, INT:10, SAB:10, CAR:10 }, skills: [], otherSkills: [], raceTraits: [] };
            }
            if (!state.tempChar.raceTraits) state.tempChar.raceTraits = [];
            const step = state.creatorStep;
            let contentHtml = '';
            let title = '';

            if (step === 0) {
                title = 'IDENTIDADE';
                const percentages = getNenPercentages(state.tempChar.class);
                const currentClass = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class);
                const hexNodes = SYSTEM_DB.classes.map(c => {
                    const isSelected = state.tempChar.class === c.id;
                    const pct = percentages[c.id];
                    const rad = (c.angle * Math.PI) / 180;
                    const radius = 35; 
                    const left = 50 + (radius * Math.cos(rad));
                    const top = 50 + (radius * Math.sin(rad));
                    const nodeStyle = isSelected ? `background-color: ${c.color}; border-color: ${c.color}; color: #000; box-shadow: 0 0 20px ${c.color}80;` : `background-color: #0a0a0f; border-color: ${c.color}; color: ${c.color};`;
                    const transformScale = isSelected ? 'scale(1.15)' : 'scale(1.0)';
                    const zIndex = isSelected ? 'z-10' : 'z-0';
                    return `<div class="absolute w-20 h-20 flex items-center justify-center cursor-pointer nen-node ${zIndex}" style="top: ${top}%; left: ${left}%; transform: translate(-50%, -50%) ${transformScale};" onclick="selectNenType('${c.id}')"><div class="w-14 h-14 rounded-full border-2 flex items-center justify-center transition-all duration-300 relative shadow-lg" style="${nodeStyle}"><span class="font-display font-bold text-lg leading-none">${pct}%</span></div></div>`;
                }).join('');
                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="relative"><label class="text-[10px] font-bold text-neon-theme uppercase tracking-widest mb-2 block pl-2">Nome do Candidato</label><input type="text" id="creator-name" value="${state.tempChar.name}" placeholder="INSIRA SEU NOME..." class="w-full bg-gray-900 border border-gray-700 rounded-xl p-4 text-white text-center font-display font-bold tracking-wider focus:border-neon-theme focus:shadow-[0_0_15px_rgba(var(--theme-rgb),0.2)] transition-all uppercase placeholder-gray-600" oninput="state.tempChar.name = this.value"></div><div class="text-center transition-all"><h3 class="text-3xl font-display font-black tracking-widest uppercase drop-shadow-[0_0_15px_rgba(var(--theme-rgb),0.6)]" style="color: ${currentClass.color}; text-shadow: 0 0 10px ${currentClass.color}40;">${state.tempChar.class}</h3></div><div class="bg-gray-900/20 rounded-full border border-gray-800/50 p-4 aspect-square relative max-w-[360px] mx-auto"><svg class="absolute inset-0 w-full h-full pointer-events-none opacity-30" viewBox="0 0 100 100"><polygon points="50,15 80.3,32.5 80.3,67.5 50,85 19.7,67.5 19.7,32.5" fill="none" stroke="currentColor" stroke-width="0.8" class="text-white" /><line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="32.5" x2="19.7" y2="67.5" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="67.5" x2="19.7" y2="32.5" stroke="currentColor" stroke-width="0.5" class="text-white" /></svg>${hexNodes}</div><div class="text-center px-4 bg-gray-900/50 p-3 rounded-xl border border-gray-800/50"><p class="text-sm font-medium text-gray-300 italic">"${currentClass.desc}"</p></div></div>`;
            }
            else if (step === 1) {
                title = 'RAÇA';
                contentHtml = `<div class="space-y-4 animate-in slide-in-from-right duration-300">`;
                let lastCat = '';
                SYSTEM_DB.racas.forEach(r => {
                    if (r.categoria && r.categoria !== lastCat) {
                        contentHtml += `<div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-4 mb-2 pl-2">${r.categoria}</div>`;
                        lastCat = r.categoria;
                    }
                    const isSelected = state.tempChar.race === r.nome;
                    const borderColor = isSelected ? 'border-neon-theme ring-2 ring-neon-theme/20' : 'border-gray-800';
                    const bgColor = isSelected ? 'bg-neon-theme/5' : 'bg-gray-900';
                    const textColor = isSelected ? 'text-neon-theme' : 'text-white';
                    
                    let attrHtml = typeof r.aumento_atributo === 'object' ? Object.entries(r.aumento_atributo).map(([k,v]) => `<span class="bg-gray-900 border border-gray-700 rounded-full px-3 py-1 text-[10px] font-bold text-gray-300 shadow-sm flex items-center gap-1">${k.replace(/_/g, ' ')} <span class="${v>0?'text-neon-theme':'text-red-500'}">${v>0?'+':''}${v}</span></span>`).join('') : `<span class="text-xs text-gray-400 italic">${r.aumento_atributo}</span>`;
                    
                    let featuresHtml = '';
                    if (r.nome === 'Formiga Quimera') {
                         const selectedCount = (state.tempChar.raceTraits || []).length;
                         const maxTraits = 3;
                         featuresHtml = `<div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2 flex justify-between">Características da Espécie <span id="trait-counter" class="${selectedCount >= maxTraits ? 'text-neon-theme' : 'text-gray-500'}">(${selectedCount}/${maxTraits})</span></h4><div class="bg-gray-950/50 rounded-lg p-2 border border-gray-800/50 grid grid-cols-1 gap-2">${r.caracteristicas.map(f => {
                                const isTraitSelected = (state.tempChar.raceTraits || []).includes(f.nome);
                                return `<div id="trait-btn-${f.nome.replace(/\s/g,'-')}" onclick="event.stopPropagation(); toggleRaceTrait('${f.nome}')" class="p-2 rounded border cursor-pointer transition-all flex items-start gap-2 ${isTraitSelected ? 'bg-neon-theme/10 border-neon-theme text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}"><div class="mt-0.5 pointer-events-none">${isTraitSelected ? '<i data-lucide="check-square" size="14"></i>' : '<i data-lucide="square" size="14"></i>'}</div><div class="pointer-events-none"><span class="text-[10px] font-bold block">${f.nome}</span><span class="text-[9px] block leading-tight opacity-70">${f.efeito || f.mecanica || ''}</span></div></div>`;
                            }).join('')}</div></div>`;
                    } else {
                        const features = [...(r.caracteristicas || []), ...(r.opcoes_caracteristica || [])];
                        if (features.length > 0) featuresHtml = `<div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2">Características</h4><div class="bg-gray-950/50 rounded-lg p-3 border border-gray-800/50">${features.map(f => `<div class="mb-2 last:mb-0"><span class="text-[11px] font-bold text-gray-300 block">${f.nome}</span><span class="text-[10px] text-gray-500 block leading-tight">${f.efeito || f.mecanica || ''} ${f.tabela_ancestral ? '('+f.tabela_ancestral+')' : ''}</span></div>`).join('')}</div></div>`;
                    }
                    
                    const checkIcon = `<span id="check-${r.nome.replace(/\s/g,'-')}" class="transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'} flex items-center"><i data-lucide="check" size="16"></i></span>`;
                    const chevronClass = isSelected ? 'rotate-0' : '-rotate-90';

                    contentHtml += `
                    <div id="race-card-${r.nome.replace(/\s/g,'-')}" onclick="selectRace('${r.nome}')" class="w-full text-left rounded-2xl border ${borderColor} ${bgColor} transition-all duration-300 cursor-pointer group relative overflow-hidden mb-2">
                        <div class="p-4 flex items-start justify-between">
                            <div><h3 class="font-display font-bold text-lg uppercase tracking-wider ${textColor} flex items-center gap-2">${r.nome} ${checkIcon}</h3><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1 pr-6 leading-tight">${r.descricao}</p></div>
                            <div id="chevron-${r.nome.replace(/\s/g,'-')}" class="transition-transform duration-300 ${chevronClass} ${isSelected ? 'text-neon-theme' : 'text-gray-600'}"><i data-lucide="chevron-down" size="20"></i></div>
                        </div>
                        <div id="race-content-${r.nome.replace(/\s/g,'-')}" class="accordion-content px-4 ${isSelected ? 'open pb-4' : ''}"><div class="h-px w-full bg-gray-800 mb-4"></div><div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2">Bônus de Atributo</h4><div class="flex flex-wrap gap-2">${attrHtml}</div></div>${featuresHtml}<div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500"><div class="col-span-2 text-right italic text-gray-600">Fonte: ${r.fonte}</div></div></div>
                    </div>`;
                });
                contentHtml += `</div>`;
            }
            else if (step === 2) {
                title = 'ATRIBUTOS';
                const totalCost = calculateTotalCost(state.tempChar.attributes);
                const maxCost = 20;

                const tabBtn = (id, label, icon) => {
                    const isActive = state.attrTab === id;
                    const isLocked = state.attrMethodLocked && !isActive;
                    let baseClasses = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest border rounded-lg transition-all flex items-center justify-center gap-2";
                    let stateClasses = isActive ? "bg-neon-theme/20 border-neon-theme text-neon-theme shadow-[0_0_10px_rgba(var(--theme-rgb),0.2)]" : (isLocked ? "bg-gray-900 border-gray-800 text-gray-600 opacity-50 cursor-not-allowed" : "bg-gray-900 border-gray-800 text-gray-500 hover:text-gray-300 cursor-pointer");
                    return `<button onclick="${isLocked ? '' : `setAttrTab('${id}')`}" class="${baseClasses} ${stateClasses}">${isLocked ? '<i data-lucide="lock" size="14"></i>' : `<i data-lucide="${icon}" size="14"></i>`} ${label}</button>`;
                };

                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="bg-[#2a0e14] border border-neon-red/30 p-4 rounded-xl text-center relative overflow-hidden shadow-[0_0_15px_rgba(255,0,85,0.1)]"><p class="text-[10px] text-neon-red font-bold uppercase tracking-widest flex items-center justify-center gap-2 relative z-10"><i data-lucide="alert-triangle" size="14"></i> Atenção: Apenas um modo pode ser escolhido. Ao iniciar, os outros serão bloqueados.</p></div><div class="flex gap-2 p-1 bg-gray-900 rounded-xl border border-gray-800">${tabBtn('ROLAGEM', 'Rolagem', 'dices')}${tabBtn('ARRAY', 'Array', 'list')}${tabBtn('COMPRA', 'Compra', 'coins')}</div>`;

                if (state.attrTab === 'ROLAGEM' || state.attrTab === 'ARRAY') {
                    contentHtml += `<div class="space-y-4">${!state.attrMethodLocked ? (state.attrTab === 'ROLAGEM' ? `<button onclick="rollAllStats()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl font-display font-bold text-white tracking-widest hover:brightness-110 active:scale-95 transition-all shadow-lg flex items-center justify-center gap-2 border border-white/10"><i data-lucide="dices"></i> ROLAR ATRIBUTOS</button>` : `<button onclick="applyStandardArray()" class="w-full py-4 bg-neon-blue/10 text-neon-blue border border-neon-blue/50 rounded-xl font-display font-bold tracking-widest hover:bg-neon-blue hover:text-black active:scale-95 transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(0,240,255,0.2)]"><i data-lucide="list"></i> USAR ARRAY PADRÃO</button>`) : ''}${state.attrMethodLocked ? `<div class="bg-gray-900/50 border border-gray-700 rounded-xl p-4"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 text-center">Banco de Atributos</p>${state.attrPool.length === 0 ? '<div class="text-center text-xs text-gray-600 py-2 italic">Todos os valores alocados.</div>' : `<div class="flex flex-wrap gap-2 justify-center">${state.attrPool.map((val, idx) => `<button onclick="selectPoolItem(${idx})" class="w-10 h-10 rounded-lg font-display font-bold text-lg flex items-center justify-center transition-all pool-item-enter ${state.selectedPoolIdx === idx ? 'bg-neon-theme text-black shadow-[0_0_10px_var(--theme-color-hex)] scale-110' : 'bg-gray-800 text-white hover:bg-gray-700'}">${val}</button>`).join('')}</div>`}<p class="text-[9px] text-gray-500 text-center mt-3">${state.selectedPoolIdx !== null ? 'Selecione um atributo abaixo para aplicar.' : 'Clique em um número para selecionar.'}</p></div>` : ''}</div>`;
                } else if (state.attrTab === 'COMPRA') {
                     contentHtml += `<div id="buy-container" class="bg-gray-900 border border-gray-800 p-4 rounded-xl relative overflow-hidden"><div class="flex justify-between items-center relative z-10"><span class="text-xs text-gray-400 uppercase font-bold tracking-widest">Pontos Gastos</span><div class="flex items-center gap-1"><span id="buy-total" class="font-display font-bold text-2xl ${totalCost > maxCost ? 'text-red-500' : 'text-white'} transition-all">${totalCost}</span><span class="font-display text-gray-600 text-lg">/ ${maxCost}</span></div></div><div class="absolute bottom-0 left-0 h-1 bg-gray-800 w-full"><div id="buy-bar" class="h-full ${totalCost > maxCost ? 'bg-red-500' : 'bg-neon-theme'} transition-all duration-300" style="width: ${Math.min(100, (totalCost/maxCost)*100)}%"></div></div></div>`;
                }

                contentHtml += `<div class="grid grid-cols-2 gap-3">${Object.keys(state.tempChar.attributes).map(attr => {
                    const val = state.tempChar.attributes[attr];
                    const isPoolMode = state.attrTab !== 'COMPRA';
                    return `<div class="bg-gray-900 rounded-xl p-3 border transition-all relative overflow-hidden group ${state.selectedPoolIdx !== null && isPoolMode ? 'border-neon-theme/50 cursor-pointer hover:border-neon-theme' : 'border-gray-800'} ${val === null && isPoolMode ? 'border-dashed' : ''}" onclick="${isPoolMode ? (val === null ? `assignToSlot('${attr}')` : `returnToPool('${attr}')`) : ''}"><div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${attr}</span>${val !== null ? `<span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 rounded border border-gray-700">Mod ${getModStr(val)}</span>` : ''}</div>${state.attrTab === 'COMPRA' ? `<div class="flex items-center justify-between"><button onclick="buyStat('${attr}', -1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="minus" size="14"></i></button><span id="attr-val-${attr}" class="text-xl font-display font-bold text-white transition-all">${val}</span><button onclick="buyStat('${attr}', 1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="plus" size="14"></i></button></div><div class="text-center mt-1"><span class="text-[8px] text-gray-600">Custo: ${getPointBuyCost(val)}</span></div>` : `<div class="text-center py-1 h-10 flex items-center justify-center">${val !== null ? `<span class="text-3xl font-display font-bold text-white transition-colors pool-item-enter">${val}</span>` : `<span class="text-[10px] text-gray-700 uppercase font-bold tracking-widest">Vazio</span>`}</div>${isPoolMode && val !== null ? '<div class="absolute inset-0 bg-red-500/10 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"><i data-lucide="x" class="text-red-500"></i></div>' : ''}`}</div>`;
                }).join('')}</div></div>`;
            }
            else if (step === 3) {
                title = 'TREINAMENTOS';
                window.toggleAccordion = (section) => { state.openSkillAccordion = state.openSkillAccordion === section ? null : section; render(); };
                const mainCount = state.tempChar.skills.length;
                const otherCount = state.tempChar.otherSkills.length;
                const maxMain = 5, maxOther = 4;
                const renderAccordionHeader = (id, label, count, max, isOpen) => {
                    const isFull = count >= max;
                    return `<div onclick="toggleAccordion('${id}')" class="flex items-center justify-between p-4 bg-gray-900 border ${isOpen ? 'border-neon-theme/50' : 'border-gray-800'} rounded-xl cursor-pointer hover:bg-gray-800 transition-all mb-2"><div class="flex items-center gap-3"><div class="bg-gray-800 p-2 rounded text-gray-400"><i data-lucide="${id === 'MAIN' ? 'shield' : 'sparkles'}" size="16"></i></div><div><h3 class="font-bold text-sm text-white uppercase tracking-wide">${label}</h3><p class="text-[10px] text-gray-500 font-bold tracking-wider">Selecionado: <span id="skill-count-${id}" class="${isFull ? 'text-neon-theme' : 'text-gray-300'}">${count}</span> / ${max}</p></div></div><div class="${isOpen ? 'text-neon-theme rotate-180' : 'text-gray-600'} transition-transform duration-300"><i data-lucide="chevron-down" size="20"></i></div></div>`;
                };
                contentHtml = `<div class="space-y-2 animate-in slide-in-from-right duration-300">${renderAccordionHeader('MAIN', 'Perícias e Testes de Resistência', mainCount, maxMain, state.openSkillAccordion === 'MAIN')}${state.openSkillAccordion === 'MAIN' ? `<div class="pl-2 pr-2 pb-4 pt-1 animate-in fade-in slide-in-from-top-1 duration-200"><div class="grid grid-cols-1 gap-2">${SYSTEM_DB.skills.map(skill => {
                    const isSelected = state.tempChar.skills.includes(skill);
                    return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="toggleCreatorSkill('${skill}', 'main')" class="flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${isSelected ? 'bg-neon-theme/10 border-neon-theme text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}"><span class="text-sm font-medium pointer-events-none">${skill}</span><div class="pointer-events-none">${isSelected ? '<i data-lucide="check-circle" size="16" class="text-neon-theme"></i>' : '<i data-lucide="circle" size="16"></i>'}</div></div>`;
                }).join('')}</div></div>` : ''}${renderAccordionHeader('OTHER', 'Outras Perícias', otherCount, maxOther, state.openSkillAccordion === 'OTHER')}${state.openSkillAccordion === 'OTHER' ? `<div class="pl-2 pr-2 pb-4 pt-1 animate-in fade-in slide-in-from-top-1 duration-200"><div class="grid grid-cols-1 gap-2">${SYSTEM_DB.otherSkills.map(skill => {
                    const isSelected = state.tempChar.otherSkills.includes(skill);
                    return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="toggleCreatorSkill('${skill}', 'other')" class="flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${isSelected ? 'bg-neon-blue/10 border-neon-blue text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}"><span class="text-sm font-medium pointer-events-none">${skill}</span><div class="pointer-events-none">${isSelected ? '<i data-lucide="check-circle" size="16" class="text-neon-blue"></i>' : '<i data-lucide="circle" size="16"></i>'}</div></div>`;
                }).join('')}</div></div>` : ''}</div>`;
            }
            else if (step === 4) {
                title = 'REVISÃO';
                const color = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class).color;
                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="text-center"><h2 class="text-3xl font-display font-bold text-white mb-1">${state.tempChar.name || 'Sem Nome'}</h2><span class="bg-[${color}]/20 text-[${color}] px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest border border-[${color}]/30">${state.tempChar.class}</span></div><div class="bg-gray-900 rounded-xl p-4 border border-gray-800 space-y-4"><div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-xs text-gray-500 uppercase">Raça</span><span class="text-sm font-bold text-white">${state.tempChar.race}</span></div>${state.tempChar.raceTraits && state.tempChar.raceTraits.length > 0 ? `<div><span class="text-xs text-gray-500 uppercase block mb-2">Traços Raciais Selecionados</span><div class="flex flex-wrap gap-1">${state.tempChar.raceTraits.map(t => `<span class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">${t}</span>`).join('')}</div></div>` : ''}<div><span class="text-xs text-gray-500 uppercase block mb-2">Atributos</span><div class="grid grid-cols-6 gap-1 text-center">${Object.entries(state.tempChar.attributes).map(([k,v]) => `<div class="bg-black rounded p-1"><div class="text-[8px] text-gray-500">${k}</div><div class="text-xs font-bold text-white">${v}</div></div>`).join('')}</div></div><div><span class="text-xs text-gray-500 uppercase block mb-2">Treinamentos</span><div class="flex flex-wrap gap-1 mb-2">${state.tempChar.skills.length > 0 ? state.tempChar.skills.map(s => `<span class="text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento principal</span>'}</div><div class="flex flex-wrap gap-1">${state.tempChar.otherSkills.length > 0 ? state.tempChar.otherSkills.map(s => `<span class="text-[10px] bg-gray-800 text-neon-blue/70 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento extra</span>'}</div></div></div><div class="p-4 bg-neon-theme/5 border border-neon-theme/20 rounded-xl text-center"><p class="text-xs text-neon-theme">Pronto para iniciar sua jornada Hunter?</p></div></div>`;
            }

            container.innerHTML = `<div class="flex flex-col h-full bg-gray-950 fade-in"><div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50"><button onclick="state.view='LIST'; render()" class="text-gray-500 hover:text-white flex items-center gap-1 text-[10px] uppercase font-bold"><i data-lucide="chevron-left" size="14"></i> Cancelar</button><div class="flex gap-1">${[0,1,2,3,4].map(i => `<div class="w-6 h-1 rounded-full ${i <= step ? 'bg-neon-theme shadow-[0_0_5px_var(--theme-color-hex)]' : 'bg-gray-800'} transition-all duration-300"></div>`).join('')}</div><div class="w-16"></div></div><div class="flex-1 p-6 overflow-y-auto custom-scrollbar relative"><h2 class="text-2xl font-display font-bold text-white text-center mb-6 tracking-widest drop-shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]">${title}</h2>${contentHtml}</div><div class="p-6 border-t border-gray-800 flex gap-4 bg-gray-900/50">${step > 0 ? `<button onclick="state.creatorStep--; render()" class="w-1/3 py-4 bg-transparent border border-gray-700 rounded-xl text-gray-400 font-bold hover:text-white hover:border-gray-500 transition-colors text-xs uppercase tracking-wider">Voltar</button>` : '<div class="w-1/3"></div>'}${step < 4 ? `<button onclick="nextCreatorStep()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl hover:brightness-110 transition-colors text-xs uppercase tracking-wider shadow-[0_0_15px_rgba(var(--theme-rgb),0.4)]">PRÓXIMO <i data-lucide="chevron-right" size="14" class="inline mb-0.5"></i></button>` : `<button onclick="finishCreator()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl shadow-[0_0_20px_rgba(var(--theme-rgb),0.6)] hover:brightness-110 transition-colors text-xs uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="save" size="16"></i> FINALIZAR</button>`}</div></div>`;
        }

        function renderSheet(container) {
            const char = state.currentChar;
            const clsData = SYSTEM_DB.classes.find(c => c.id === char.class);
            const themeColor = clsData ? clsData.color : '#00ff9d';
            setThemeColor(themeColor);
            const nextXp = char.xp_next || 100;
            const xpPct = Math.min(100, (char.xp / nextXp) * 100);
            let tabContent = '';
            
            if (state.activeTab === 'FICHA') {
                tabContent = `<div class="grid grid-cols-2 gap-3 p-4 fade-in">${Object.entries(char.attributes).map(([key, attr]) => {
                    const mod = getMod(attr.value);
                    return `<div class="bg-gray-900/60 border border-gray-800 rounded-2xl p-4 flex flex-col items-center relative hover:border-[${themeColor}] transition-colors group select-none" ondblclick="rollDice('${key}', ${mod})"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 group-hover:text-[${themeColor}] transition-colors">${key}</span><div class="flex items-center gap-3"><button onclick="updateSheetAttr('${key}', -1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="minus" size="12"></i></button><span class="text-3xl font-display font-bold text-white shadow-black drop-shadow-lg">${attr.value}</span><button onclick="updateSheetAttr('${key}', 1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="plus" size="12"></i></button></div><div class="mt-2 bg-gray-800 px-3 py-0.5 rounded-full text-xs font-bold text-[${themeColor}] border border-gray-700">${mod >= 0 ? '+'+mod : mod}</div><button onclick="toggleSave('${key}')" class="absolute top-2 right-2 ${attr.save ? `text-[${themeColor}]` : 'text-gray-700'}"><i data-lucide="shield" size="14" class="${attr.save ? 'fill-current opacity-20' : ''}"></i>${attr.save ? `<span class="absolute -bottom-2 -right-1 text-[8px] font-bold">+2</span>` : ''}</button></div>`;
                }).join('')}<div class="col-span-2 mt-4"><h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 px-2">Perícias Treinadas</h3><div class="flex flex-wrap gap-2 px-2">${char.skills && char.skills.length > 0 ? char.skills.map(skill => `<span class="bg-gray-800 border border-gray-700 px-3 py-1 rounded-lg text-xs text-gray-300 flex items-center gap-1"><i data-lucide="check" size="10" class="text-[${themeColor}]"></i> ${skill}</span>`).join('') : '<span class="text-xs text-gray-600 italic">Nenhuma perícia treinada.</span>'}</div></div></div>`;
            } else if (state.activeTab === 'TRACOS') {
                const raceData = SYSTEM_DB.racas.find(r => r.nome === char.race);
                let traitsHtml = '';
                if (char.race === 'Formiga Quimera') {
                    if (char.raceTraits && char.raceTraits.length > 0) {
                         traitsHtml = char.raceTraits.map(tName => {
                            const tData = raceData.caracteristicas.find(c => c.nome === tName);
                            return `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl"><h4 class="font-bold text-neon-theme text-sm mb-1">${tName}</h4><p class="text-xs text-gray-400 leading-relaxed">${tData ? (tData.efeito || tData.mecanica) : 'Descrição não encontrada.'}</p></div>`;
                         }).join('');
                    } else traitsHtml = '<div class="text-center text-gray-600 italic">Nenhum traço de quimera selecionado.</div>';
                } else {
                    const fixedFeatures = [...(raceData.caracteristicas || []), ...(raceData.opcoes_caracteristica || [])];
                    if (fixedFeatures.length > 0) {
                        traitsHtml = fixedFeatures.map(f => `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl"><h4 class="font-bold text-neon-theme text-sm mb-1">${f.nome}</h4><p class="text-xs text-gray-400 leading-relaxed">${f.efeito || f.mecanica || ''}</p>${f.tabela_ancestral ? `<p class="text-[10px] text-gray-500 mt-2 italic">${f.tabela_ancestral}</p>` : ''}</div>`).join('');
                    } else traitsHtml = '<div class="text-center text-gray-600 italic">Esta raça não possui traços especiais listados.</div>';
                }
                tabContent = `<div class="p-4 fade-in space-y-4"><div class="flex items-center gap-3 mb-2"><div class="bg-gray-800 p-2 rounded text-[${themeColor}]"><i data-lucide="dna" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">${char.race}</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Características Raciais</p></div></div><div class="space-y-3">${traitsHtml}</div></div>`;
            } else if (state.activeTab === 'INV') {
                tabContent = `<div class="p-4 fade-in space-y-4"><div class="flex gap-2"><input type="text" id="new-item-name" placeholder="Nome do item..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-[${themeColor}]"><button onclick="addItem()" class="bg-[${themeColor}] text-black px-4 rounded-lg font-bold hover:brightness-110"><i data-lucide="plus"></i></button></div><div class="space-y-2">${char.inventory.length === 0 ? '<div class="text-center text-gray-600 text-xs py-8 border border-dashed border-gray-800 rounded-xl">Mochila vazia.</div>' : ''}${char.inventory.map((item, idx) => `<div class="bg-gray-900 border border-gray-800 rounded-xl p-3 flex justify-between items-center"><span class="text-sm font-bold text-white">${item.name}</span><div class="flex items-center gap-3"><button onclick="updateItemQty(${idx}, -1)" class="text-gray-500 hover:text-white"><i data-lucide="minus" size="14"></i></button><span class="text-sm w-4 text-center">${item.qty}</span><button onclick="updateItemQty(${idx}, 1)" class="text-gray-500 hover:text-white"><i data-lucide="plus" size="14"></i></button></div></div>`).join('')}</div><div class="flex justify-between items-center pt-4 border-t border-gray-800 text-xs text-gray-400"><span class="uppercase font-bold tracking-widest">Jenny (Dinheiro)</span><div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-700"><span class="text-[${themeColor}] font-bold">$</span><input type="number" value="${char.money}" onchange="updateMoney(this.value)" class="w-24 text-right bg-transparent text-white font-mono outline-none"></div></div></div>`;
            } else if (state.activeTab === 'DADOS') {
                tabContent = `<div class="p-4 fade-in h-full flex flex-col"><div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-950 pb-2 border-b border-gray-800 z-10"><h3 class="font-bold text-white uppercase tracking-wider text-xs">Histórico de Rolagens</h3><button onclick="clearHistory()" class="text-[10px] text-red-500 uppercase font-bold hover:text-red-400 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Limpar Log</button></div><div class="flex-1 overflow-y-auto space-y-2 text-sm pb-4">${char.history.length === 0 ? '<div class="text-center text-gray-600 italic py-10">Sem rolagens recentes.</div>' : ''}${char.history.slice().reverse().map(h => `<div class="bg-gray-900/50 p-3 rounded-lg border-l-2 border-[${themeColor}] flex flex-col gap-1"><div class="flex justify-between text-[10px] text-gray-500"><span>${h.time}</span><span class="uppercase font-bold tracking-wider text-gray-400">${h.label}</span></div><div class="flex justify-between items-center mt-1"><div class="flex flex-col"><span class="text-xs text-gray-500">Resultado</span><span class="text-2xl font-bold ${h.dice===20?'text-neon-yellow':h.dice===1?'text-neon-red':'text-white'} font-display">${h.total}</span></div><div class="text-right"><span class="text-xs text-gray-600 block">D20 + Mod</span><span class="text-gray-300 font-mono text-sm">[${h.dice}] ${h.mod>=0?'+':''}${h.mod}</span></div></div></div>`).join('')}</div></div>`;
            } else { tabContent = `<div class="flex flex-col items-center justify-center h-full text-gray-600 fade-in gap-4"><i data-lucide="construction" size="48" class="opacity-20"></i><span class="text-xs uppercase tracking-widest">Em desenvolvimento</span></div>`; }

            container.innerHTML = `<div class="flex flex-col h-full bg-gray-950"><div class="relative pt-8 pb-4 px-6 bg-gradient-to-b from-gray-900 to-transparent"><button onclick="state.view='LIST'; render()" class="absolute top-4 left-4 text-gray-500 hover:text-white bg-black/30 p-2 rounded-full backdrop-blur-sm"><i data-lucide="arrow-left" size="20"></i></button><div class="mt-4"><h1 class="font-display font-black text-2xl text-white uppercase tracking-wider truncate drop-shadow-lg">${char.name}</h1><div class="flex items-center gap-3 mt-2"><div class="h-2 flex-1 bg-gray-800 rounded-full overflow-hidden border border-gray-700"><div class="h-full bg-[${themeColor}] shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]" style="width: ${xpPct}%"></div></div><div class="flex flex-col items-end leading-none"><span class="text-[10px] font-bold text-gray-500 uppercase">Nível</span><span class="text-lg font-display font-bold text-white">${char.level}</span></div></div></div></div><div class="grid grid-cols-4 gap-1 px-2 py-2 border-t border-b border-gray-800 bg-[#0e0e14]">${renderVitalBlock('PV', char.vitals.hp, char.vitals.hpMax, 'text-neon-red')}${renderVitalBlock('AURA', char.vitals.aura, char.vitals.auraMax, `text-[${themeColor}]`)}${renderVitalBlock('SAN', char.vitals.san, char.vitals.sanMax, 'text-white')}${renderVitalBlock('CA', char.vitals.ca, null, 'text-white')}</div><div class="flex-1 overflow-y-auto custom-scrollbar relative">${tabContent}</div><div class="h-16 bg-[#0e0e14] border-t border-gray-800 flex items-center justify-around px-2 relative z-50">${renderNavItem('FICHA', 'user', themeColor)}${renderNavItem('NEN', 'flame', themeColor)}${renderNavItem('TRACOS', 'dna', themeColor)}${renderNavItem('INV', 'backpack', themeColor)}${renderNavItem('DADOS', 'dices', themeColor)}</div></div>`;
        }

        // Helpers de renderização
        function renderVitalBlock(label, val, max, colorClass) { return `<div class="flex flex-col items-center justify-center py-1"><span class="text-[8px] font-bold text-gray-500 uppercase tracking-wider mb-1">${label}</span><div class="flex items-center gap-1 bg-gray-900/50 px-2 py-1 rounded border border-gray-800">${max ? `<button onclick="updateVital('${label.toLowerCase()}', -1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-left" size="10"></i></button>` : ''}<span class="font-display font-bold text-sm ${colorClass} w-6 text-center">${val}</span>${max ? `<button onclick="updateVital('${label.toLowerCase()}', 1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-right" size="10"></i></button>` : ''}</div></div>`; }
        function renderNavItem(id, icon, color) { const active = state.activeTab === id; return `<button onclick="setTab('${id}')" class="flex flex-col items-center justify-center w-full h-full gap-1 group relative">${active ? `<div class="absolute top-0 w-8 h-0.5 bg-[${color}] shadow-[0_0_10px_${color}]"></div>` : ''}<i data-lucide="${icon}" size="${active ? 20 : 18}" class="${active ? `text-[${color}] drop-shadow-[0_0_5px_${color}]` : 'text-gray-600 group-hover:text-gray-400'} transition-all"></i><span class="text-[7px] font-bold tracking-widest ${active ? `text-[${color}]` : 'text-gray-600'}">${id}</span></button>`; }

        // --- CONTROLLERS ---
        function selectChar(id) { state.currentChar = state.characters.find(c => c.id === id); state.view = 'SHEET'; state.activeTab = 'FICHA'; render(); }
        function startCreator() { state.creatorStep = 0; state.tempChar = null; state.attrMethodLocked = false; state.view = 'CREATOR'; render(); }
        function selectNenType(cls) { state.tempChar.class = cls; const clsData = SYSTEM_DB.classes.find(c => c.id === cls); if(clsData) setThemeColor(clsData.color); render(); }
        
        // NOVO: Seleção de Raça sem Re-render
        function selectRace(raceName) {
            state.tempChar.race = raceName;
            SYSTEM_DB.racas.forEach(r => {
                const card = document.getElementById(`race-card-${r.nome.replace(/\s/g,'-')}`);
                const content = document.getElementById(`race-content-${r.nome.replace(/\s/g,'-')}`);
                const checkWrapper = document.getElementById(`check-${r.nome.replace(/\s/g,'-')}`);
                const chevronWrapper = document.getElementById(`chevron-${r.nome.replace(/\s/g,'-')}`);
                
                if (r.nome === raceName) {
                    // Activate styles
                    card.classList.remove('border-gray-800', 'bg-gray-900');
                    card.classList.add('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    
                    // Text Color
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-white');
                    h3.classList.add('text-neon-theme');

                    // Checkmark Wrapper Opacity
                    checkWrapper.classList.remove('opacity-0');
                    checkWrapper.classList.add('opacity-100');

                    // Chevron Wrapper Rotation and Color
                    chevronWrapper.classList.remove('-rotate-90', 'text-gray-600');
                    chevronWrapper.classList.add('rotate-0', 'text-neon-theme');

                    // Content
                    content.classList.add('open', 'pb-4');
                } else {
                    // Deactivate styles
                    card.classList.remove('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    card.classList.add('border-gray-800', 'bg-gray-900');

                    // Text Color
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-neon-theme');
                    h3.classList.add('text-white');

                    // Checkmark Wrapper Opacity
                    checkWrapper.classList.remove('opacity-100');
                    checkWrapper.classList.add('opacity-0');

                    // Chevron Wrapper Rotation and Color
                    chevronWrapper.classList.remove('rotate-0', 'text-neon-theme');
                    chevronWrapper.classList.add('-rotate-90', 'text-gray-600');

                    // Content
                    content.classList.remove('open', 'pb-4');
                }
            });
        }

        // NOVO: Toggle Traits sem Re-render
        function toggleRaceTrait(traitName) {
            const list = state.tempChar.raceTraits || [];
            const idx = list.indexOf(traitName);
            if (idx >= 0) list.splice(idx, 1);
            else {
                if (list.length >= 3) { alert("Você só pode escolher até 3 características."); return; }
                list.push(traitName);
            }
            state.tempChar.raceTraits = list;
            
            // DOM Update
            const btn = document.getElementById(`trait-btn-${traitName.replace(/\s/g,'-')}`);
            if (idx >= 0) { // Removed
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>';
            } else { // Added
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-neon-theme/10 border-neon-theme text-white";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
            }
            document.getElementById('trait-counter').innerText = `(${list.length}/3)`;
            document.getElementById('trait-counter').className = list.length >= 3 ? 'text-neon-theme' : 'text-gray-500';
        }

        // NOVO: Toggle Skills sem Re-render
        function toggleCreatorSkill(skill, type = 'main') {
            const list = type === 'main' ? state.tempChar.skills : state.tempChar.otherSkills;
            const limit = type === 'main' ? 5 : 4;
            const idx = list.indexOf(skill);
            if (idx >= 0) list.splice(idx, 1);
            else {
                if (list.length >= limit) { alert(`Limite de ${limit} atingido.`); return; }
                list.push(skill);
            }
            // DOM Update
            const btn = document.getElementById(`skill-btn-${skill.replace(/\s/g,'-')}`);
            const baseClass = type === 'main' ? 'bg-neon-theme/10 border-neon-theme text-white' : 'bg-neon-blue/10 border-neon-blue text-white';
            const iconColor = type === 'main' ? 'text-neon-theme' : 'text-neon-blue';
            
            if (idx >= 0) { // Removed
                btn.className = "flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800";
                btn.querySelector('div:last-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle"><circle cx="12" cy="12" r="10"/></svg>';
            } else { // Added
                btn.className = `flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${baseClass}`;
                btn.querySelector('div:last-child').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle ${iconColor}"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
            }
            const countId = type === 'main' ? 'skill-count-MAIN' : 'skill-count-OTHER';
            document.getElementById(countId).innerText = list.length;
            document.getElementById(countId).className = list.length >= limit ? (type === 'main' ? 'text-neon-theme' : 'text-neon-blue') : 'text-gray-300';
        }

        // NOVO: Point Buy com Limite e Feedback Visual
        function buyStat(attr, delta) {
            lockAttributeMethod();
            const current = state.tempChar.attributes[attr];
            const next = current + delta;
            
            if (next >= 1 && next <= 30) {
                const currentCost = calculateTotalCost(state.tempChar.attributes);
                // Calculate diff
                const costDiff = getPointBuyCost(next) - getPointBuyCost(current);
                const MAX = 20;

                // Check Budget (Only prevent increase if over budget)
                if (costDiff > 0 && (currentCost + costDiff > MAX)) {
                    // Feedback Visual de Erro
                    const bar = document.getElementById('buy-bar');
                    const totalEl = document.getElementById('buy-total');
                    totalEl.classList.add('text-red-500', 'shake');
                    setTimeout(() => totalEl.classList.remove('shake'), 500);
                    return; // Block change
                }

                // Apply Change
                state.tempChar.attributes[attr] = next;
                
                // DOM Updates (No Render)
                const newTotal = currentCost + costDiff;
                document.getElementById(`attr-val-${attr}`).innerText = next;
                
                const totalEl = document.getElementById('buy-total');
                totalEl.innerText = newTotal;
                
                // Update Bar
                const bar = document.getElementById('buy-bar');
                bar.style.width = `${Math.min(100, (newTotal/MAX)*100)}%`;
                
                // Color Logic
                if (newTotal > MAX) { // Shouldn't happen due to check, but safety
                    bar.classList.remove('bg-neon-theme'); bar.classList.add('bg-red-500');
                    totalEl.classList.add('text-red-500'); totalEl.classList.remove('text-white');
                } else {
                    bar.classList.add('bg-neon-theme'); bar.classList.remove('bg-red-500');
                    totalEl.classList.add('text-white'); totalEl.classList.remove('text-red-500');
                }
            }
        }
        
        function setAttrTab(mode) {
             if (state.attrMethodLocked) return; 
             state.attrTab = mode; state.selectedPoolIdx = null;
             if(mode === 'COMPRA') { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = 10); state.attrPool = []; } 
             else { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = null); state.attrPool = []; }
             render();
        }
        function lockAttributeMethod() { if(!state.attrMethodLocked) { state.attrMethodLocked = true; render(); } }
        function rollAllStats() { lockAttributeMethod(); let newPool = []; for(let k=0; k<6; k++) { let dice = []; for(let i=0; i<4; i++) { let d = Math.floor(Math.random()*6)+1; if(d === 1) d = Math.floor(Math.random()*6)+1; dice.push(d); } dice.sort((a,b) => b-a); newPool.push(dice[0] + dice[1] + dice[2]); } state.attrPool = newPool.sort((a,b) => b-a); render(); }
        function applyStandardArray() { lockAttributeMethod(); state.attrPool = [15, 14, 13, 12, 10, 8]; render(); }
        function selectPoolItem(idx) { if (state.selectedPoolIdx === idx) state.selectedPoolIdx = null; else state.selectedPoolIdx = idx; render(); }
        function assignToSlot(attr) { if (state.selectedPoolIdx === null) return; if (state.tempChar.attributes[attr] !== null) state.attrPool.push(state.tempChar.attributes[attr]); const val = state.attrPool[state.selectedPoolIdx]; state.tempChar.attributes[attr] = val; state.attrPool.splice(state.selectedPoolIdx, 1); state.attrPool.sort((a,b) => b-a); state.selectedPoolIdx = null; render(); }
        function returnToPool(attr) { const val = state.tempChar.attributes[attr]; if (val !== null) { state.attrPool.push(val); state.attrPool.sort((a,b) => b-a); state.tempChar.attributes[attr] = null; render(); } }

        function nextCreatorStep() {
            if (state.creatorStep === 0 && !state.tempChar.name) { alert("Dê um nome ao personagem!"); return; }
            if (state.creatorStep === 2) {
                if (state.attrTab === 'COMPRA') { const cost = calculateTotalCost(state.tempChar.attributes); if (cost > 20) { alert("Você excedeu o limite de pontos de compra (20)!"); return; } } 
                else { const values = Object.values(state.tempChar.attributes); if (values.some(v => v === null)) { alert("Aloque todos os valores do pool para os atributos!"); return; } }
            }
            state.creatorStep++; render();
        }

        function finishCreator() {
            const newChar = {
                id: generateId(), name: state.tempChar.name, class: state.tempChar.class, race: state.tempChar.race, level: 0, xp: 0, xp_next: 50, money: 0,
                attributes: {}, skills: [...state.tempChar.skills, ...state.tempChar.otherSkills], raceTraits: state.tempChar.raceTraits || [],
                vitals: { hp: 10 + getMod(state.tempChar.attributes.CON), hpMax: 10 + getMod(state.tempChar.attributes.CON), aura: 100, auraMax: 100, san: 10 + getMod(state.tempChar.attributes.INT), sanMax: 10 + getMod(state.tempChar.attributes.INT), ca: 10 + getMod(state.tempChar.attributes.CON) },
                inventory: [], history: []
            };
            Object.entries(state.tempChar.attributes).forEach(([k,v]) => { newChar.attributes[k] = { value: v || 10, save: false }; });
            saveCharacter(newChar); state.currentChar = newChar; state.view = 'SHEET'; state.activeTab = 'FICHA'; render();
        }

        function setTab(tab) { state.activeTab = tab; render(); }
        function updateSheetAttr(key, delta) { state.currentChar.attributes[key].value += delta; saveCharacter(state.currentChar); render(); }
        function toggleSave(key) { state.currentChar.attributes[key].save = !state.currentChar.attributes[key].save; saveCharacter(state.currentChar); render(); }
        function updateVital(type, delta) { const v = state.currentChar.vitals; if (type === 'pv') v.hp += delta; if (type === 'aura') v.aura += delta; if (type === 'san') v.san += delta; saveCharacter(state.currentChar); render(); }
        function addItem() { const name = document.getElementById('new-item-name').value; if (name) { state.currentChar.inventory.push({ name, qty: 1 }); saveCharacter(state.currentChar); render(); } }
        function updateItemQty(idx, delta) { const item = state.currentChar.inventory[idx]; item.qty += delta; if (item.qty <= 0) state.currentChar.inventory.splice(idx, 1); saveCharacter(state.currentChar); render(); }
        function updateMoney(val) { state.currentChar.money = parseInt(val) || 0; saveCharacter(state.currentChar); }
        function rollDice(attrName, mod) { const d20 = Math.floor(Math.random() * 20) + 1; const total = d20 + mod; const entry = { time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}), label: attrName, dice: d20, mod: mod, total: total }; state.currentChar.history.push(entry); if (state.currentChar.history.length > 50) state.currentChar.history.shift(); saveCharacter(state.currentChar); alert(`🎲 ${attrName}\n\n[${d20}] + ${mod} = ${total}`); state.activeTab = 'DADOS'; render(); }
        function clearHistory() { if(confirm('Limpar histórico?')) { state.currentChar.history = []; saveCharacter(state.currentChar); render(); } }

        window.addEventListener('DOMContentLoaded', () => { loadCharacters(); setThemeColor('#00ff9d'); render(); });
    </script>
</body>
</html>
