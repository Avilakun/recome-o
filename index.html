<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hunter x Hunter RPG Sheet</title>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['Orbitron', 'sans-serif'],
              sans: ['Rajdhani', 'sans-serif'],
            },
            colors: {
              'neon-green': '#00ff9d',
              'neon-blue': '#00f0ff',
              'neon-red': '#ff0055',
              'neon-yellow': '#ffe600',
              'neon-theme': 'var(--theme-color-hex, #00ff9d)',
              'neon-dark': '#0a0a0f',
              'neon-card': '#0e0e14',
            }
          }
        }
      }
    </script>

    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color-hex: #00ff9d;
            --theme-rgb: 0, 255, 157;
        }

        body {
            background-color: #050505;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* App-like feel */
        }

        /* Utilitários de Scroll */
        .custom-scrollbar { overflow-y: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Inputs limpos */
        input, select { background: transparent; outline: none; }
        
        /* Containers */
        #app {
            height: 100vh; /* Fallback */
            height: 100dvh; /* Mobile modern browsers */
            display: flex;
            flex-direction: column;
            max-width: 480px; /* Mobile width constraint on desktop */
            margin: 0 auto;
            background-color: #0a0a0f;
            position: relative;
            border-left: 1px solid #1f2937;
            border-right: 1px solid #1f2937;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Safe Area Padding */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Nen Hexagon Styles */
        .nen-node {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .nen-node:active {
            transform: scale(0.95) !important;
        }
        
        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 2000px; /* Increased for content */
            opacity: 1;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Custom glow for shield */
        .shield-glow {
            filter: drop-shadow(0 0 4px currentColor);
        }
        .shield-expert {
            filter: drop-shadow(0 0 6px #ffe600);
        }
        
        /* Radio Button Custom Styling */
        .custom-radio:checked + div {
            border-color: var(--theme-color-hex);
            background-color: rgba(var(--theme-rgb), 0.1);
        }
        .custom-radio:checked + div .radio-indicator {
            background-color: var(--theme-color-hex);
            border-color: var(--theme-color-hex);
        }

        /* Drag and Drop Styles */
        .dragging {
            opacity: 0.5;
            cursor: grabbing !important;
        }
        .drop-zone-active {
            border-color: var(--theme-color-hex) !important;
            background-color: rgba(var(--theme-rgb), 0.1) !important;
            box-shadow: 0 0 15px rgba(var(--theme-rgb), 0.2);
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- O conteúdo será injetado aqui via JavaScript -->
    </div>

    <!-- DB e Lógica -->
    <script>
        // --- DADOS DO SISTEMA ---
        const SYSTEM_DB = {
            classes: [
                { id: 'INTENSIFICAÇÃO', color: '#00ff9d', label: 'INTENSIFICAÇÃO', angle: 270, desc: 'Aura expressa maior poder, cura e resistência' }, 
                { id: 'TRANSFORMAÇÃO', color: '#d946ef', label: 'TRANSFORMAÇÃO', angle: 330, desc: 'Aura assume outra(s) propriedades(s)' },
                { id: 'MATERIALIZAÇÃO', color: '#ff0055', label: 'MATERIALIZAÇÃO', angle: 30, desc: 'Aura cria e altera matéria física' },
                { id: 'ESPECIALIZAÇÃO', color: '#00f0ff', label: 'ESPECIALIZAÇÃO', angle: 90, desc: 'Aura se apresenta de maneira inovadora' },
                { id: 'MANIPULAÇÃO', color: '#9ca3af', label: 'MANIPULAÇÃO', angle: 150, desc: 'Aura manipula objetos, matéria ou seres vivos' },
                { id: 'EMISSÃO', color: '#ffe600', label: 'EMISSÃO', angle: 210, desc: 'Aura se mantém forte fora do corpo e em longas distâncias' }
            ],
            xpTable: [50, 150, 350, 500, 800, 1000, 1500, 2500, 3200, 4000, 5000, 6500],
            racas: [
                // Humanos e Tribos
                { nome: "Humano Comum", descricao: "Raça mais comum no mundo.", aumento_atributo: { "FOR": 1, "DES": 1, "CON": 1, "INT": 1, "SAB": 1, "CAR": 1 }, fonte: "[3, 4]", categoria: "Humanos e Tribos" },
                { nome: "Fanalis", descricao: "Composição física descomunal.", aumento_atributo: { "FOR": 4, "CON": 2, "DES": -2, "INT": -2, "SAB": -2, "CAR": -2 }, fonte: "[3, 4]", categoria: "Humanos e Tribos" },
                { nome: "Gyudondond", descricao: "Homens Flauta.", aumento_atributo: "Distribua 3 pontos em qualquer atributo", caracteristicas: [{ nome: "Alarido de Guerra", efeito: "Intimidação com dança." }], fonte: "[3, 4]", categoria: "Humanos e Tribos" },
                { nome: "Imuchack", descricao: "Guerreiros gélidos.", aumento_atributo: { "FOR": 2, "CON": 1, "INT": -2 }, opcoes_caracteristica: [{ nome: "Imunidade ao Frio", efeito: "Imune frio/gelo." }, { nome: "Caça Aquática", efeito: "Nadar e respirar melhor." }], fonte: "[3, 4]", categoria: "Humanos e Tribos" },
                // Clãs Especiais
                { nome: "Kurta", descricao: "Olhos Escarlates.", aumento_atributo: { "INT_ou_SAB": 2 }, caracteristicas: [{ nome: "Mudança Escarlate", efeito: "+1 atributos com olhos vermelhos." }, { nome: "Caça Fascinante", efeito: "Procurado." }, { nome: "Sofrimento Profundo", efeito: "Gatilhos emocionais." }], fonte: "[5, 6]", categoria: "Clãs Especiais" },
                // Formigas Quimera
                { nome: "Formiga Quimera", descricao: "Sem Antecedentes. Ver Regra.", aumento_atributo: "Nenhum", caracteristicas: [{ nome: "Arma natural", efeito: "Dano variado." }, { nome: "Corpo Adaptável", efeito: "Resistência." }, { nome: "Criatura de Cerco", efeito: "Dano em construções." }, { nome: "Destreza animal", efeito: "Vantagem DES." }, { nome: "Escudo Natural", efeito: "Resistência dano físico." }, { nome: "Evasão", efeito: "+2 Esquiva." }, { nome: "Investida", efeito: "Dano com movimento." }, { nome: "Rasante", efeito: "Sem AdO voando." }, { nome: "Regeneração", efeito: "Recupera HP." }, { nome: "Telepatia", efeito: "Comunicação." }, { nome: "Veneno/Peçonha", efeito: "Aplica veneno." }], fonte: "[1, 2]", categoria: "Formigas Quimera" },
                // Modificados e Fantasia
                { nome: "Wormorfos", descricao: "Povo verme.", aumento_atributo: "Nenhum", caracteristicas: [{ nome: "Visão", efeito: "Ecolocalização." }, { nome: "Corpo Malemolente", efeito: "Resistência concussão." }, { nome: "Enterrada", efeito: "Submergir." }], fonte: "[5, 6]", categoria: "Modificados e Fantasia" },
                { nome: "Elfos e Meio-Elfos", descricao: "Herança feérica.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Ancestral Feérico", efeito: "Vantagem social." }], fonte: "[5, 6]", categoria: "Modificados e Fantasia" },
                { nome: "Meio-Orcs", descricao: "Guerreiros robustos.", aumento_atributo: { "FOR": 1, "CON": 1 }, caracteristicas: [{ nome: "Resistência Implacável", efeito: "Volta a 1 HP." }], fonte: "[5, 6]", categoria: "Modificados e Fantasia" },
                { nome: "Anões", descricao: "Robustos.", aumento_atributo: { "CON": 2 }, caracteristicas: [{ nome: "Resiliência Anã", efeito: "Vantagem veneno." }], fonte: "[7]", categoria: "Modificados e Fantasia" },
                { nome: "Draconatos", descricao: "Herança dragão.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Arma de Sopro", efeito: "2d6 dano." }], fonte: "[7]", categoria: "Modificados e Fantasia" },
                { nome: "Halflings", descricao: "Pequenos e sortudos.", aumento_atributo: { "DES": 1, "INT": 2 }, opcoes_caracteristica: [{ nome: "Sortudo", efeito: "Rerolar 1." }, { nome: "Bravura", efeito: "Vantagem medo." }, { nome: "Agilidade", efeito: "Passar por maiores." }], fonte: "Extra", categoria: "Modificados e Fantasia" },
                { nome: "Gnomos", descricao: "Inventores.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Esperteza Gnômica", efeito: "Vantagem mental magia." }], fonte: "Extra", categoria: "Modificados e Fantasia" },
                { nome: "Golias", descricao: "Gigantes de pedra.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Resistência de Pedra", efeito: "Reduz dano." }], fonte: "Extra", categoria: "Modificados e Fantasia" },
                // Tecnológicos e Sobrenaturais
                { nome: "Neans", descricao: "Andróides.", aumento_atributo: "Varia", caracteristicas: [{ nome: "Atualização", efeito: "Muda atributos." }, { nome: "Curto Circuito", efeito: "Dano elétrico." }], fonte: "[8, 9]", categoria: "Tecnológicos e Sobrenaturais" },
                { nome: "Vampiros", descricao: "Seres noturnos.", aumento_atributo: { "INT": 2, "Físico": 1 }, caracteristicas: [{ nome: "Sugar Aura", efeito: "Rouba aura." }, { nome: "Sol", efeito: "-CA." }], fonte: "[8, 9]", categoria: "Tecnológicos e Sobrenaturais" },
                { nome: "Djins", descricao: "Nen Post-Mortem.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Interpretação Travessa", efeito: "Ignora sorte." }], fonte: "Extra", categoria: "Tecnológicos e Sobrenaturais" },
                // Raças Incomuns
                { nome: "Bugbears", descricao: "Brutais.", aumento_atributo: { "FOR": 2, "DES": 1 }, caracteristicas: [{ nome: "Ataque Surpresa", efeito: "Dano extra." }], fonte: "Extra", categoria: "Raças Incomuns" },
                { nome: "Dahllans", descricao: "Meio-Dríades.", aumento_atributo: { "SAB": 4, "INT": -1, "CAR": -1 }, caracteristicas: [{ nome: "Herança Natural", efeito: "Visão penumbra." }], fonte: "Extra", categoria: "Raças Incomuns" },
                { nome: "Firbolgs", descricao: "Guardiões.", aumento_atributo: { "SAB": 2, "FOR": 1 }, caracteristicas: [{ nome: "Passo Oculto", efeito: "Invisibilidade." }], fonte: "Extra", categoria: "Raças Incomuns" },
                { nome: "Goblins", descricao: "Maliciosos.", aumento_atributo: "Escolha +2", caracteristicas: [{ nome: "Fúria do Pequeno", efeito: "Dano extra." }], fonte: "Extra", categoria: "Raças Incomuns" }
            ],
            antecedentes: [
                { nome: "Amigo dos Animais", descricao: "Pessoas que se importam com o equilíbrio da natureza, mas que também adoram um desafio, andam pelas florestas e pântanos buscando encontrar criaturas fantásticas e desconhecidas. Por outro lado, muitos amigos dos animais são simplesmente amados pela natureza como se fizessem parte dela.", proficiencias: "Escolha um Kit dentre os recebidos e Lidar com Animais e Natureza", equipamento: ["Qualquer arma simples", "Qualquer arma simples", "Kit de Caça e Rastreio de Criaturas ou Kit Médico"], caracteristicas: [{nome: "Habitat Natural", efeito: "Animais e Feras (inclusive hostis) normalmente o consideram outra criatura não hostil. Seus companheiros são tratados como membros aliados do seu bando, desde que não atuem de forma hostil."}, {nome: "Tarzan/Jane", efeito: "De alguma forma você se acostumou com a linguagem de animais e feras. Ao passar um minuto interagindo com uma criatura não hostil você pode identificar alguma informação que ela já tenha conhecimento sobre o ambiente ou uma outra criatura."}, {nome: "Companheiro Inabalável", efeito: "Você tem um companheiro que te concede a Ação 'Ajuda' no turno dele. Ele te entende e obedece comandos simples."}] },
                { nome: "Aristocrata", descricao: "Pessoas que entendem de riqueza, poder e privilégios. Mas não só entendem, elas desfrutam e estão acostumadas a isso. Através de algum título de nobreza, sua família exerce algum tipo de influência política significativa.", proficiencias: "História e Religião", equipamento: ["Celular ou Câmera", "Computador", "Mochila 3 (Mala)", "Qualquer arma simples"], caracteristicas: [{nome: "Posição Privilegiada", efeito: "Você é bem-vindo na alta sociedade e as pessoas assumem que você tem o direito de estar onde está. As pessoas comuns fazem todos os esforços para acomodá-lo e evitar seu desprazer."}, {nome: "Mauricinho / Patricinha", efeito: "Você recebe toda semana uma quantia correspondente aos recursos financeiros de sua família de acordo com a tabela ao rolar 1d4."}] },
                { nome: "Artista", descricao: "Pessoas com as mais variadas capacidades de entretenimento se aventuram no mundo artístico para realizar seus sonhos vivendo daquilo que amam ou buscando alcançar fama e dinheiro.", proficiencias: "Kit de Ferramenta de Ofício e escolha 3 dentre: Acrobacia, Atuação, Intuição ou Prestidigitação", equipamento: ["Mala de Roupas ou Mochila Comum/Maleta", "Câmera ou Celular", "Kit de Ferramentas de Ofício"], caracteristicas: [{nome: "Tudo no @", efeito: "Comerciantes que negociam com você reconhecem seu trabalho como artista, você tem chance (50%) de pagar suas compras com merchandising."}, {nome: "Virando a Cadeira", efeito: "Apresentar sua arte às pessoas antes de conversar ou negociar, faz com que fiquem fascinadas por você e tenham uma inclinação a concordar com sua opinião. Vantagem em testes de Carisma."}] },
                { nome: "Assassino", descricao: "Assassinos famosos como a família Zoldyck e ainda outros, desenvolvem habilidades próprias para sua profissão e, com isso, se tornam peritos naquilo que fazem. A arte de matar de forma rápida.", proficiencias: "Escolha um Kit dentre os recebidos e Acrobacia e Furtividade", equipamento: ["Adaga/Faca", "Veneno Variante: 1 frasco", "Pochete de Perna", "Kit de disfarce ou Kit de Falsificação"], caracteristicas: [{nome: "Eco do Ritmo", efeito: "Se concentrar em seu turno completo projeta um padrão hipnótico, fazendo com que todas as criaturas hostis tenham desvantagem em jogadas de ataque direcionadas a você."}, {nome: "Sumidão", efeito: "Vantagem em testes de furtividade de qualquer natureza e não é descoberto ao realizar um ataque enquanto se está furtivo."}, {nome: "Máquina de Matar", efeito: "Dano dobrado (nos dados) em ataques realizados enquanto se está oculto/furtivo."}] },
                { nome: "Caçador de Feras", descricao: "Nesse mundo existem diversas criaturas desconhecidas e hostis que se reproduzem nas sombras enquanto sobrepujam habitat naturais de outras criaturas.", proficiencias: "Escolha um Kit dentre os recebidos e Natureza e Sobrevivência", equipamento: ["Espingarda Carregada ou Tazer", "Kit de Caça e Rastreio de Criaturas ou Kit Antídoto", "Qualquer arma simples ou Marcial e Rede"], caracteristicas: [{nome: "Temos que Pegar!", efeito: "Vantagem em todos os testes relacionados a rastrear feras naturais e bestas mágicas (inclusive bestas de NEN)."}, {nome: "Desbravador", efeito: "Você recebe +2 em sobrevivência e anula qualquer penalidade de sobrevivência não causadas por Hatsus."}] },
                { nome: "Cientista", descricao: "Após muito estudo e dedicação, começam a arriscar a vida também no campo experimental para comprovar suas teorias e hipóteses.", proficiencias: "Escolha 2 perícias com Kits e 3 dentre: História, Investigação, Medicina, Natureza, Prestidigitação, Religião ou Sobrevivência.", equipamento: ["Qualquer arma simples", "1 Mochila Comum/Maleta", "Kit Antídoto ou Kit Médico", "Kit de Armas ou Kit Forense ou Kit de Hacker"], caracteristicas: [{nome: "Explorar Fraqueza", efeito: "O personagem pode utilizar sua ação principal para analisar o oponente ou situação tendo vantagem no próximo ataque contra um inimigo ou teste baseado em inteligência."}, {nome: "Mestre do Planejamento", efeito: "Ao utilizar um item / kit escolhido no antecedente, você ganha um 1d6 para rolar em qualquer jogada ou teste cabível 3 vezes por dia."}] },
                { nome: "Criminoso", descricao: "Essas pessoas normalmente vivem à margem da lei, desprezando e quebrando os regulamentos da sociedade.", proficiencias: "Escolha um Kit dentre os recebidos e Enganação e Furtividade", equipamento: ["Qualquer arma simples ou Marcial", "1 Pochete", "Item do Tipo de Criminoso (Cleptomaníaco, Estelionatário, etc)"], caracteristicas: [{nome: "Cleptomaníaco", efeito: "Inicia com celular roubado e kit de ferramentas de ofício."}, {nome: "Estelionatário", efeito: "Acesso a kits de falsificação ou disfarce para golpes."}, {nome: "Político Corrupto", efeito: "Possui informações privilegiadas (Pen-Drive) para manipular poder e influência."}, {nome: "Traficante", efeito: "Inicia com recursos financeiros de vendas ilícitas e contatos de fornecedores."}] },
                { nome: "Discípulo", descricao: "Uma pessoa que é orientada por um mestre e normalmente continua seguindo suas orientações. Dependendo do mestre o discípulo pode se desenvolver em áreas diferentes a partir de suas aptidões.", proficiencias: "Kit de Ferramenta de Ofício e Escolha 3 perícias quaisquer", equipamento: ["Celular com contato ou anotações de seu mestre", "Qualquer arma simples ou Marcial", "Kit de Ferramentas de Ofício"], caracteristicas: [{nome: "Abre-te Sésamo", efeito: "Você consegue acessar alguns lugares ou pessoas e informações a partir da fama do seu mestre e da credibilidade que o nome lhe confere."}, {nome: "Mateus 28.18-20", efeito: "Seu mestre supostamente morreu ou desapareceu, porém ele lhe concedeu um ensinamento, poder, item, equipamento ou marca que te permite continuar sua história."}] },
                { nome: "Guarda Costas", descricao: "Arduamente treinados para trabalhos físicos, guarda-costas podem ser pessoas dispostas a fazer um trabalho perigoso por dinheiro.", proficiencias: "Atletismo e Intimidação", equipamento: ["Pistola", "Qualquer arma simples ou Marcial"], caracteristicas: [{nome: "Artista Marcial", efeito: "Você treinou técnicas e desenvolveu seu corpo ao máximo para o combate corpo-a-corpo. Seus golpes desarmados causam 1d6 no lugar de 1d4."}, {nome: "Horário de Trabalho", efeito: "Você consegue escolher uma pessoa para manter sua atenção de forma constante. Você tem vantagem e +2 em jogadas de percepção para encontrar essa pessoa."}] },
                { nome: "Líder", descricao: "Você é uma pessoa que procura mudar a sociedade ao seu redor jogando na arena da política, pessoas e personalidades.", proficiencias: "Escolha três entre Enganação, História, Investigação ou Persuasão", equipamento: ["1 pílula de Hemoglobina", "1 pílula de Hemoglobina variante", "Qualquer arma simples", "Qualquer outro Kit"], caracteristicas: [{nome: "Presença de Liderança", efeito: "Sua presença notável e inspiradora concede 1d4 (grau básico) que pode ser utilizado em qualquer jogada de seus aliados (cada um) até o fim do dia."}] },
                { nome: "Marinheiro", descricao: "Você navegou em um navio pelo mar durante anos, enfrentando poderosas tormentas e monstros abissais.", proficiencias: "Atletismo e Percepção", equipamento: ["Corrente Pesada ou Rede", "Qualquer arma simples ou Marcial"], caracteristicas: [{nome: "Grande Herói da Marinha", efeito: "Você não gasta passagem em navios, jatos, aviões e dirigíveis. Possui Documento de patente e Experiência de Convés."}, {nome: "Imperador do Mar", efeito: "Buscando mais poder você ouviu falar de NEN. Possui Experiência de Convés, Pistola ou Mosquete, Arma simples ou Marcial e Relógio à prova d’água."}] },
                { nome: "Mentalista", descricao: "Conhecedores do funcionamento da mente, mentalistas são profissionais que trabalham com a realidade do pensamento ou com a ilusão.", proficiencias: "Escolha um Kit dentre os recebidos e Enganação ou Persuasão e Intuição", equipamento: ["Qualquer arma simples", "Kit de Falsificação ou Kit de Ferramenta de Ofício"], caracteristicas: [{nome: "Perceptivo", efeito: "+2 em testes de Percepção."}, {nome: "Referência Bibliográfica", efeito: "Possui vantagem em todos os testes de Carisma contra humanoides com inteligência igual ou superior a Modificador 0."}] },
                { nome: "Negociante", descricao: "Indivíduos acostumados a lidar com o público e, por isso, possuem facilidade na oratória e na persuasão.", proficiencias: "Atuação, Persuasão e Prestidigitação", equipamento: ["Qualquer equipamento dentro do orçamento de 2.000 $", "1 Mala de Roupas"], caracteristicas: [{nome: "Camelô", efeito: "Quando vender qualquer item seu usado, você consegue vendê-lo com o custo oficial, desde que esteja funcional."}, {nome: "Pechincheiro", efeito: "Você consegue comprar qualquer item com desconto de 30% do valor de mercado (exceto armas de fogo e itens místicos)."}] },
                { nome: "Ninja", descricao: "Esgueirando-se na noite ou no meio da multidão, submetendo seus corpos à torturas para acostumarem-se com a dor e aplicando técnicas nunca antes vistas.", proficiencias: "Escolha um Kit dentre os recebidos e Acrobacia ou Atletismo e Furtividade", equipamento: ["Armas Ninja Variadas", "Kit de disfarce ou Kit de Falsificação", "Explosivos Ninja", "Qualquer arma simples ou Marcial"], caracteristicas: [{nome: "Furtividade Superior", efeito: "Vantagem em testes de furtividade de qualquer natureza."}, {nome: "Jutsu: Clone das Sombras", efeito: "Cria um clone sólido. 5/5 PV, mesmas características sem NEN. Pode usar ação bônus para comandar clones."}, {nome: "Jutsu: Substituição", efeito: "Reação para fuga rápida com CA +5 e chance de aparecer em até 3m de onde estava."}] },
                { nome: "Órfão", descricao: "Você cresceu nas ruas, sozinho, órfão e pobre. Você não tinha ninguém para cuidar de você ou te alimentar, então, aprendeu a se virar sozinho.", proficiencias: "Escolha 2 perícias com Kits recebidos. Recebe ainda Furtividade e Intuição ou Prestidigitação", equipamento: ["Kit de Disfarce", "Kit de Ferramentas de Ofício ou Kit de Armas", "Qualquer arma simples"], caracteristicas: [{nome: "Segredos da Cidade", efeito: "Você conhece os padrões secretos e o fluxo das cidades. Quando não em combate, você e companheiros podem viajar com o dobro da velocidade."}, {nome: "Zé-Pequeno", efeito: "Vantagem em todos os testes de Carisma quando se tratam de assuntos, pessoas e temas relacionados à máfia e ao conhecimento do submundo."}, {nome: "Insignificante", efeito: "Os inimigos tendem a te ignorar se você não fizer nada que os ameace e nem for o foco inicial de um conflito."}] },
                { nome: "Recluso", descricao: "Você viveu em reclusão – ou em uma comunidade isolada como um monastério ou completamente sozinho – por um período importante da sua vida.", proficiencias: "Escolha 1 perícia com Kit recebido e Intuição, Medicina e Religião", equipamento: ["Qualquer arma simples ou Marcial", "Kit de Armas ou Kit de Caça e Rastreio de Criaturas"], caracteristicas: [{nome: "Monge", efeito: "Vantagem em qualquer teste de constituição. Treinou técnicas corporais para o combate desarmado. Seus golpes desarmados causam 1d6 no lugar de 1d4."}, {nome: "Escravo", efeito: "Resistente a intimidação com ou sem aura. Pessoas com posição de autoridade alheias a você tem desvantagem em qualquer teste de carisma que não lhe beneficie."}] },
                { nome: "Soldado", descricao: "A guerra sempre esteve na vida de soldados. Treinando desde jovem, estudando o uso das armas e armaduras, aprendendo técnicas básicas de sobrevivência.", proficiencias: "Escolha 1 perícia com Kit recebido e Atletismo e Intimidação ou Sobrevivência", equipamento: ["Qualquer arma simples ou Marcial", "Kit de Armas ou Kit de Caça e Rastreio de Criaturas", "1 Mala de Roupas ou Mochila Comum/Maleta"], caracteristicas: [{nome: "Batedor", efeito: "Acostumado a abrir caminho para investigar planos do inimigo (Vantagem em Investigação e Furtividade quando estiver sozinho ou 20 metros separado do grupo)."}, {nome: "Médico de Combate", efeito: "Conhece procedimento que impede malefícios das pílulas de hemoglobina e suas variações e consegue aplicar em uma pessoa por dia."}, {nome: "Atirador de Elite", efeito: "Atacar alvos além da distância normal não impõe desvantagem. Ataques ignoram meia cobertura e três-quartos."}] },
                { nome: "Agente de Saúde", descricao: "Um amor pela saúde dos outros, ou ainda um compromisso com a vida (seja por promessa ou dinheiro) domina todos dessa origem.", proficiencias: "Kit Médico ou Antídoto e Medicina e Percepção", equipamento: ["Qualquer arma simples", "Kit Médico", "Kit Antídoto ou 3 pílulas de Hemoglobina variante"], caracteristicas: [{nome: "Técnica Medicinal", efeito: "Sempre que cura um personagem, você adiciona seu INTx2 no total de PV curados."}, {nome: "Primeiros Socorros", efeito: "+3 em testes para estabilizar outros personagens. Aumenta o proveito do Kit de primeiros socorros."}, {nome: "Médico Experimental", efeito: "Pode fazer qualquer antídoto com kit de primeiros socorros e algum item da natureza ao redor."}] },
                { nome: "Atleta", descricao: "Você tem um físico primoroso e bem trabalhado, você competia/compete em algum tipo de esporte, individual ou coletivo.", proficiencias: "Atletismo e Acrobacia ou Intuição ou Percepção", equipamento: ["Qualquer arma simples", "1 pílula de Hemoglobina variante: (Morfina)"], caracteristicas: [{nome: "Bolt", efeito: "Seu físico primoroso lhe permite fazer uma ação de movimento extra ou saltar em distância metade de seu deslocamento."}, {nome: "Implacável", efeito: "Se falhar em um teste de resistência, você pode rolar novamente para o teste, mas é obrigado a manter o novo resultado."}] },
                { nome: "Chef", descricao: "Um ótimo cozinheiro, com habilidades de impressionar qualquer um.", proficiencias: "Com todos os kits recebidos e Sobrevivência, Percepção e História", equipamento: ["Qualquer arma simples", "Kit de Cozinha", "Kit de Caça e Rastreio de Criaturas"], caracteristicas: [{nome: "Sabor Único", efeito: "Com os ingredientes você pode fazer qualquer um dos tipos de pratos, além de você ter um bônus de 1d6 em testes de CAR 'contra' pessoas que comeram sua comida."}, {nome: "Sabor de Casa", efeito: "Com os ingredientes certos, você pode fazer uma comida que vale por um descanso curto."}] },
                { nome: "Circense", descricao: "Você sobrevivia com base em seu corpo e suas performances, fazendo malabares, piruetas e o que mais estivesse em seu arsenal.", proficiencias: "Kit de Disfarce, Acrobacia, Atuação e Persuasão ou Enganação", equipamento: ["Qualquer arma simples", "Kit de Disfarce", "Roupa Chique"], caracteristicas: [{nome: "Performance", efeito: "Você tem +5 em acrobacia ou prestidigitação para seus números."}, {nome: "Mimetismo", efeito: "Você consegue imitar sons que já tenha escutado, incluindo vozes."}] },
                { nome: "Gamer", descricao: "Alguém que vivia em casa jogando os mais diversos jogos, talvez um famoso pro-player, talvez apenas alguém que fugia da realidade nos games.", proficiencias: "Kit de Hacker, História e Intuição", equipamento: ["Qualquer arma simples", "Dispositivo de PEM", "Computador, Celular e Pen Drive", "Kit de Hacker"], caracteristicas: [{nome: "Dormir não dá XP", efeito: "Ao invés de descansar, algumas latas de enérgico te fazem passar por um descanso normal, porém da próxima vez você precisará descansar."}, {nome: "Procrastinador", efeito: "Você é acostumado a deixar tudo para a última hora, você consegue fazer tudo na metade do tempo, mas nem sempre ficará bom."}] },
                { nome: "Investigador", descricao: "Um detetive, de renome ou não, trabalhando em busca de saber os mistérios do mundo, de casos policiais, ou daquilo que pegar mais.", proficiencias: "Kit Forense, Investigação e Atuação ou Intuição ou Percepção ou Enganação", equipamento: ["Pistola", "Kit Forense", "Ponto de rádio"], caracteristicas: [{nome: "Detetive", efeito: "O mestre sempre irá te falar uma coisa extra, sem precisar jogar investigação em toda cena de investigação."}, {nome: "Rede de Contatos", efeito: "Graças à influência da sua agência, você pode obter cinco informações por campanha sem custo."}] },
                { nome: "Piloto", descricao: "Alguém que manda muito bem no volante, um piloto de fuga, um corredor de Fórmula 1. Pra que frear se eu posso acelerar e dar um drift?", proficiencias: "Percepção, Intuição e Prestidigitação (Pilotar)", equipamento: ["Qualquer arma simples", "Moto (pode pagar a diferença para ter um carro)"], caracteristicas: [{nome: "Manobras Maníacas", efeito: "Com uma ação bônus, e desde que esteja dentro de um veículo, o jogador desvia de qualquer coisa menor que seu veículo automaticamente."}, {nome: "Piloto de Fuga", efeito: "Com uma ação normal você pressiona o acelerador como nunca, dobrando sua velocidade atual enquanto em um veículo."}, {nome: "Experiência no Volante", efeito: "Você recebe +3 em testes para pilotar."}] },
                { nome: "Religioso", descricao: "Talvez um padre, um pastor, talvez um fanático de uma religião pouco conhecida. Mas com certeza alguém a procura de mais pessoas para o seu 'culto'.", proficiencias: "Religião e História", equipamento: ["Qualquer arma simples", "Bíblia, ou qualquer outro livro sagrado"], caracteristicas: [{nome: "Pregar", efeito: "Você recebe +3 em teste de Religião para acalmar. E quando acalmar alguém, a pessoa acalmada receberá uma ação protagonista para gastar no próximo turno."}, {nome: "Orador Público", efeito: "Sempre que realizar um teste de Carisma (Persuasão) enquanto estiver falando para um grupo grande de pessoas, você adiciona o dobro do seu bônus de proficiência."}, {nome: "Benção Divina", efeito: "Após fazer uma oração a seu deus você se sente momentaneamente motivado e revigorado (seu modificador de SAB sobe um ponto)."}] },
                { nome: "Mestre de RPG", descricao: "Você viveu sua vida narrando feitos incríveis, mas cansou de contar a história dos outros e resolveu começar sua própria aventura épica.", proficiencias: "Atuação, História e Enganação", equipamento: ["Celular e Um kit de dados", "Computador", "Casaco reforçado"], caracteristicas: [{nome: "Mestre do Improviso", efeito: "Seus jogadores já botaram você em tanta enrascada que nada mais te surpreende, você se torna imune a condição 'surpreso' e tem vantagem em testes de carisma para convencer alguém de algo que você acabou de pensar."}, {nome: "Sombra do Verdadeiro Mestre", efeito: "Uma vez por missão casualmente seu personagem diz algo que vai virar verdade, você não escolhe o que será isso, tudo que seu personagem falar poderá ser escolhido pelo mestre."}] }
            ],
            inclinacoes: {
                positivas: [
                    { nome: "Aliado", custo: 1, desc: "O personagem possui um velho amigo que pode lhe oferecer ajuda, informações e abrigo caso esteja próximo de sua residência." },
                    { 
                        nome: "Contatos", 
                        custo: 1, 
                        desc: "Você tem um associado que lhe fornece informações úteis ou faz pequenos favores.",
                        hasOptions: true,
                        options: [
                            { label: "Informação rápida", custo: 1, desc: "Recebe uma informação sobre a dúvida em até 24 horas por $500." },
                            { label: "Informação de confiança", custo: 2, desc: "Recebe todas as informações disponíveis, explicando quais se podem confiar ($2000)." },
                            { label: "Informação barata", custo: 1, desc: "Diminui o custo da informação rápida de $500 para até $100." }
                        ]
                    },
                    { nome: "Corpo de Gigante", custo: 5, desc: "Você é enorme e por isso tem um nível a mais de vitalidade. +5 HP inicial e +3 por nível. O usuário tem que ficar com altura acima de 2,10m e não consegue utilizar armas leves e pequenas sem depender de uma técnica." },
                    { nome: "Empatia com Animais", custo: 1, desc: "Você é talentoso em entender o comportamento dos animais. Superando um teste de INT = 10 você compreende o estado emocional do animal - amigável, assustado, hostil, faminto, etc." },
                    { nome: "Fôlego", custo: 2, desc: "Dificilmente alguém terá sucesso te asfixiando ou afogando. Você consegue prender a respiração por 5-7 minutos fazendo esforço e 10-15 apenas nadando de forma despretensiosa ou se concentrando." },
                    { 
                        nome: "Inventor", 
                        custo: 1, 
                        desc: "Modifica equipamentos ou cria novos. Selecione os benefícios:",
                        hasOptions: true,
                        options: [
                            { label: "Propriedade de Dano", custo: 1, desc: "Dão até 1d8 de dano natural de qualquer propriedade (max. 3 propriedades)." },
                            { label: "Alcance/Alvos", custo: 1, desc: "Atingem até 2 alvos." },
                            { label: "Compacto", custo: 1, desc: "Diminuem até 4 de espaço/peso." },
                            { label: "Defensivo", custo: 1, desc: "Aumentam até 2 de CA." }
                        ]
                    },
                    { nome: "Ligação com a Máfia", custo: 3, desc: "O personagem tem certa influência com alguma família mafiosa e poderá pedir alguns favores, mas cuidado, é bom não exagerar, pois eles normalmente pedem favores em troca." },
                    { 
                        nome: "Sentidos Aguçados", 
                        custo: 1, 
                        desc: "Seus sentidos são mais desenvolvidos (+2 em testes específicos).",
                        hasOptions: true,
                        options: [
                            { label: "Audição Aguçada", custo: 1, desc: "+2 para escutar ou reparar sons incomuns (ex: engatilhar arma no escuro)." },
                            { label: "Paladar e Olfato", custo: 1, desc: "+2 para reparar gosto/cheiro. Bônus passivo antes de ingerir (evita veneno)." },
                            { label: "Tato Aguçado", custo: 1, desc: "+2 em detectar pelo toque ou Prestidigitação (ex: revistar suspeito)." },
                            { label: "Visão Aguçada", custo: 1, desc: "+2 em localizar visualmente, procurar armadilhas ou pegadas." }
                        ]
                    },
                    { nome: "Sorte Grande", custo: 3, desc: "Você pode re-rolar 1 dado por sessão ficando com o maior resultado." },
                    { nome: "Tempo de Vida Estendido (Anomalia)", custo: 3, desc: "Independente de que raça pertença, você é uma anomalia. Seu ciclo de vida se estende em uma margem de 20 anos a mais em todos os períodos de desenvolvimento após a infância." },
                    { nome: "Visão no Escuro", custo: 2, desc: "Você pode ver 9m no escuro como se fosse dia e não sofre penalidades de escuridão que não conte como bloqueio ou aplique cegueira." }
                ],
                negativas: [
                    { nome: "Avareza", valor: 2, desc: "Você fica preocupado demais em conservar sua riqueza. Você deverá procurar sempre o melhor negócio. Faça um teste de autocontrole (SAB/INT ou CAR) toda vez que tiver que gastar algum dinheiro." },
                    { nome: "Azar Grande", valor: 3, desc: "Você DEVE re-rolar seu primeiro acerto crítico no d20 da sessão." },
                    { nome: "Desatencioso", valor: 1, desc: "Você consegue entender as emoções dos outros, mas não as suas intenções. Isto faz de você desajeitado em situações envolvendo manipulação social. Você é o clássico 'nerd' e sofre -1 para usar ou resistir a Testes de Influência." },
                    { nome: "Dívida", valor: 3, desc: "Você deve um favor a alguém que te ajudou em um momento de dificuldade. Essa pessoa poderá te cobrar esse favor a qualquer momento e poderá ser qualquer coisa." },
                    { nome: "Esquecido", valor: 1, desc: "Você tem dificuldade de se recordar de nomes, lugares, aparências e informações. É bem comum causar confusão por isso." },
                    { nome: "Honestidade", valor: 2, desc: "Você precisa obedecer a lei sempre e dar o melhor de si para que os outros também o façam. Você assumirá também que os outros são honestos até saber o contrário." },
                    { nome: "Indeciso", valor: 5, desc: "Você tem muita dificuldade para se decidir, recebendo -3 em rolagens de iniciativa. Além disso, sempre que se deparar com uma escolha, faça um teste simples de INT ou CAR CD 15." },
                    { 
                        nome: "Inimigo", 
                        valor: 1, 
                        desc: "Alguém ou algo que ativamente tenta te prejudicar.",
                        hasOptions: true,
                        options: [
                             { label: "Fraco", valor: 1, desc: "Inimigo chato, objetivos estúpidos, aparece para atrapalhar (Ex: Equipe Rocket)." },
                             { label: "Rival", valor: 2, desc: "Inimigo mediano, mesmos objetivos que você, fará de tudo para atrapalhar inclusive lutar." },
                             { label: "Poderoso", valor: 5, desc: "Chefão maligno. Te caça para recrutar ou matar sem piedade." }
                        ]
                    },
                    { nome: "Inveja", valor: 1, desc: "Você tem uma reação muito ruim frente a qualquer um que pareça mais inteligente, mais atraente, poderoso ou em melhor situação do que a sua!" },
                    { nome: "Perda Auditiva", valor: 1, desc: "Você não é surdo, mas perdeu uma parte da audição e sofrerá um redutor de -3 em qualquer teste de Audição." },
                    { nome: "Veracidade", valor: 2, desc: "Você odeia dizer uma mentira ou o faz muito mal. Ter que mentir pode fazer literalmente você ficar enjoado ou com peso na consciência (Condição Envenenado ou -5 Sanidade)." }
                ]
            },
            skills: [
                'TR de FOR', 'TR de DES', 'TR de CON', 'TR de INT', 'TR de SAB', 'TR de CAR',
                'Acrobacia', 'Arcanismo', 'Atletismo', 'Atuação', 'Enganação',
                'Furtividade', 'História', 'Intimidação', 'Intuição', 'Investigação',
                'Lidar com Animais', 'Medicina', 'Natureza', 'Percepção', 'Persuasão',
                'Prestidigitação', 'Religião', 'Sobrevivência'
            ],
            otherSkills: [
                'Armas Marciais corpo-a-corpo',
                'Armas Marciais à distância',
                'Armas Simples corpo-a-corpo',
                'Armas Simples à distância',
                'Equipamentos de Proteção e Armaduras Médias',
                'Equipamentos de Proteção e Armaduras Pesadas',
                'Equipamentos Improvisados/Manufaturados (Bugigangas e Armas de Hatsus criativos)',
                'Científicas/Explosivas',
                'Linguas Antigas e Culturas',
                'Armas de Cerco',
                'Kits'
            ],
            pointBuyCosts: { 30:50, 29:47, 28:44, 27:41, 26:38, 25:35, 24:32, 23:29, 22:26, 21:23, 20:20, 19:17, 18:14, 17:11, 16:8, 15:6, 14:4, 13:3, 12:2, 11:1, 10:0, 9:-1, 8:-2, 7:-4, 6:-6, 5:-8, 4:-11, 3:-14, 2:-17, 1:-20 }
        };

        const SKILL_MAP = {
            'FOR': ['Atletismo'],
            'DES': ['Acrobacia', 'Furtividade', 'Prestidigitação'],
            'CON': [],
            'INT': ['Arcanismo', 'História', 'Investigação', 'Natureza', 'Religião'],
            'SAB': ['Lidar com Animais', 'Intuição', 'Medicina', 'Percepção', 'Sobrevivência'],
            'CAR': ['Atuação', 'Enganação', 'Intimidação', 'Persuasão']
        };

        // --- ESTADO GLOBAL ---
        const state = {
            view: 'LIST', // LIST, CREATOR, SHEET
            activeTab: 'FICHA',
            characters: [],
            currentChar: null,
            creatorStep: 0,
            tempChar: null, // Usado no criador
            attrTab: 'ROLAGEM',
            attrMethodLocked: false,
            attrPool: [], 
            selectedPoolIdx: null,
            draggedPoolIdx: null,
            openSkillAccordion: null, // Inicia fechado
            openAttrPopup: null, // Popup de atributo na ficha
            skillSelectionModal: null, // Modal de decisão de proficiência
            clickTimer: null, // Para diferenciar clique unico e duplo
            bgSelected: null, // Para controle de UI do antecedente
            rollMode: 'NORMAL', // NORMAL, VANTAGEM, DESVANTAGEM, ENFASE
            allocations: {}, // Alocações de bônus raciais
            sheetOtherSkillsOpen: null // Estado do acordeão de Outros Treinamentos na ficha
        };

        // --- GERENCIAMENTO DE STORAGE ---
        function loadCharacters() {
            const chars = [];
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('hxhrpg_')) {
                    try { chars.push(JSON.parse(localStorage.getItem(key))); } catch(e) {}
                }
            }
            state.characters = chars.sort((a,b) => new Date(b.lastMod) - new Date(a.lastMod));
        }

        function saveCharacter(char) {
            char.lastMod = new Date().toISOString();
            localStorage.setItem('hxhrpg_' + char.id, JSON.stringify(char));
            loadCharacters();
        }

        function deleteCharacter(id) {
            if(confirm('Tem certeza que deseja apagar esta ficha?')) {
                localStorage.removeItem('hxhrpg_' + id);
                loadCharacters();
                if (state.currentChar && state.currentChar.id === id) {
                    state.view = 'LIST';
                    state.currentChar = null;
                }
                render();
            }
        }

        // --- UTILITÁRIOS ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function getMod(val) { return val ? Math.floor((val - 10) / 2) : 0; }
        function getModStr(val) { const m = getMod(val); return m >= 0 ? `+${m}` : `${m}`; }
        function getPointBuyCost(val) { return SYSTEM_DB.pointBuyCosts[val] !== undefined ? SYSTEM_DB.pointBuyCosts[val] : 0; }
        function getProficiencyBonus(level) { return Math.max(2, Math.floor((level - 1) / 4) + 2); }
        
        function calculateTotalCost(attrs) {
            let total = 0;
            Object.values(attrs).forEach(val => { total += getPointBuyCost(val); });
            return total;
        }

        function setThemeColor(hex) {
            document.documentElement.style.setProperty('--theme-color-hex', hex);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if(result) {
                const r = parseInt(result[1], 16);
                const g = parseInt(result[2], 16);
                const b = parseInt(result[3], 16);
                document.documentElement.style.setProperty('--theme-rgb', `${r}, ${g}, ${b}`);
            }
        }

        function getNenPercentages(selectedId) {
            const types = ['INTENSIFICAÇÃO', 'TRANSFORMAÇÃO', 'MATERIALIZAÇÃO', 'ESPECIALIZAÇÃO', 'MANIPULAÇÃO', 'EMISSÃO'];
            const selectedIndex = types.indexOf(selectedId);
            const matrix = {};
            types.forEach((type, index) => {
                let diff = Math.abs(index - selectedIndex);
                if (diff > 3) diff = 6 - diff;
                let pct = 0;
                if (diff === 0) pct = 100; else if (diff === 1) pct = 80; else if (diff === 2) pct = 60; else if (diff === 3) pct = 40;
                if (type === 'ESPECIALIZAÇÃO' && diff !== 0) {
                    pct = 0;
                    if (selectedId === 'MATERIALIZAÇÃO' || selectedId === 'MANIPULAÇÃO') pct = 1;
                }
                matrix[type] = pct;
            });
            return matrix;
        }

        // --- DRAG AND DROP HANDLERS ---
        window.handleDragStart = (e, idx) => {
            state.draggedPoolIdx = idx;
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('dragging');
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            e.currentTarget.classList.add('drop-zone-active');
        };

        window.handleDragLeave = (e) => {
            e.currentTarget.classList.remove('drop-zone-active');
        };

        window.handleDrop = (e, attr) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-zone-active');
            if (state.draggedPoolIdx !== null) {
                state.selectedPoolIdx = state.draggedPoolIdx;
                assignToSlot(attr);
                state.draggedPoolIdx = null;
            }
        };

        // --- HELPER DE BÔNUS RACIAL ---
        function getBonusRequirements(raceName) {
            const r = SYSTEM_DB.racas.find(x => x.nome === raceName);
            if (!r) return null;
            
            if (r.aumento_atributo === "Distribua 3 pontos em qualquer atributo") {
                return { type: 'wildcard', amount: 3 };
            }
            if (r.aumento_atributo === "Escolha +2") {
                return { type: 'wildcard', amount: 2 };
            }
            if (typeof r.aumento_atributo === 'object') {
                if (r.aumento_atributo.INT_ou_SAB) {
                    return { type: 'choice', keys: ['INT', 'SAB'], amount: r.aumento_atributo.INT_ou_SAB };
                }
                if (r.aumento_atributo.Físico) {
                    // Caso específico para Vampiros ou similares
                    return { type: 'choice', keys: ['FOR', 'DES', 'CON'], amount: r.aumento_atributo.Físico };
                }
            }
            return null;
        }

        function getAllocatedTotal() {
            return Object.values(state.allocations).reduce((a, b) => a + b, 0);
        }

        function updateAllocation(attr, delta, limit) {
            const current = state.allocations[attr] || 0;
            const total = getAllocatedTotal();
            
            // Check limits
            if (delta > 0 && total >= limit) return;
            if (delta < 0 && current <= 0) return;
            
            state.allocations[attr] = current + delta;
            render();
        }

        function updateChoiceAllocation(attr, amount) {
            // Reset other allocations for choice type
            state.allocations = { [attr]: amount };
            render();
        }

        // --- RENDERIZADORES ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.view === 'LIST') renderList(app);
            else if (state.view === 'CREATOR') renderCreator(app);
            else if (state.view === 'SHEET') renderSheet(app);
            if (window.lucide) lucide.createIcons();
        }

        function renderList(container) {
            setThemeColor('#00ff9d');
            const level0 = state.characters.filter(c => c.level === 0);
            const levelHigh = state.characters.filter(c => c.level > 0);
            let html = `
                <div class="p-6 flex flex-col h-full">
                    <div class="text-center mb-8 mt-4">
                        <h1 class="font-display font-black text-3xl tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">HxH 5e RPG</h1>
                        <p class="text-xs text-gray-500 uppercase tracking-widest font-bold">Banco de Dados</p>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar space-y-8 pb-20">
            `;
            html += `<div><div class="flex items-center gap-2 mb-3"><i data-lucide="circle-dashed" class="text-gray-500 w-4 h-4"></i><h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Iniciantes (Nível 0)</h2></div>`;
            if (level0.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhuma ficha de nível 0 encontrada.</div>`;
            else {
                level0.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-gray-600 transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')"><div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="user" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">${char.race} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div><div><div class="flex items-center gap-2 mb-3"><i data-lucide="zap" class="text-neon-green w-4 h-4"></i><h2 class="text-xs font-bold text-neon-green uppercase tracking-widest">Usuários de Nen (Nível 1-12)</h2></div>`;
            if (levelHigh.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhum Hunter registrado.</div>`;
            else {
                levelHigh.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-[${color}] transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')" style="border-left: 3px solid ${color}"><div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="shield" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">LVL ${char.level} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div></div><div class="fixed bottom-0 left-0 right-0 p-4 pb-safe bg-gradient-to-t from-black to-transparent max-w-[480px] mx-auto"><button onclick="startCreator()" class="w-full py-4 bg-neon-green text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 shadow-[0_0_20px_rgba(0,255,157,0.4)] transition-all flex items-center justify-center gap-2"><i data-lucide="plus"></i> CRIAR NOVA FICHA</button></div></div>`;
            container.innerHTML = html;
        }

        function renderCreator(container) {
             if (!state.tempChar) { state.tempChar = { name: '', class: 'INTENSIFICAÇÃO', race: 'Humano Comum', attributes: { FOR:10, DES:10, CON:10, INT:10, SAB:10, CAR:10 }, skills: [], otherSkills: [], raceTraits: [], background: null, backgroundFeature: null, inclinations: { positive: [], negative: [] } }; }
            const step = state.creatorStep;
            
            // GARANTIR TEMA (PERSISTÊNCIA DE COR)
            let themeColorHex = '#00ff9d';
            if (state.tempChar && state.tempChar.class) {
                const clsTheme = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class);
                if (clsTheme) {
                    setThemeColor(clsTheme.color);
                    themeColorHex = clsTheme.color;
                }
            }

            let contentHtml = '';
            let title = '';

            if (step === 0) {
                 title = 'IDENTIDADE';
                const percentages = getNenPercentages(state.tempChar.class);
                const currentClass = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class);
                const hexNodes = SYSTEM_DB.classes.map(c => {
                    const isSelected = state.tempChar.class === c.id;
                    const pct = percentages[c.id];
                    const rad = (c.angle * Math.PI) / 180;
                    const radius = 35; 
                    const left = 50 + (radius * Math.cos(rad));
                    const top = 50 + (radius * Math.sin(rad));
                    const nodeStyle = isSelected ? `background-color: ${c.color}; border-color: ${c.color}; color: #000; box-shadow: 0 0 20px ${c.color}80;` : `background-color: #0a0a0f; border-color: ${c.color}; color: ${c.color};`;
                    const transformScale = isSelected ? 'scale(1.15)' : 'scale(1.0)';
                    const zIndex = isSelected ? 'z-10' : 'z-0';
                    return `<div class="absolute w-20 h-20 flex items-center justify-center cursor-pointer nen-node ${zIndex}" style="top: ${top}%; left: ${left}%; transform: translate(-50%, -50%) ${transformScale};" onclick="selectNenType('${c.id}')"><div class="w-14 h-14 rounded-full border-2 flex items-center justify-center transition-all duration-300 relative shadow-lg" style="${nodeStyle}"><span class="font-display font-bold text-lg leading-none">${pct}%</span></div></div>`;
                }).join('');
                contentHtml = `<div class="space-y-6"><div class="relative"><label class="text-[10px] font-bold text-neon-theme uppercase tracking-widest mb-2 block pl-2">Nome do Candidato</label><input type="text" id="creator-name" value="${state.tempChar.name}" placeholder="INSIRA SEU NOME..." class="w-full bg-gray-900 border border-gray-700 rounded-xl p-4 text-white text-center font-display font-bold tracking-wider focus:border-neon-theme focus:shadow-[0_0_15px_rgba(var(--theme-rgb),0.2)] transition-all uppercase placeholder-gray-600" oninput="state.tempChar.name = this.value"></div><div class="text-center transition-all"><h3 class="text-3xl font-display font-black tracking-widest uppercase drop-shadow-[0_0_15px_rgba(var(--theme-rgb),0.6)]" style="color: ${currentClass.color}; text-shadow: 0 0 10px ${currentClass.color}40;">${state.tempChar.class}</h3></div><div class="bg-gray-900/20 rounded-full border border-gray-800/50 p-4 aspect-square relative max-w-[360px] mx-auto"><svg class="absolute inset-0 w-full h-full pointer-events-none opacity-30" viewBox="0 0 100 100"><polygon points="50,15 80.3,32.5 80.3,67.5 50,85 19.7,67.5 19.7,32.5" fill="none" stroke="currentColor" stroke-width="0.8" class="text-white" /><line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="32.5" x2="19.7" y2="67.5" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="67.5" x2="19.7" y2="32.5" stroke="currentColor" stroke-width="0.5" class="text-white" /></svg>${hexNodes}</div><div class="text-center px-4 bg-gray-900/50 p-3 rounded-xl border border-gray-800/50"><p class="text-sm font-medium text-gray-300 italic">"${currentClass.desc}"</p></div></div>`;
            } else if (step === 1) {
                title = 'RAÇA';
                contentHtml = `<div class="space-y-4">`;
                let lastCat = '';
                SYSTEM_DB.racas.forEach(r => {
                    if (r.categoria && r.categoria !== lastCat) {
                        contentHtml += `<div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-4 mb-2 pl-2">${r.categoria}</div>`;
                        lastCat = r.categoria;
                    }
                    const isSelected = state.tempChar.race === r.nome;
                    const borderColor = isSelected ? 'border-neon-theme ring-2 ring-neon-theme/20' : 'border-gray-800';
                    const bgColor = isSelected ? 'bg-neon-theme/5' : 'bg-gray-900';
                    const textColor = isSelected ? 'text-neon-theme' : 'text-white';
                    
                    let attrHtml = typeof r.aumento_atributo === 'object' ? Object.entries(r.aumento_atributo).map(([k,v]) => `<span class="bg-gray-900 border border-gray-700 rounded-full px-3 py-1 text-[10px] font-bold text-gray-300 shadow-sm flex items-center gap-1">${k.replace(/_/g, ' ')} <span class="${v>0?'text-neon-theme':'text-red-500'}">${v>0?'+':''}${v}</span></span>`).join('') : `<span class="text-xs text-gray-400 italic">${r.aumento_atributo}</span>`;
                    
                    let featuresHtml = '';
                    if (r.nome === 'Formiga Quimera') {
                         const selectedCount = (state.tempChar.raceTraits || []).length;
                         const maxTraits = 3;
                         featuresHtml = `<div class="mb-4"><h4 class="text-[10px] font-black text-neon-theme uppercase tracking-widest mb-2 flex justify-between">Características da Espécie <span id="trait-counter" class="${selectedCount >= maxTraits ? 'text-neon-theme' : 'text-gray-500'}">(${selectedCount}/${maxTraits})</span></h4><div class="bg-gray-950/50 rounded-lg p-2 border border-gray-800/50 grid grid-cols-1 gap-2">${r.caracteristicas.map(f => {
                                const isTraitSelected = (state.tempChar.raceTraits || []).includes(f.nome);
                                return `<div id="trait-btn-${f.nome.replace(/\s/g,'-')}" onclick="event.stopPropagation(); toggleRaceTrait('${f.nome}')" class="p-2 rounded border cursor-pointer transition-all flex items-start gap-2 ${isTraitSelected ? 'bg-neon-theme/10 border-neon-theme text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}"><div class="mt-0.5 pointer-events-none">${isTraitSelected ? '<i data-lucide="check-square" size="14"></i>' : '<i data-lucide="square" size="14"></i>'}</div><div class="pointer-events-none"><span class="text-[10px] font-bold block">${f.nome}</span><span class="text-[9px] block leading-tight opacity-70">${f.efeito || f.mecanica || ''}</span></div></div>`;
                            }).join('')}</div></div>`;
                    } else {
                        const features = [...(r.caracteristicas || []), ...(r.opcoes_caracteristica || [])];
                        if (features.length > 0) featuresHtml = `<div class="mb-4"><h4 class="text-[10px] font-black text-neon-theme uppercase tracking-widest mb-2">Características</h4><div class="bg-gray-950/50 rounded-lg p-3 border border-gray-800/50">${features.map(f => `<div class="mb-2 last:mb-0"><span class="text-[11px] font-bold text-gray-300 block">${f.nome}</span><span class="text-[10px] text-gray-500 block leading-tight">${f.efeito || f.mecanica || ''} ${f.tabela_ancestral ? '('+f.tabela_ancestral+')' : ''}</span></div>`).join('')}</div></div>`;
                    }
                    
                    const checkIcon = `<span id="check-${r.nome.replace(/\s/g,'-')}" class="transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'} flex items-center"><i data-lucide="check" size="16"></i></span>`;
                    const chevronClass = isSelected ? 'rotate-0' : '-rotate-90';

                    contentHtml += `
                    <div id="race-card-${r.nome.replace(/\s/g,'-')}" onclick="selectRace('${r.nome}')" class="w-full text-left rounded-2xl border ${borderColor} ${bgColor} transition-all duration-300 cursor-pointer group relative overflow-hidden mb-2">
                        <div class="p-4 flex items-start justify-between">
                            <div><h3 class="font-display font-bold text-lg uppercase tracking-wider ${textColor} flex items-center gap-2">${r.nome} ${checkIcon}</h3><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1 pr-6 leading-tight">${r.descricao}</p></div>
                            <div id="chevron-${r.nome.replace(/\s/g,'-')}" class="transition-transform duration-300 ${chevronClass} ${isSelected ? 'text-neon-theme' : 'text-gray-600'}"><i data-lucide="chevron-down" size="20"></i></div>
                        </div>
                        <div id="race-content-${r.nome.replace(/\s/g,'-')}" class="accordion-content px-4 ${isSelected ? 'open pb-4' : ''}"><div class="h-px w-full bg-gray-800 mb-4"></div><div class="mb-4"><h4 class="text-[10px] font-black text-neon-theme uppercase tracking-widest mb-2">Bônus de Atributo</h4><div class="flex flex-wrap gap-2">${attrHtml}</div></div>${featuresHtml}<div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500"><div class="col-span-2 text-right italic text-gray-600">Fonte: ${r.fonte}</div></div></div>
                    </div>`;
                });
                contentHtml += `</div>`;
            } else if (step === 2) {
                title = 'ATRIBUTOS';
                const totalCost = calculateTotalCost(state.tempChar.attributes);
                const maxCost = 20;

                const tabBtn = (id, label, icon) => {
                    const isActive = state.attrTab === id;
                    const isLocked = state.attrMethodLocked && !isActive;
                    let baseClasses = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest border rounded-lg transition-all flex items-center justify-center gap-2";
                    let stateClasses = isActive ? "bg-neon-theme/20 border-neon-theme text-neon-theme shadow-[0_0_10px_rgba(var(--theme-rgb),0.2)]" : (isLocked ? "bg-gray-900 border-gray-800 text-gray-600 opacity-50 cursor-not-allowed" : "bg-gray-900 border-gray-800 text-gray-500 hover:text-gray-300 cursor-pointer");
                    return `<button onclick="${isLocked ? '' : `setAttrTab('${id}')`}" class="${baseClasses} ${stateClasses}">${isLocked ? '<i data-lucide="lock" size="14"></i>' : `<i data-lucide="${icon}" size="14"></i>`} ${label}</button>`;
                };

                contentHtml = `<div class="space-y-6"><div class="bg-[#2a0e14] border border-neon-red/30 p-4 rounded-xl text-center relative overflow-hidden shadow-[0_0_15px_rgba(255,0,85,0.1)]"><p class="text-[10px] text-neon-red font-bold uppercase tracking-widest flex items-center justify-center gap-2 relative z-10"><i data-lucide="alert-triangle" size="14"></i> Atenção: Apenas um modo pode ser escolhido. Ao iniciar, os outros serão bloqueados.</p></div><div class="flex gap-2 p-1 bg-gray-900 rounded-xl border border-gray-800">${tabBtn('ROLAGEM', 'Rolagem', 'dices')}${tabBtn('ARRAY', 'Média', 'list')}${tabBtn('COMPRA', 'Compra', 'coins')}</div>`;

                if (state.attrTab === 'ROLAGEM' || state.attrTab === 'ARRAY') {
                    contentHtml += `<div class="space-y-4">${!state.attrMethodLocked ? (state.attrTab === 'ROLAGEM' ? `<button onclick="rollAllStats()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl font-display font-bold text-white tracking-widest hover:brightness-110 active:scale-95 transition-all shadow-lg flex items-center justify-center gap-2 border border-white/10"><i data-lucide="dices"></i> ROLAR ATRIBUTOS</button>` : `<button onclick="applyStandardArray()" class="w-full py-4 bg-neon-blue/10 text-neon-blue border border-neon-blue/50 rounded-xl font-display font-bold tracking-widest hover:bg-neon-blue hover:text-black active:scale-95 transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(0,240,255,0.2)]"><i data-lucide="list"></i> USAR MÉDIA PADRÃO</button>`) : ''}${state.attrMethodLocked ? `<div class="bg-gray-900/50 border border-gray-700 rounded-xl p-4"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 text-center">Banco de Atributos</p>${state.attrPool.length === 0 ? '<div class="text-center text-xs text-gray-600 py-2 italic">Todos os valores alocados.</div>' : `<div class="flex flex-wrap gap-2 justify-center">${state.attrPool.map((val, idx) => `<button draggable="true" ondragstart="handleDragStart(event, ${idx})" ondragend="handleDragEnd(event)" onclick="selectPoolItem(${idx})" class="w-10 h-10 rounded-lg font-display font-bold text-lg flex items-center justify-center transition-all cursor-move ${state.selectedPoolIdx === idx ? 'bg-neon-theme text-black shadow-[0_0_10px_var(--theme-color-hex)] scale-110' : 'bg-gray-800 text-white hover:bg-gray-700'}">${val}</button>`).join('')}</div>`}<p class="text-[9px] text-gray-500 text-center mt-3">${state.selectedPoolIdx !== null ? 'Selecione um atributo abaixo para aplicar.' : 'Clique em um número para selecionar ou arraste para um slot.'}</p></div>` : ''}</div>`;
                } else if (state.attrTab === 'COMPRA') {
                     contentHtml += `<div id="buy-container" class="bg-gray-900 border border-gray-800 p-4 rounded-xl relative overflow-hidden"><div class="flex justify-between items-center relative z-10"><span class="text-xs text-gray-400 uppercase font-bold tracking-widest">Pontos Gastos</span><div class="flex items-center gap-1"><span id="buy-total" class="font-display font-bold text-2xl ${totalCost > maxCost ? 'text-red-500' : 'text-white'} transition-all">${totalCost}</span><span class="font-display text-gray-600 text-lg">/ ${maxCost}</span></div></div><div class="absolute bottom-0 left-0 h-1 bg-gray-800 w-full"><div id="buy-bar" class="h-full ${totalCost > maxCost ? 'bg-red-500' : 'bg-neon-theme'} transition-all duration-300" style="width: ${Math.min(100, (totalCost/maxCost)*100)}%"></div></div></div>`;
                }

                contentHtml += `<div class="grid grid-cols-2 gap-3">${Object.keys(state.tempChar.attributes).map(attr => {
                    const val = state.tempChar.attributes[attr];
                    const isPoolMode = state.attrTab !== 'COMPRA';
                    const dndAttrs = isPoolMode ? `ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${attr}')"` : '';
                    return `<div ${dndAttrs} class="bg-gray-900 rounded-xl p-3 border transition-all relative overflow-hidden group ${state.selectedPoolIdx !== null && isPoolMode ? 'border-neon-theme/50 cursor-pointer hover:border-neon-theme' : 'border-gray-800'} ${val === null && isPoolMode ? 'border-dashed' : ''}" onclick="${isPoolMode ? (val === null ? `assignToSlot('${attr}')` : `returnToPool('${attr}')`) : ''}"><div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${attr}</span>${val !== null ? `<span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 rounded border border-gray-700">Mod ${getModStr(val)}</span>` : ''}</div>${state.attrTab === 'COMPRA' ? `<div class="flex items-center justify-between"><button onclick="buyStat('${attr}', -1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="minus" size="14"></i></button><span id="attr-val-${attr}" class="text-xl font-display font-bold text-white transition-all">${val}</span><button onclick="buyStat('${attr}', 1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="plus" size="14"></i></button></div><div class="text-center mt-1"><span class="text-[8px] text-gray-600">Custo: ${getPointBuyCost(val)}</span></div>` : `<div class="text-center py-1 h-10 flex items-center justify-center pointer-events-none">${val !== null ? `<span class="text-3xl font-display font-bold text-white transition-colors">${val}</span>` : `<span class="text-[10px] text-gray-700 uppercase font-bold tracking-widest">Vazio</span>`}</div>${isPoolMode && val !== null ? '<div class="absolute inset-0 bg-red-500/10 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity pointer-events-none"><i data-lucide="x" class="text-red-500"></i></div>' : ''}`}</div>`;
                }).join('')}</div></div>`;
            } else if (step === 3) {
                 title = 'ANTECEDENTE';
                contentHtml = `<div class="space-y-4">`;
                SYSTEM_DB.antecedentes.forEach(bg => {
                    const isSelected = state.tempChar.background === bg.nome;
                    const borderColor = isSelected ? 'border-neon-theme ring-2 ring-neon-theme/20' : 'border-gray-800';
                    const bgColor = isSelected ? 'bg-neon-theme/5' : 'bg-gray-900';
                    const textColor = isSelected ? 'text-neon-theme' : 'text-white';
                    
                    const checkIcon = `<span class="transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'} flex items-center"><i data-lucide="check" size="16" class="text-neon-theme"></i></span>`;
                    const chevronClass = isSelected ? 'rotate-0' : '-rotate-90';

                    contentHtml += `
                    <div id="bg-card-${bg.nome.replace(/\s/g,'-')}" onclick="selectBackground('${bg.nome}')" class="w-full text-left rounded-2xl border ${borderColor} ${bgColor} transition-all duration-300 cursor-pointer group relative overflow-hidden mb-2">
                        <div class="p-4 flex items-start justify-between">
                            <div><h3 class="font-display font-bold text-lg uppercase tracking-wider ${textColor} flex items-center gap-2">${bg.nome} ${checkIcon}</h3><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1 pr-6 leading-tight line-clamp-2">${bg.descricao}</p></div>
                            <div class="transition-transform duration-300 ${chevronClass} ${isSelected ? 'text-neon-theme' : 'text-gray-600'}"><i data-lucide="chevron-down" size="20"></i></div>
                        </div>
                        <div class="accordion-content px-4 ${isSelected ? 'open pb-4' : ''}">
                            <div class="h-px w-full bg-gray-800 mb-4"></div>
                            <p class="text-xs text-gray-400 italic mb-4">"${bg.descricao}"</p>
                            
                            <div class="bg-gray-950/50 border border-cyan-500/30 rounded-xl p-3 mb-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                                <h4 class="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-1 flex items-center gap-2"><i data-lucide="graduation-cap" size="12"></i> Proficiências</h4>
                                <p class="text-xs text-gray-300 font-bold">${bg.proficiencias}</p>
                                <p class="text-[10px] text-gray-500 italic mt-1">Estas perícias serão adicionadas automaticamente.</p>
                            </div>

                            <div class="bg-gray-950/50 border border-green-500/30 rounded-xl p-3 mb-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                <h4 class="text-[10px] font-black text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="backpack" size="12"></i> Equipamento</h4>
                                <div class="space-y-1">
                                    ${bg.equipamento.map(item => `<div class="bg-gray-900 border border-gray-800 px-2 py-1 rounded text-[10px] text-gray-300 font-mono">${item}</div>`).join('')}
                                </div>
                            </div>

                            <div class="bg-gray-950/50 border border-purple-500/30 rounded-xl p-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                                <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="star" size="12"></i> Escolha uma Característica</h4>
                                <div class="space-y-2">
                                    ${bg.caracteristicas.map(c => `
                                        <label class="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors">
                                            <div class="relative flex items-center mt-0.5">
                                                <input type="radio" name="bg-feature" value="${c.nome}" class="peer sr-only" onclick="selectBackgroundFeature('${c.nome}')" ${state.tempChar.backgroundFeature === c.nome ? 'checked' : ''}>
                                                <div class="w-4 h-4 border-2 border-gray-600 rounded-full peer-checked:border-purple-500 peer-checked:bg-purple-500/20 transition-all flex items-center justify-center">
                                                    <div class="w-2 h-2 rounded-full bg-transparent peer-checked:bg-purple-500 transition-colors radio-indicator"></div>
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <span class="text-xs font-bold text-white block ${state.tempChar.backgroundFeature === c.nome ? 'text-purple-400' : ''}">${c.nome}</span>
                                                <span class="text-[10px] text-gray-500 leading-tight block">${c.efeito}</span>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                contentHtml += `</div>`;
            } else if (step === 4) {
                  title = 'INCLINAÇÃO';
                const posCost = state.tempChar.inclinations.positive.reduce((acc, i) => acc + i.custo, 0);
                const negVal = state.tempChar.inclinations.negative.reduce((acc, i) => acc + i.valor, 0);
                const sortedPos = [...state.tempChar.inclinations.positive].sort((a,b) => b.custo - a.custo);
                const freeCost = sortedPos.length > 0 ? sortedPos[0].custo : 0;
                const paidCost = Math.max(0, posCost - freeCost);
                const balance = (negVal) - paidCost; 
                const isOk = balance >= 0;

                contentHtml = `
                <div class="space-y-6">
                    <div class="grid grid-cols-3 gap-2 bg-gray-900 border border-gray-800 rounded-xl p-3">
                        <div class="text-center border-r border-gray-800">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block">Custo Positivo</span>
                            <span class="text-xl font-display font-bold text-white">${posCost} <span class="text-[10px] text-gray-600">pts</span></span>
                        </div>
                        <div class="text-center border-r border-gray-800">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block">Compensação</span>
                            <div class="flex items-center justify-center gap-2">
                                <i data-lucide="scale" size="16" class="${isOk ? 'text-neon-green' : 'text-neon-red'}"></i>
                                <span class="text-xl font-display font-bold ${isOk ? 'text-neon-green' : 'text-neon-red'}">${isOk ? 'OK' : balance}</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block">Pontos Neg.</span>
                            <span class="text-xl font-display font-bold text-neon-red">${negVal} <span class="text-[10px] text-gray-600">/ 10</span></span>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-xs font-black text-neon-green uppercase tracking-widest flex items-center gap-2"><i data-lucide="thumbs-up" size="14"></i> Gerais Positivas</h4>
                            <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded border border-gray-700">1ª Grátis (Maior Valor)</span>
                        </div>
                        <div class="space-y-2">
                            ${SYSTEM_DB.inclinacoes.positivas.map(inc => {
                                if (inc.hasOptions) {
                                     const hasChildSelected = state.tempChar.inclinations.positive.some(i => i.nome.startsWith(inc.nome + ':'));
                                     return `
                                     <div class="bg-gray-900 border ${hasChildSelected ? 'border-neon-green/50' : 'border-gray-800'} rounded-xl p-3 relative overflow-hidden">
                                        <div class="mb-2 border-b border-gray-800 pb-2">
                                            <span class="text-xs font-bold text-white flex items-center gap-2">
                                                ${inc.nome}
                                                ${hasChildSelected ? '<span class="text-[9px] bg-neon-green/10 text-neon-green px-1.5 rounded border border-neon-green/20 uppercase">Selecionado</span>' : ''}
                                            </span>
                                            <p class="text-[10px] text-gray-500 leading-tight mt-1 line-clamp-2">${inc.desc}</p>
                                        </div>
                                        <div class="space-y-1 pl-2 border-l-2 border-gray-800">
                                            ${inc.options.map(opt => {
                                                const fullName = `${inc.nome}: ${opt.label}`;
                                                const isSelected = state.tempChar.inclinations.positive.some(i => i.nome === fullName);
                                                return `
                                                <div onclick="toggleInclination('positive', '${fullName}', ${opt.custo})" class="flex justify-between items-center p-2 rounded cursor-pointer hover:bg-white/5 transition-colors ${isSelected ? 'bg-neon-green/10' : ''}">
                                                    <div class="flex flex-col">
                                                        <span class="text-[11px] font-bold ${isSelected ? 'text-neon-green' : 'text-gray-300'}">${opt.label}</span>
                                                        ${opt.desc ? `<span class="text-[9px] text-gray-500 line-clamp-1">${opt.desc}</span>` : ''}
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-[9px] font-mono text-gray-500">${opt.custo} pts</span>
                                                        ${isSelected ? '<i data-lucide="check" size="12" class="text-neon-green"></i>' : '<div class="w-3 h-3"></div>'}
                                                    </div>
                                                </div>`;
                                            }).join('')}
                                        </div>
                                     </div>`;
                                } else {
                                    const isSelected = state.tempChar.inclinations.positive.some(i => i.nome === inc.nome);
                                    return `
                                    <div onclick="toggleInclination('positive', '${inc.nome}', ${inc.custo})" class="bg-gray-900 border ${isSelected ? 'border-neon-green shadow-[0_0_10px_rgba(0,255,157,0.2)]' : 'border-gray-800'} rounded-xl p-3 cursor-pointer transition-all hover:border-gray-600 group relative overflow-hidden">
                                        ${isSelected ? '<div class="absolute top-0 right-0 p-1"><i data-lucide="check" size="14" class="text-neon-green"></i></div>' : ''}
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="text-xs font-bold ${isSelected ? 'text-neon-green' : 'text-white'}">${inc.nome}</span>
                                            <span class="text-[10px] font-mono bg-black/50 px-1.5 rounded text-gray-400 border border-gray-700">${inc.custo} pts</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 leading-tight group-hover:text-gray-400 transition-colors line-clamp-2">${inc.desc}</p>
                                    </div>`;
                                }
                            }).join('')}
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-black text-neon-red uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="thumbs-down" size="14"></i> Gerais Negativas</h4>
                        <div class="space-y-2">
                            ${SYSTEM_DB.inclinacoes.negativas.map(inc => {
                                if (inc.hasOptions) {
                                    const hasChildSelected = state.tempChar.inclinations.negative.some(i => i.nome.startsWith(inc.nome + ':'));
                                     return `
                                     <div class="bg-gray-900 border ${hasChildSelected ? 'border-neon-red/50' : 'border-gray-800'} rounded-xl p-3 relative overflow-hidden">
                                        <div class="mb-2 border-b border-gray-800 pb-2">
                                            <span class="text-xs font-bold text-white flex items-center gap-2">
                                                ${inc.nome}
                                                ${hasChildSelected ? '<span class="text-[9px] bg-neon-red/10 text-neon-red px-1.5 rounded border border-neon-red/20 uppercase">Selecionado</span>' : ''}
                                            </span>
                                            <p class="text-[10px] text-gray-500 leading-tight mt-1 line-clamp-2">${inc.desc}</p>
                                        </div>
                                        <div class="space-y-1 pl-2 border-l-2 border-gray-800">
                                            ${inc.options.map(opt => {
                                                const fullName = `${inc.nome}: ${opt.label}`;
                                                const isSelected = state.tempChar.inclinations.negative.some(i => i.nome === fullName);
                                                return `
                                                <div onclick="toggleInclination('negative', '${fullName}', ${opt.valor})" class="flex justify-between items-center p-2 rounded cursor-pointer hover:bg-white/5 transition-colors ${isSelected ? 'bg-neon-red/10' : ''}">
                                                    <div class="flex flex-col">
                                                        <span class="text-[11px] font-bold ${isSelected ? 'text-neon-red' : 'text-gray-300'}">${opt.label}</span>
                                                        ${opt.desc ? `<span class="text-[9px] text-gray-500 line-clamp-1">${opt.desc}</span>` : ''}
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-[9px] font-mono text-gray-500">+${opt.valor} pts</span>
                                                        ${isSelected ? '<i data-lucide="check" size="12" class="text-neon-red"></i>' : '<div class="w-3 h-3"></div>'}
                                                    </div>
                                                </div>`;
                                            }).join('')}
                                        </div>
                                     </div>`;
                                } else {
                                    const isSelected = state.tempChar.inclinations.negative.some(i => i.nome === inc.nome);
                                    return `
                                    <div onclick="toggleInclination('negative', '${inc.nome}', ${inc.valor})" class="bg-gray-900 border ${isSelected ? 'border-neon-red shadow-[0_0_10px_rgba(255,0,85,0.2)]' : 'border-gray-800'} rounded-xl p-3 cursor-pointer transition-all hover:border-gray-600 group relative overflow-hidden">
                                        ${isSelected ? '<div class="absolute top-0 right-0 p-1"><i data-lucide="check" size="14" class="text-neon-red"></i></div>' : ''}
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="text-xs font-bold ${isSelected ? 'text-neon-red' : 'text-white'}">${inc.nome}</span>
                                            <span class="text-[10px] font-mono bg-black/50 px-1.5 rounded text-gray-400 border border-gray-700">+${inc.valor} pts</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 leading-tight group-hover:text-gray-400 transition-colors line-clamp-2">${inc.desc}</p>
                                    </div>`;
                                }
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            } else if (step === 5) {
                 title = 'TREINAMENTOS';
                window.toggleAccordion = (section) => { state.openSkillAccordion = state.openSkillAccordion === section ? null : section; render(); };
                
                const bgSkillsText = state.tempChar.background ? SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background).proficiencias : "";
                
                // Separate skills into Manual and Background
                const manualMainSkills = state.tempChar.skills.filter(s => !bgSkillsText.includes(s));
                
                const mainCount = manualMainSkills.length;
                const otherCount = state.tempChar.otherSkills.length;
                const maxMain = 5;
                
                const hasBgKit = bgSkillsText.includes("Kit") || bgSkillsText.includes("Ferramenta");
                const maxOther = hasBgKit ? 5 : 4;

                const renderAccordionHeader = (id, label, count, max, isOpen, colorClass, labelColorClass) => {
                    return `
                    <div onclick="toggleAccordion('${id}')" class="flex items-center justify-between p-4 bg-gray-900 border ${isOpen ? `border-${colorClass.split('-')[1]}-${colorClass.split('-')[2]}` : 'border-gray-800'} rounded-xl cursor-pointer hover:bg-gray-800 transition-all mb-2 relative group overflow-hidden">
                         <div class="absolute left-0 top-0 bottom-0 w-1 ${isOpen ? 'bg-' + colorClass.replace('text-', '') : 'bg-transparent'} transition-colors"></div>
                        <div class="flex items-center gap-3 pl-2">
                             <div>
                                <h3 class="font-display font-bold text-sm text-white uppercase tracking-wider ${isOpen ? colorClass : ''}">${label}</h3>
                                <div class="flex items-baseline gap-2 mt-0.5">
                                    <span class="text-[10px] text-gray-500 font-bold tracking-wider">SELECIONADO</span>
                                    <span id="counter-text-${id}" class="font-display font-bold text-xs ${count >= max ? colorClass : 'text-gray-400'}">${count} <span class="text-gray-600 text-[10px]">/ ${max}</span></span>
                                </div>
                             </div>
                        </div>
                        <div class="${isOpen ? colorClass + ' rotate-180' : 'text-gray-600'} transition-transform duration-300">
                            <i data-lucide="chevron-down" size="20"></i>
                        </div>
                    </div>`;
                };

                // Use themeColorHex for Step 5 logic to ensure colors stick
                const tc = themeColorHex;

                contentHtml = `<div class="space-y-4 pt-2">
                    <div class="text-center mb-4"><p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Defina suas competências de combate e perícias</p></div>
                    
                    ${bgSkillsText ? `<div class="bg-gray-900/50 border border-gray-800 p-3 rounded-xl mb-4 text-center"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Perícias de Antecedente (Extra)</p><p class="text-xs text-neon-blue font-bold">${bgSkillsText}</p></div>` : ''}

                    ${renderAccordionHeader('MAIN', 'PERÍCIAS E RESISTÊNCIAS', mainCount, maxMain, state.openSkillAccordion === 'MAIN', 'text-neon-theme', 'text-neon-theme')}
                    ${state.openSkillAccordion === 'MAIN' ? `<div class="pl-1 pr-1 pb-4 pt-1">
                        <div class="grid grid-cols-2 gap-2">
                            ${SYSTEM_DB.skills.map(skill => {
                                const isSelected = state.tempChar.skills.includes(skill);
                                const isFromBg = bgSkillsText.includes(skill); 
                                return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="toggleCreatorSkill('${skill}', 'main')" class="flex items-center justify-between p-2 rounded-xl border cursor-pointer transition-all ${isSelected ? 'bg-neon-theme/10 border-neon-theme text-white shadow-[0_0_10px_rgba(var(--theme-rgb),0.1)]' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700'} group">
                                    <span class="text-[10px] font-bold uppercase tracking-wide pointer-events-none group-hover:text-gray-300 transition-colors ${isSelected ? 'text-neon-theme' : ''}">${skill} ${isFromBg ? '<span class="text-[9px] bg-gray-900 px-1 rounded ml-1 border border-gray-700 text-gray-400 block mt-1 w-fit">ANTECEDENTE</span>' : ''}</span>
                                    <div class="pointer-events-none ${isSelected ? 'text-neon-theme' : 'text-gray-700'}">
                                        ${isSelected ? '<i data-lucide="check-square" size="14"></i>' : '<i data-lucide="square" size="14"></i>'}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>` : ''}

                    ${renderAccordionHeader('OTHER', 'OUTROS TREINAMENTOS', otherCount, maxOther, state.openSkillAccordion === 'OTHER', 'text-neon-theme', 'text-neon-theme')}
                    ${state.openSkillAccordion === 'OTHER' ? `<div class="pl-1 pr-1 pb-4 pt-1">
                        <p class="text-[10px] text-gray-500 italic mb-3 px-2">A 5ª escolha é atribuída automaticamente pelo kit de antecedente.</p>
                        <div class="grid grid-cols-1 gap-2">
                            ${SYSTEM_DB.otherSkills.map(skill => {
                                const isSelected = state.tempChar.otherSkills.includes(skill);
                                const isKitItem = skill === 'Kits';
                                const isLocked = isKitItem && hasBgKit;
                                
                                return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="${isLocked ? '' : `toggleCreatorSkill('${skill}', 'other')`}" class="flex items-center justify-between p-2 rounded-xl border transition-all ${isLocked ? `bg-[${tc}]/5 border-[${tc}]/50 text-white cursor-not-allowed` : (isSelected ? `bg-[${tc}]/10 border-[${tc}] text-white shadow-[0_0_10px_${tc}20] cursor-pointer` : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700 cursor-pointer')} group">
                                    <div class="flex items-center gap-3 pointer-events-none">
                                         <i data-lucide="${isLocked ? 'lock' : 'hammer'}" size="14" class="${isSelected ? `text-[${tc}]` : 'text-gray-600'}" style="${isSelected ? `color:${tc}` : ''}"></i>
                                         <span class="text-[10px] font-bold uppercase tracking-wide group-hover:text-gray-300 transition-colors ${isSelected ? `text-[${tc}]` : ''}" style="${isSelected ? `color:${tc}` : ''}">${skill} ${isLocked ? '(ANTECEDENTE)' : ''}</span>
                                    </div>
                                    <div class="pointer-events-none ${isSelected ? `text-[${tc}]` : 'text-gray-700'}" style="${isSelected ? `color:${tc}` : ''}">
                                        ${isSelected ? (isLocked ? '<i data-lucide="lock" size="14"></i>' : '<i data-lucide="check-square" size="14"></i>') : '<i data-lucide="square" size="14"></i>'}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>` : ''}
                </div>`;
            } else if (step === 6) {
                title = 'REVISÃO';
                const color = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class).color;
                
                // Bonus Logic
                const bonusReq = getBonusRequirements(state.tempChar.race);
                const allocatedTotal = getAllocatedTotal();
                const isBonusReady = !bonusReq || (bonusReq.type === 'wildcard' && allocatedTotal === bonusReq.amount) || (bonusReq.type === 'choice' && allocatedTotal === bonusReq.amount);
                
                let bonusHtml = '';
                if (bonusReq) {
                    bonusHtml = `<div class="bg-gray-900 rounded-xl p-4 border border-neon-theme shadow-[0_0_15px_rgba(var(--theme-rgb),0.1)] mb-4 animate-in fade-in zoom-in duration-300">
                        <div class="flex items-center gap-2 mb-3 text-neon-theme border-b border-neon-theme/30 pb-2">
                            <i data-lucide="gift" size="18"></i>
                            <h3 class="font-bold uppercase text-xs tracking-widest">Alocação de Bônus (${state.tempChar.race})</h3>
                        </div>
                        
                        ${bonusReq.type === 'wildcard' ? `
                            <p class="text-[10px] text-gray-400 mb-3">Distribua <span class="text-white font-bold">${bonusReq.amount}</span> pontos entre seus atributos.</p>
                            <div class="grid grid-cols-3 gap-2">
                                ${Object.keys(state.tempChar.attributes).map(attr => {
                                    const current = state.allocations[attr] || 0;
                                    return `<div class="flex flex-col items-center bg-black/30 rounded p-2 border border-gray-800">
                                        <span class="text-[9px] text-gray-500 font-bold mb-1">${attr}</span>
                                        <div class="flex items-center gap-2">
                                            <button onclick="updateAllocation('${attr}', -1, ${bonusReq.amount})" class="text-gray-500 hover:text-white ${current <= 0 ? 'opacity-20 cursor-not-allowed' : ''}"><i data-lucide="minus" size="12"></i></button>
                                            <span class="font-bold text-white text-sm w-3 text-center">${current}</span>
                                            <button onclick="updateAllocation('${attr}', 1, ${bonusReq.amount})" class="text-neon-theme hover:brightness-125 ${allocatedTotal >= bonusReq.amount ? 'opacity-20 cursor-not-allowed' : ''}"><i data-lucide="plus" size="12"></i></button>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                            <div class="mt-2 text-right text-[10px] font-bold ${allocatedTotal === bonusReq.amount ? 'text-neon-green' : 'text-neon-yellow'}">
                                ${allocatedTotal} / ${bonusReq.amount} Pontos
                            </div>
                        ` : ''}

                        ${bonusReq.type === 'choice' ? `
                            <p class="text-[10px] text-gray-400 mb-3">Escolha onde aplicar +${bonusReq.amount}.</p>
                            <div class="flex gap-2">
                                ${bonusReq.keys.map(attr => {
                                    const isSelected = state.allocations[attr] === bonusReq.amount;
                                    return `<button onclick="updateChoiceAllocation('${attr}', ${bonusReq.amount})" class="flex-1 py-2 rounded border font-bold text-xs transition-all ${isSelected ? 'bg-neon-theme text-black border-neon-theme' : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700'}">${attr} +${bonusReq.amount}</button>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
                }

                contentHtml = `<div class="space-y-6">
                <div class="text-center"><h2 class="text-3xl font-display font-bold text-white mb-1">${state.tempChar.name || 'Sem Nome'}</h2><span class="bg-[${color}]/20 text-[${color}] px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest border border-[${color}]/30">${state.tempChar.class}</span></div>
                
                ${bonusHtml}

                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 space-y-4">
                    <div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-xs text-gray-500 uppercase">Raça</span><span class="text-sm font-bold text-white">${state.tempChar.race}</span></div>
                    <div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-xs text-gray-500 uppercase">Antecedente</span><span class="text-sm font-bold text-white">${state.tempChar.background || '-'}</span></div>
                    
                    ${state.tempChar.raceTraits && state.tempChar.raceTraits.length > 0 ? `<div><span class="text-xs text-gray-500 uppercase block mb-2">Traços Raciais Selecionados</span><div class="flex flex-wrap gap-1">${state.tempChar.raceTraits.map(t => `<span class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">${t}</span>`).join('')}</div></div>` : ''}
                    
                    <div><span class="text-xs text-gray-500 uppercase block mb-2">Atributos Base</span><div class="grid grid-cols-6 gap-1 text-center">${Object.entries(state.tempChar.attributes).map(([k,v]) => `<div class="bg-black rounded p-1"><div class="text-[8px] text-gray-500">${k}</div><div class="text-xs font-bold text-white">${v}</div></div>`).join('')}</div></div>
                    
                    <div><span class="text-xs text-gray-500 uppercase block mb-2">Treinamentos</span><div class="flex flex-wrap gap-1 mb-2">${state.tempChar.skills.length > 0 ? state.tempChar.skills.map(s => `<span class="text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento principal</span>'}</div><div class="flex flex-wrap gap-1">${state.tempChar.otherSkills.length > 0 ? state.tempChar.otherSkills.map(s => `<span class="text-[10px] bg-gray-800 text-neon-blue/70 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento extra</span>'}</div></div>
                    
                    <div>
                        <span class="text-xs text-gray-500 uppercase block mb-2">Inclinações</span>
                        <div class="space-y-1">
                            ${state.tempChar.inclinations.positive.map(i => `<div class="text-[10px] text-neon-green flex justify-between"><span>+ ${i.nome}</span><span>${i.custo}</span></div>`).join('')}
                            ${state.tempChar.inclinations.negative.map(i => `<div class="text-[10px] text-neon-red flex justify-between"><span>- ${i.nome}</span><span>${i.valor}</span></div>`).join('')}
                        </div>
                    </div>
                </div>
                
                ${!isBonusReady ? `<div class="bg-red-500/10 border border-red-500/50 p-3 rounded-xl flex items-center gap-3 text-red-400 text-xs font-bold animate-pulse"><i data-lucide="alert-circle" size="20"></i> Aloque todos os pontos de bônus para finalizar.</div>` : ''}
                
                </div>`;
            }

            const footerBtn = step < 6 
                ? `<button onclick="nextCreatorStep()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl hover:brightness-110 transition-colors text-xs uppercase tracking-wider shadow-[0_0_15px_rgba(var(--theme-rgb),0.4)]">PRÓXIMO <i data-lucide="chevron-right" size="14" class="inline mb-0.5"></i></button>`
                : (() => {
                    const bonusReq = getBonusRequirements(state.tempChar.race);
                    const allocatedTotal = getAllocatedTotal();
                    const isBonusReady = !bonusReq || (bonusReq.type === 'wildcard' && allocatedTotal === bonusReq.amount) || (bonusReq.type === 'choice' && allocatedTotal === bonusReq.amount);
                    
                    return `<button onclick="finishCreator()" ${!isBonusReady ? 'disabled' : ''} class="flex-1 py-4 ${isBonusReady ? 'bg-neon-theme text-black hover:brightness-110 shadow-[0_0_20px_rgba(var(--theme-rgb),0.6)]' : 'bg-gray-800 text-gray-500 cursor-not-allowed'} font-bold rounded-xl transition-all text-xs uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="save" size="16"></i> FINALIZAR</button>`;
                })();

            container.innerHTML = `<div class="flex flex-col h-full bg-gray-950"><div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50"><button onclick="state.view='LIST'; render()" class="text-gray-500 hover:text-white flex items-center gap-1 text-[10px] uppercase font-bold"><i data-lucide="chevron-left" size="14"></i> Cancelar</button><div class="flex gap-1">${[0,1,2,3,4,5,6].map(i => `<div class="w-4 h-1 rounded-full ${i <= step ? 'bg-neon-theme shadow-[0_0_5px_var(--theme-color-hex)]' : 'bg-gray-800'} transition-all duration-300"></div>`).join('')}</div><div class="w-16"></div></div><div class="flex-1 p-6 overflow-y-auto custom-scrollbar relative"><h2 class="text-2xl font-display font-bold text-white text-center mb-6 tracking-widest drop-shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]">${title}</h2>${contentHtml}</div><div class="p-6 border-t border-gray-800 flex gap-4 bg-gray-900/50 pb-6 pb-safe">${step > 0 ? `<button onclick="state.creatorStep--; render()" class="w-1/3 py-4 bg-transparent border border-gray-700 rounded-xl text-gray-400 font-bold hover:text-white hover:border-gray-500 transition-colors text-xs uppercase tracking-wider">Voltar</button>` : '<div class="w-1/3"></div>'}${footerBtn}</div></div>`;
        }

        function renderSheet(container) {
            const char = state.currentChar;
            const clsData = SYSTEM_DB.classes.find(c => c.id === char.class);
            const themeColor = clsData ? clsData.color : '#00ff9d';
            setThemeColor(themeColor);
            const nextXp = char.xp_next || 100;
            const xpPct = Math.min(100, (char.xp / nextXp) * 100);
            let tabContent = '';
            
            const ATTR_FULL_NAMES = { 'FOR': 'FORÇA', 'DES': 'DESTREZA', 'CON': 'CONSTITUIÇÃO', 'INT': 'INTELIGÊNCIA', 'SAB': 'SABEDORIA', 'CAR': 'CARISMA' };
            const ATTR_ICONS_MAP = {
                'FOR': ['dumbbell', 'swords'], 'DES': ['wind', 'target'], 
                'CON': ['heart', 'activity'],
                'INT': ['brain-circuit', 'book-open'], 'SAB': ['eye', 'sparkles'], 'CAR': ['crown', 'message-circle']
            };

            if (state.activeTab === 'FICHA') {
                tabContent = `<div class="grid grid-cols-2 gap-3 p-4">${Object.entries(char.attributes).map(([key, attr]) => {
                    const mod = getMod(attr.value);
                    const isOpen = state.openAttrPopup === key;
                    const fullName = ATTR_FULL_NAMES[key];
                    const icons = ATTR_ICONS_MAP[key];
                    const saveSkillName = `TR de ${key}`;
                    const isTrained = char.skills.includes(saveSkillName);
                    const isExpert = (char.expertise || []).includes(saveSkillName);
                    const pb = getProficiencyBonus(char.level);
                    let saveBonus = mod;
                    if(isExpert) saveBonus += pb * 2;
                    else if(isTrained) saveBonus += pb;
                    const saveBonusStr = saveBonus >= 0 ? `+${saveBonus}` : `${saveBonus}`;
                    
                    return `
                    <div class="bg-gray-900 border border-gray-800 rounded-3xl p-3 relative overflow-hidden transition-all duration-300 hover:border-[${themeColor}] hover:shadow-[0_0_20px_rgba(var(--theme-rgb),0.1)] h-full flex flex-col justify-between group" onclick="handleAttributeClick('${key}')">
                        <div class="relative w-full flex justify-center items-center mb-1 min-h-[30px]">
                            <div class="flex items-center gap-2 text-[${themeColor}] bg-black/40 px-3 py-1 rounded-full border border-white/5 backdrop-blur-sm z-10 shadow-[0_0_15px_${themeColor}40]">
                                <i data-lucide="${icons[0]}" size="10" class="drop-shadow-[0_0_8px_${themeColor}]"></i>
                                <span class="text-[9px] font-black text-white uppercase tracking-[0.15em] drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]">${fullName}</span>
                                <i data-lucide="${icons[1]}" size="10" class="drop-shadow-[0_0_8px_${themeColor}]"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-center my-0 relative flex-1">
                                <button onclick="event.stopPropagation(); updateSheetAttr('${key}', -1)" class="absolute left-0 text-gray-600 hover:text-white p-1"><i data-lucide="minus" size="14"></i></button>
                                <span class="text-4xl font-display font-bold text-white tracking-tighter drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">${attr.value}</span>
                                <button onclick="event.stopPropagation(); updateSheetAttr('${key}', 1)" class="absolute right-0 text-gray-600 hover:text-white p-1"><i data-lucide="plus" size="14"></i></button>
                        </div>
                        <div class="flex justify-center mt-1 mb-1">
                                <div class="px-4 py-0.5 rounded-full border border-[${themeColor}]/30 bg-[${themeColor}]/5 text-[${themeColor}] text-xs font-bold shadow-[0_0_10px_rgba(var(--theme-rgb),0.2)]">
                                ${mod >= 0 ? '+'+mod : mod}
                                </div>
                        </div>
                        <div onclick="event.stopPropagation(); handleShieldClick('${key}')" class="absolute right-2 bottom-2 cursor-pointer z-20 hover:scale-110 transition-transform flex items-center justify-center" title="TR de ${fullName}: ${saveBonusStr}">
                            <i data-lucide="shield" size="18" class="${isTrained ? (isExpert ? 'text-neon-yellow fill-neon-yellow/10 drop-shadow-[0_0_5px_rgba(255,230,0,0.8)]' : `text-[${themeColor}] fill-[${themeColor}]/10 drop-shadow-[0_0_5px_${themeColor}]`) : 'text-gray-800 fill-gray-900'} transition-colors"></i>
                            <span class="absolute text-[7px] font-bold ${isTrained ? 'text-white' : 'text-gray-500'}" style="padding-top: 1px;">${saveBonusStr}</span>
                        </div>
                    </div>`;
                }).join('')}
                ${state.openAttrPopup ? (() => { const key = state.openAttrPopup; const attr = char.attributes[key]; const mod = getMod(attr.value); const skillsList = SKILL_MAP[key] || []; return `<div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onclick="toggleAttrPopup(null)"><div class="bg-gray-900 border-2 border-[${themeColor}] rounded-2xl p-6 w-[85%] max-w-[320px] shadow-[0_0_50px_rgba(0,0,0,0.8)] relative transform scale-100 animate-in zoom-in-95 duration-200" onclick="event.stopPropagation()"><button onclick="toggleAttrPopup(null)" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x" size="20"></i></button><div class="text-center mb-6"><h2 class="text-2xl font-display font-black text-white uppercase tracking-widest drop-shadow-[0_0_10px_${themeColor}]">${ATTR_FULL_NAMES[key]}</h2><div class="flex justify-center items-center gap-4 mt-2"><div class="text-4xl font-display font-bold text-[${themeColor}]">${attr.value}</div><div class="bg-gray-800 px-4 py-1 rounded-full text-sm font-bold text-white border border-gray-700">Mod ${mod >= 0 ? '+'+mod : mod}</div></div></div><div class="space-y-3 mb-6"><h4 class="text-[10px] font-bold text-gray-500 uppercase border-b border-gray-800 pb-2 text-center">Perícias Associadas</h4><div class="flex flex-col gap-2 max-h-[200px] overflow-y-auto custom-scrollbar">${skillsList.length > 0 ? skillsList.map(s => { const isTrained = char.skills.includes(s); const isExpert = (char.expertise || []).includes(s); const pb = getProficiencyBonus(char.level); let totalBonus = mod; if (isExpert) totalBonus += (pb * 2); else if (isTrained) totalBonus += pb; let iconName = 'circle'; let iconColorClass = 'text-gray-600'; if (isExpert) { iconName = 'badge-check'; iconColorClass = 'text-neon-yellow fill-neon-yellow/20'; } else if (isTrained) { iconName = 'check-circle-2'; iconColorClass = `text-[${themeColor}]`; } return `<div class="flex items-center justify-between p-3 rounded-xl border transition-all group ${isTrained ? `bg-[${themeColor}]/10 border-[${themeColor}]/30` : 'bg-gray-950 border-gray-800 hover:border-gray-600'}"><div class="flex items-center gap-3 cursor-pointer" onclick="handleSkillStatus('${s}')"><i data-lucide="${iconName}" size="20" class="${iconColorClass} hover:scale-110 transition-transform"></i><span class="text-xs font-bold uppercase tracking-wide ${isTrained ? 'text-white' : 'text-gray-400'}">${s}</span></div><div class="flex items-center gap-2 cursor-pointer" onclick="rollSkill('${s}', '${key}')"><span class="text-xs font-mono font-bold ${isExpert ? 'text-neon-yellow' : (isTrained ? `text-[${themeColor}]` : 'text-gray-500')}">${totalBonus >= 0 ? '+'+totalBonus : totalBonus}</span><i data-lucide="dices" size="16" class="text-gray-600 group-hover:text-white transition-colors"></i></div></div>` }).join('') : '<span class="text-xs text-gray-600 italic block text-center py-2">Nenhuma perícia associada.</span>'}</div></div><button onclick="rollDice('${key}', ${mod}); toggleAttrPopup(null)" class="w-full py-3 bg-[${themeColor}] text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 transition-all flex items-center justify-center gap-2 shadow-[0_0_20px_${themeColor}40]"><i data-lucide="dices" size="18"></i> ROLAR ATRIBUTO PURO</button></div></div>${state.skillSelectionModal ? `<div class="fixed inset-0 z-[110] flex items-center justify-center bg-black/90 animate-in fade-in duration-200" onclick="closeSkillModal()"><div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-[85%] max-w-[300px] shadow-2xl relative" onclick="event.stopPropagation()"><h3 class="text-lg font-display font-bold text-white mb-1">${state.skillSelectionModal}</h3><p class="text-xs text-gray-400 mb-4 uppercase tracking-widest">Selecione o nível de treinamento</p><div class="space-y-2"><button onclick="setSkillLevel('${state.skillSelectionModal}', 'remove')" class="w-full p-3 rounded-lg border border-red-900/50 bg-red-500/10 text-red-500 font-bold text-xs uppercase hover:bg-red-500 hover:text-white transition-colors flex items-center gap-2"><i data-lucide="x" size="16"></i> Remover Proficiência</button><button onclick="setSkillLevel('${state.skillSelectionModal}', 'trained')" class="w-full p-3 rounded-lg border border-gray-700 bg-gray-800 text-gray-300 font-bold text-xs uppercase hover:bg-gray-700 hover:text-white transition-colors flex items-center gap-2"><i data-lucide="check-circle-2" size="16"></i> Normal (1x Bônus)</button><button onclick="setSkillLevel('${state.skillSelectionModal}', 'expert')" class="w-full p-3 rounded-lg border border-neon-yellow/30 bg-neon-yellow/10 text-neon-yellow font-bold text-xs uppercase hover:bg-neon-yellow hover:text-black transition-colors flex items-center gap-2"><i data-lucide="badge-check" size="16"></i> Especialização (2x Bônus)</button></div><button onclick="closeSkillModal()" class="mt-4 w-full py-2 text-xs text-gray-500 hover:text-white uppercase font-bold tracking-widest">Cancelar</button></div></div>` : ''}`; })() : ''}</div>`;
            } else if (state.activeTab === 'TRACOS') {
                const raceData = SYSTEM_DB.racas.find(r => r.nome === char.race);
                const bgData = SYSTEM_DB.antecedentes.find(b => b.nome === char.background);
                let traitsHtml = `<div class="flex items-center gap-3 mb-2 mt-2"><div class="bg-gray-800 p-2 rounded text-[${themeColor}]"><i data-lucide="dna" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">${char.race}</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Características Raciais</p></div></div><div class="space-y-2 mb-6">`;
                if (char.race === 'Formiga Quimera') { if (char.raceTraits && char.raceTraits.length > 0) { traitsHtml += char.raceTraits.map(tName => { const tData = raceData.caracteristicas.find(c => c.nome === tName); return `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl border-l-2 border-l-[${themeColor}]"><h4 class="font-bold text-white text-xs mb-1">${tName}</h4><p class="text-[10px] text-gray-400 leading-relaxed">${tData ? (tData.efeito || tData.mecanica) : 'Descrição não encontrada.'}</p></div>`; }).join(''); } } else { const fixedFeatures = [...(raceData.caracteristicas || [])]; if (fixedFeatures.length > 0) { traitsHtml += fixedFeatures.map(f => `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl border-l-2 border-l-[${themeColor}]"><h4 class="font-bold text-white text-xs mb-1">${f.nome}</h4><p class="text-[10px] text-gray-400 leading-relaxed">${f.efeito || f.mecanica || ''}</p>${f.tabela_ancestral ? `<p class="text-[9px] text-gray-500 mt-1 italic">${f.tabela_ancestral}</p>` : ''}</div>`).join(''); } if (typeof raceData.aumento_atributo === 'object') { const attrs = Object.entries(raceData.aumento_atributo).map(([k,v]) => `${k} ${v>0?'+':''}${v}`).join(', '); traitsHtml += `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl"><h4 class="font-bold text-gray-500 text-[10px] uppercase mb-1">Bônus de Atributos</h4><p class="text-xs text-[${themeColor}] font-bold">${attrs}</p></div>`; } } traitsHtml += `</div>`;
                let bgHtml = ''; if (bgData && char.backgroundFeature) { const feature = bgData.caracteristicas.find(f => f.nome === char.backgroundFeature); bgHtml = `<div class="flex items-center gap-3 mb-2 border-t border-gray-800 pt-4"><div class="bg-gray-800 p-2 rounded text-[${themeColor}]"><i data-lucide="book-open" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">${char.background}</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Antecedente</p></div></div><div class="space-y-2 mb-6"><div class="bg-gray-900 border border-gray-800 p-3 rounded-xl border-l-4 border-l-[${themeColor}]"><h4 class="font-bold text-[${themeColor}] text-xs mb-1">${feature.nome}</h4><p class="text-[10px] text-gray-400 leading-relaxed">${feature.efeito}</p></div></div>`; }
                let incHtml = ''; if (char.inclinations && (char.inclinations.positive.length > 0 || char.inclinations.negative.length > 0)) { incHtml = `<div class="flex items-center gap-3 mb-2 border-t border-gray-800 pt-4"><div class="bg-gray-800 p-2 rounded text-white"><i data-lucide="scale" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">Inclinações</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Positivas e Negativas</p></div></div><div class="space-y-2 mb-6">`; const findIncDesc = (type, name) => { const list = SYSTEM_DB.inclinacoes[type]; if (name.includes(':')) { const [parentName, childName] = name.split(':').map(s=>s.trim()); const parent = list.find(i => i.nome === parentName); if (parent && parent.options) { const child = parent.options.find(o => o.label === childName); if (child) return child.desc; } } const exact = list.find(i => i.nome === name); return exact ? exact.desc : 'Descrição não encontrada.'; }; if (char.inclinations.positive.length > 0) { incHtml += char.inclinations.positive.map(i => { const desc = findIncDesc('positivas', i.nome); return `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl border-l-2 border-l-neon-green"><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-neon-green text-xs">${i.nome}</h4><span class="text-[9px] bg-gray-800 px-1.5 rounded text-gray-400 border border-gray-700">${i.custo} pts</span></div><p class="text-[10px] text-gray-400 leading-relaxed">${desc}</p></div>`; }).join(''); } if (char.inclinations.negative.length > 0) { incHtml += char.inclinations.negative.map(i => { const desc = findIncDesc('negativas', i.nome); return `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl border-l-2 border-l-neon-red"><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-neon-red text-xs">${i.nome}</h4><span class="text-[9px] bg-gray-800 px-1.5 rounded text-gray-400 border border-gray-700">+${i.valor} pts</span></div><p class="text-[10px] text-gray-400 leading-relaxed">${desc}</p></div>`; }).join(''); } incHtml += `</div>`; }
                
                // Other Skills Accordion Logic
                const otherTrainings = char.skills.filter(s => SYSTEM_DB.otherSkills.includes(s)); 
                let otherSkillsHtml = ''; 
                if (otherTrainings.length > 0) { 
                    const isOpen = state.sheetOtherSkillsOpen;
                    otherSkillsHtml = `
                    <div class="mt-2 border-t border-gray-800 pt-4">
                        <div onclick="toggleSheetAccordion()" class="flex items-center justify-between cursor-pointer group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-gray-800 p-2 rounded text-[${themeColor}]"><i data-lucide="hammer" size="20"></i></div>
                                <div><h3 class="font-bold text-white uppercase tracking-wider text-sm">Outros Treinamentos</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Equipamentos, Linguagens e Ferramentas</p></div>
                            </div>
                            <div class="transition-transform duration-300 ${isOpen ? 'rotate-180 text-white' : 'text-gray-600 group-hover:text-gray-400'}">
                                <i data-lucide="chevron-down" size="20"></i>
                            </div>
                        </div>
                        <div class="accordion-content ${isOpen ? 'open' : ''}">
                            <div class="flex flex-wrap gap-2 pt-2">
                                ${otherTrainings.map(s => `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl inline-flex items-center gap-2 w-auto pr-4"><i data-lucide="check-circle" size="14" style="color: ${themeColor}" class="shrink-0"></i><span class="text-xs font-bold whitespace-nowrap" style="color: ${themeColor}">${s}</span></div>`).join('')}
                            </div>
                        </div>
                    </div>`; 
                } 
                
                tabContent = `<div class="p-4 space-y-2">${traitsHtml}${bgHtml}${incHtml}${otherSkillsHtml}</div>`;
            } else if (state.activeTab === 'INV') {
                // ... (INV same)
                tabContent = `<div class="p-4 space-y-4"><div class="flex gap-2"><input type="text" id="new-item-name" placeholder="Nome do item..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-[${themeColor}]"><button onclick="addItem()" class="bg-[${themeColor}] text-black px-4 rounded-lg font-bold hover:brightness-110"><i data-lucide="plus"></i></button></div><div class="space-y-2">${char.inventory.length === 0 ? '<div class="text-center text-gray-600 text-xs py-8 border border-dashed border-gray-800 rounded-xl">Mochila vazia.</div>' : ''}${char.inventory.map((item, idx) => `<div class="bg-gray-900 border border-gray-800 rounded-xl p-3 flex justify-between items-center"><span class="text-sm font-bold text-white">${item.name}</span><div class="flex items-center gap-3"><button onclick="updateItemQty(${idx}, -1)" class="text-gray-500 hover:text-white"><i data-lucide="minus" size="14"></i></button><span class="text-sm w-4 text-center">${item.qty}</span><button onclick="updateItemQty(${idx}, 1)" class="text-gray-500 hover:text-white"><i data-lucide="plus" size="14"></i></button></div></div>`).join('')}</div><div class="flex justify-between items-center pt-4 border-t border-gray-800 text-xs text-gray-400"><span class="uppercase font-bold tracking-widest">Jenny (Dinheiro)</span><div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-700"><span class="text-[${themeColor}] font-bold">$</span><input type="number" value="${char.money}" onchange="updateMoney(this.value)" class="w-24 text-right bg-transparent text-white font-mono outline-none"></div></div></div>`;
            } else if (state.activeTab === 'DADOS') {
                // ... (DADOS same)
                tabContent = `<div class="p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-950 pb-2 border-b border-gray-800 z-10"><h3 class="font-bold text-white uppercase tracking-wider text-xs">Histórico de Rolagens</h3><button onclick="clearHistory()" class="text-[10px] text-red-500 uppercase font-bold hover:text-red-400 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Limpar Log</button></div><div class="flex-1 overflow-y-auto space-y-2 text-sm pb-4">${char.history.length === 0 ? '<div class="text-center text-gray-600 italic py-10">Sem rolagens recentes.</div>' : ''}${char.history.slice().reverse().map(h => `<div class="bg-gray-900/50 p-3 rounded-lg border-l-2 border-[${themeColor}] flex flex-col gap-1"><div class="flex justify-between text-[10px] text-gray-500"><span>${h.time}</span><span class="uppercase font-bold tracking-wider text-gray-400">${h.label}</span></div><div class="flex justify-between items-center mt-1"><div class="flex flex-col"><span class="text-xs text-gray-500">Resultado</span><span class="text-2xl font-bold ${h.dice===20?'text-neon-yellow':h.dice===1?'text-neon-red':'text-white'} font-display">${h.total}</span></div><div class="text-right"><span class="text-xs text-gray-600 block">D20 + Mod</span><span class="text-gray-300 font-mono text-sm">[${h.dice}] ${h.mod>=0?'+':''}${h.mod}</span></div></div></div>`).join('')}</div></div>`;
            } else { tabContent = `<div class="flex flex-col items-center justify-center h-full text-gray-600 gap-4"><i data-lucide="construction" size="48" class="opacity-20"></i><span class="text-xs uppercase tracking-widest">Em desenvolvimento</span></div>`; }

            const renderNeonVital = (label, val, max, colorClass, borderClass, showBtns = true, step = 1) => `
                <div class="flex flex-col items-center justify-center w-full">
                    <span class="text-[9px] font-bold ${colorClass} uppercase tracking-wider mb-0.5">${label}</span>
                    <div class="flex items-center justify-between w-full max-w-[80%] gap-1">
                         ${showBtns ? `<button onclick="updateVital('${label.toLowerCase()}', ${-step})" class="text-gray-500 hover:text-white p-1 rounded-full hover:bg-white/10 transition-colors"><i data-lucide="minus" size="10"></i></button>` : '<div class="w-4"></div>'}
                        <span class="font-display font-bold text-lg text-white tracking-wider">${val}</span>
                         ${showBtns ? `<button onclick="updateVital('${label.toLowerCase()}', ${step})" class="text-gray-500 hover:text-white p-1 rounded-full hover:bg-white/10 transition-colors"><i data-lucide="plus" size="10"></i></button>` : '<div class="w-4"></div>'}
                    </div>
                    <div class="w-8 h-0.5 rounded-full mt-0.5 ${borderClass} opacity-80"></div>
                </div>
            `;
            
            const rollModeBtn = (mode) => {
                const isActive = state.rollMode === mode;
                return `<button onclick="setRollMode('${mode}')" class="flex-1 py-3 text-[9px] font-bold uppercase tracking-widest transition-all rounded-lg ${isActive ? `bg-[${themeColor}] text-black shadow-[0_0_15px_${themeColor}80]` : 'text-gray-500 hover:text-gray-300 hover:bg-white/5'}">${mode}</button>`;
            };

            container.innerHTML = `
            <div class="flex flex-col h-full bg-gray-950">
                <div class="relative pt-8 pb-4 px-6 bg-gradient-to-b from-gray-900 to-transparent">
                    <button onclick="state.view='LIST'; render()" class="absolute top-4 left-4 text-gray-500 hover:text-white bg-black/30 p-2 rounded-full backdrop-blur-sm"><i data-lucide="arrow-left" size="20"></i></button>
                    <div class="mt-4">
                        <h1 class="font-display font-black text-2xl text-white uppercase tracking-wider truncate drop-shadow-lg">${char.name}</h1>
                        <div class="flex items-center gap-3 mt-2">
                            <div class="h-2 flex-1 bg-gray-800 rounded-full overflow-hidden border border-gray-700"><div class="h-full bg-[${themeColor}] shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]" style="width: ${xpPct}%"></div></div>
                            <div class="flex items-center gap-2">
                                <button onclick="changeLevel(-1)" class="w-6 h-6 bg-gray-800 rounded flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700"><i data-lucide="minus" size="12"></i></button>
                                <div class="flex flex-col items-end leading-none"><span class="text-[10px] font-bold text-gray-500 uppercase">Nível</span><span class="text-lg font-display font-bold text-white">${char.level}</span></div>
                                <button onclick="changeLevel(1)" class="w-6 h-6 bg-gray-800 rounded flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700"><i data-lucide="plus" size="12"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Bar (4 Cols) -->
                <div class="grid grid-cols-4 divide-x divide-gray-800 bg-[#0b0c10] border-t border-gray-800">
                    <!-- Tendência -->
                    <div class="p-2 flex flex-col items-center justify-center">
                        <span class="text-[9px] font-bold text-neon-blue uppercase tracking-widest mb-0.5">Tendência</span>
                        <select onchange="updateCharProperty('alignment', this.value)" class="bg-transparent text-white font-display font-bold text-xs uppercase outline-none cursor-pointer text-center appearance-none w-full">
                            <option value="Heróico" ${char.alignment === 'Heróico' ? 'selected' : ''} class="bg-gray-900">Heróico</option>
                            <option value="Caótico" ${char.alignment === 'Caótico' ? 'selected' : ''} class="bg-gray-900">Caótico</option>
                            <option value="Neutro" ${!char.alignment || char.alignment === 'Neutro' ? 'selected' : ''} class="bg-gray-900">Neutro</option>
                            <option value="Maligno" ${char.alignment === 'Maligno' ? 'selected' : ''} class="bg-gray-900">Maligno</option>
                        </select>
                    </div>
                    <!-- Proficiência -->
                    <div class="p-2 flex flex-col items-center justify-center">
                        <span class="text-[9px] font-bold text-neon-yellow uppercase tracking-widest mb-0.5">Proficiência</span>
                        <span class="font-display font-bold text-lg text-white tracking-wider">+${getProficiencyBonus(char.level)}</span>
                    </div>
                    <!-- DESL -->
                    <div class="p-2 flex flex-col items-center justify-center">
                        <span class="text-[9px] font-bold text-white uppercase tracking-widest mb-0.5">Desl.</span>
                        <span class="font-display font-bold text-lg text-white tracking-wider">${char.vitals.desl || 9}m</span>
                    </div>
                    <!-- Jogador -->
                    <div class="p-2 flex flex-col items-center justify-center">
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-0.5">Jogador</span>
                        <input type="text" value="${char.playerName || ''}" placeholder="Nome..." onchange="updateCharProperty('playerName', this.value)" class="bg-transparent text-white font-display font-bold text-xs outline-none w-full text-center placeholder-gray-700">
                    </div>
                </div>

                <!-- Vitals Row (3 Cols, 2 Rows logic) -->
                <div class="grid grid-cols-3 gap-y-2 gap-x-2 px-2 py-2 border-t border-b border-gray-800 bg-[#0b0c10]">
                    <!-- Row 1: SAN, REA, AURA -->
                    ${renderNeonVital('SAN', char.vitals.san, char.vitals.sanMax, 'text-white', 'bg-white text-white')}
                    ${renderNeonVital('REA', char.vitals.rea || (7 + getMod(char.attributes.SAB.value)), null, 'text-white', 'bg-white text-white', true)}
                    ${renderNeonVital('AURA', char.vitals.aura, char.vitals.auraMax, `text-[${themeColor}]`, `bg-[${themeColor}] text-[${themeColor}]`, true, 5)}
                    
                    <!-- Row 2: CA, Armor Icon, PV -->
                    ${renderNeonVital('CA', char.vitals.ca, null, 'text-white', 'bg-white text-white', false)}
                    
                    <!-- Armor Icon -->
                    <div class="flex flex-col items-center justify-center cursor-pointer group" onclick="handleArmorClick()">
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-0.5">ARMADURA</span>
                        <div class="w-10 h-10 rounded-full border border-gray-700 flex items-center justify-center bg-gray-900 group-hover:border-[${themeColor}] group-hover:shadow-[0_0_10px_rgba(var(--theme-rgb),0.3)] transition-all">
                            <i data-lucide="shield" size="20" class="text-gray-400 group-hover:text-[${themeColor}] transition-colors"></i>
                        </div>
                        <div class="w-8 h-0.5 rounded-full mt-1.5 bg-gray-800 opacity-80"></div>
                    </div>

                    ${renderNeonVital('PV', char.vitals.hp, char.vitals.hpMax, 'text-neon-red', 'bg-neon-red text-neon-red')}
                </div>

                <!-- Roll Mode Selector -->
                <div class="bg-gray-900/80 p-1 rounded-xl flex border border-gray-800 mx-4 mt-4 mb-2">
                    ${rollModeBtn('NORMAL')}
                    ${rollModeBtn('VANTAGEM')}
                    ${rollModeBtn('DESVANTAGEM')}
                    ${rollModeBtn('ÊNFASE')}
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar relative">${tabContent}</div>
                <div class="h-auto min-h-[4rem] bg-[#0e0e14] border-t border-gray-800 flex items-center justify-around px-2 relative z-50 pb-safe pt-2">
                    ${renderNavItem('FICHA', 'user', themeColor)}
                    ${renderNavItem('NEN', 'flame', themeColor)}
                    ${renderNavItem('TRACOS', 'dna', themeColor)}
                    ${renderNavItem('INV', 'backpack', themeColor)}
                    ${renderNavItem('DADOS', 'dices', themeColor)}
                </div>
            </div>`;
        }

        // Helpers de renderização
        function renderNavItem(id, icon, color) { const active = state.activeTab === id; return `<button onclick="setTab('${id}')" class="flex flex-col items-center justify-center w-full h-full gap-1 group relative">${active ? `<div class="absolute top-0 w-8 h-0.5 bg-[${color}] shadow-[0_0_10px_${color}]"></div>` : ''}<i data-lucide="${icon}" size="${active ? 20 : 18}" class="${active ? `text-[${color}] drop-shadow-[0_0_5px_${color}]` : 'text-gray-600 group-hover:text-gray-400'} transition-all"></i><span class="text-[7px] font-bold tracking-widest ${active ? `text-[${color}]` : 'text-gray-600'}">${id}</span></button>`; }

        // --- CONTROLLERS ---
        function selectChar(id) { state.currentChar = state.characters.find(c => c.id === id); state.view = 'SHEET'; state.activeTab = 'FICHA'; render(); }
        function startCreator() { state.creatorStep = 0; state.tempChar = null; state.attrMethodLocked = false; state.allocations = {}; state.view = 'CREATOR'; render(); }
        function selectNenType(cls) { state.tempChar.class = cls; const clsData = SYSTEM_DB.classes.find(c => c.id === cls); if(clsData) setThemeColor(clsData.color); render(); }
        
        function selectBackground(bgName) {
            if (state.tempChar.background === bgName) {
            } else {
                state.tempChar.background = bgName;
                state.tempChar.backgroundFeature = null;
            }
            render();
        }

        function selectBackgroundFeature(featureName) {
            state.tempChar.backgroundFeature = featureName;
        }

        function toggleInclination(type, name, value) {
            const list = state.tempChar.inclinations[type];
            const existsIdx = list.findIndex(i => i.nome === name);
            if (existsIdx >= 0) { list.splice(existsIdx, 1); } 
            else { list.push({ nome: name, [type === 'positive' ? 'custo' : 'valor']: value }); }
            render();
        }

        function selectRace(raceName) {
            state.tempChar.race = raceName;
            state.allocations = {}; // Reset allocations on race change
            SYSTEM_DB.racas.forEach(r => {
                const card = document.getElementById(`race-card-${r.nome.replace(/\s/g,'-')}`);
                const content = document.getElementById(`race-content-${r.nome.replace(/\s/g,'-')}`);
                const checkWrapper = document.getElementById(`check-${r.nome.replace(/\s/g,'-')}`);
                const chevronWrapper = document.getElementById(`chevron-${r.nome.replace(/\s/g,'-')}`);
                
                if (r.nome === raceName) {
                    card.classList.remove('border-gray-800', 'bg-gray-900');
                    card.classList.add('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-white');
                    h3.classList.add('text-neon-theme');
                    checkWrapper.classList.remove('opacity-0');
                    checkWrapper.classList.add('opacity-100');
                    chevronWrapper.classList.remove('-rotate-90', 'text-gray-600');
                    chevronWrapper.classList.add('rotate-0', 'text-neon-theme');
                    content.classList.add('open', 'pb-4');
                } else {
                    card.classList.remove('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    card.classList.add('border-gray-800', 'bg-gray-900');
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-neon-theme');
                    h3.classList.add('text-white');
                    checkWrapper.classList.remove('opacity-100');
                    checkWrapper.classList.add('opacity-0');
                    chevronWrapper.classList.remove('rotate-0', 'text-neon-theme');
                    chevronWrapper.classList.add('-rotate-90', 'text-gray-600');
                    content.classList.remove('open', 'pb-4');
                }
            });
        }

        function toggleRaceTrait(traitName) {
            const list = state.tempChar.raceTraits || [];
            const idx = list.indexOf(traitName);
            if (idx >= 0) list.splice(idx, 1);
            else {
                if (list.length >= 3) { alert("Você só pode escolher até 3 características."); return; }
                list.push(traitName);
            }
            state.tempChar.raceTraits = list;
            const btn = document.getElementById(`trait-btn-${traitName.replace(/\s/g,'-')}`);
            if (idx >= 0) { 
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>';
            } else { 
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-neon-theme/10 border-neon-theme text-white";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
            }
            document.getElementById('trait-counter').innerText = `(${list.length}/3)`;
            document.getElementById('trait-counter').className = list.length >= 3 ? 'text-neon-theme' : 'text-gray-500';
        }

        function toggleCreatorSkill(skill, type = 'main') {
            const list = type === 'main' ? state.tempChar.skills : state.tempChar.otherSkills;
            
            // Lógica para separar BG de manual
            const bgSkillsText = state.tempChar.background ? SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background).proficiencias : "";
            const isBgSkill = type === 'main' && bgSkillsText.includes(skill);

            // Se for do BG e tipo main, pode ser que o usuário queira desmarcar (se for escolha). Mas aqui tratamos como toggle normal.
            // A contagem para o limite ignora as do BG.

            let limit = type === 'main' ? 5 : 4;
            
            // Dynamic limit for Other Skills if BG has Kit
            if (type === 'other') {
                if (bgSkillsText.includes("Kit") || bgSkillsText.includes("Ferramenta")) {
                    limit = 5;
                }
            }

            const idx = list.indexOf(skill);
            
            if (idx >= 0) {
                list.splice(idx, 1);
            } else {
                // Verificar limite apenas para skills manuais (não presentes no BG)
                if (!isBgSkill) {
                    // Conta quantas manuais já existem na lista
                    const currentManualCount = list.filter(s => !bgSkillsText.includes(s)).length;
                    if (currentManualCount >= limit) { alert(`Limite de ${limit} escolhas manuais atingido.`); return; }
                }
                list.push(skill);
            }

            const btn = document.getElementById(`skill-btn-${skill.replace(/\s/g,'-')}`);
            const baseClass = type === 'main' ? 'bg-neon-theme/10 border-neon-theme text-white shadow-[0_0_10px_rgba(var(--theme-rgb),0.1)]' : 'bg-neon-yellow/10 border-neon-yellow text-white shadow-[0_0_10px_rgba(255,230,0,0.1)]';
            const iconColor = type === 'main' ? 'text-neon-theme' : 'text-neon-yellow';
            const maxColorClass = type === 'main' ? 'text-neon-theme' : 'text-neon-yellow';
            
            if (idx >= 0) {
                // Desmarcado
                btn.className = "flex items-center justify-between p-2 rounded-xl border cursor-pointer transition-all bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700 group";
                const checkContainer = btn.querySelector('div:last-child');
                checkContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>';
                checkContainer.classList.remove(iconColor);
                checkContainer.classList.add('text-gray-700');
                
                const textSpan = btn.querySelector('span');
                textSpan.classList.remove(iconColor);
                
                if (type === 'other') {
                    const hammer = btn.querySelector('div:first-child i');
                    if(hammer) { hammer.classList.remove('text-neon-yellow'); hammer.classList.add('text-gray-600'); }
                }

            } else { 
                // Marcado
                btn.className = `flex items-center justify-between p-2 rounded-xl border cursor-pointer transition-all ${baseClass} group`;
                const checkContainer = btn.querySelector('div:last-child');
                checkContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`;
                checkContainer.classList.remove('text-gray-700');
                checkContainer.classList.add(iconColor);
                
                const textSpan = btn.querySelector('span');
                textSpan.classList.add(iconColor);
                
                if (type === 'other') {
                     const hammer = btn.querySelector('div:first-child i');
                     if(hammer) { hammer.classList.remove('text-gray-600'); hammer.classList.add('text-neon-yellow'); }
                }
            }

            const counterEl = document.getElementById('counter-text-' + (type === 'main' ? 'MAIN' : 'OTHER'));
            if(counterEl) {
                // Atualiza contador visual (apenas manuais)
                const currentManualCount = list.filter(s => !bgSkillsText.includes(s)).length;
                counterEl.innerHTML = `${currentManualCount} <span class="text-gray-600 text-[10px]">/ ${limit}</span>`;
                counterEl.className = `font-display font-bold text-xs ${currentManualCount >= limit ? maxColorClass : 'text-gray-400'}`;
            }
        }

        function buyStat(attr, delta) {
            lockAttributeMethod();
            const current = state.tempChar.attributes[attr];
            const next = current + delta;
            
            if (next >= 1 && next <= 30) {
                const currentCost = calculateTotalCost(state.tempChar.attributes);
                const costDiff = getPointBuyCost(next) - getPointBuyCost(current);
                const MAX = 20;

                if (costDiff > 0 && (currentCost + costDiff > MAX)) {
                    const totalEl = document.getElementById('buy-total');
                    totalEl.classList.add('text-red-500', 'shake');
                    setTimeout(() => totalEl.classList.remove('shake'), 500);
                    return; 
                }

                state.tempChar.attributes[attr] = next;
                
                const newTotal = currentCost + costDiff;
                document.getElementById(`attr-val-${attr}`).innerText = next;
                
                const totalEl = document.getElementById('buy-total');
                totalEl.innerText = newTotal;
                
                const bar = document.getElementById('buy-bar');
                bar.style.width = `${Math.min(100, (newTotal/MAX)*100)}%`;
                
                if (newTotal > MAX) { 
                    bar.classList.remove('bg-neon-theme'); bar.classList.add('bg-red-500');
                    totalEl.classList.add('text-red-500'); totalEl.classList.remove('text-white');
                } else {
                    bar.classList.add('bg-neon-theme'); bar.classList.remove('bg-red-500');
                    totalEl.classList.add('text-white'); totalEl.classList.remove('text-red-500');
                }
            }
        }
        
        function setAttrTab(mode) {
             if (state.attrMethodLocked) return; 
             state.attrTab = mode; state.selectedPoolIdx = null;
             if(mode === 'COMPRA') { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = 10); state.attrPool = []; } 
             else { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = null); state.attrPool = []; }
             render();
        }
        function lockAttributeMethod() { if(!state.attrMethodLocked) { state.attrMethodLocked = true; render(); } }
        function rollAllStats() { lockAttributeMethod(); Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = null); let newPool = []; for(let k=0; k<6; k++) { let dice = []; for(let i=0; i<4; i++) { let d = Math.floor(Math.random()*6)+1; if(d === 1) d = Math.floor(Math.random()*6)+1; dice.push(d); } dice.sort((a,b) => b-a); newPool.push(dice[0] + dice[1] + dice[2]); } state.attrPool = newPool.sort((a,b) => b-a); render(); }
        function applyStandardArray() { lockAttributeMethod(); Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = null); state.attrPool = [15, 14, 13, 12, 10, 8]; render(); }
        function selectPoolItem(idx) { if (state.selectedPoolIdx === idx) state.selectedPoolIdx = null; else state.selectedPoolIdx = idx; render(); }
        function assignToSlot(attr) { if (state.selectedPoolIdx === null) return; if (state.tempChar.attributes[attr] !== null) state.attrPool.push(state.tempChar.attributes[attr]); const val = state.attrPool[state.selectedPoolIdx]; state.tempChar.attributes[attr] = val; state.attrPool.splice(state.selectedPoolIdx, 1); state.attrPool.sort((a,b) => b-a); state.selectedPoolIdx = null; render(); }
        function returnToPool(attr) { const val = state.tempChar.attributes[attr]; if (val !== null) { state.attrPool.push(val); state.attrPool.sort((a,b) => b-a); state.tempChar.attributes[attr] = null; render(); } }

        function applyBackgroundProficiencies() {
            if (!state.tempChar.background) return;
            const bgData = SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background);
            if (!bgData) return;
            
            const profText = bgData.proficiencias;
            
            // Main Skills Pre-Selection
            SYSTEM_DB.skills.forEach(skill => {
                if (profText.includes(skill) && !state.tempChar.skills.includes(skill)) {
                    state.tempChar.skills.push(skill);
                }
            });

            // Kit Locking
            if (profText.includes("Kit") || profText.includes("Ferramenta")) {
                if (!state.tempChar.otherSkills.includes("Kits")) {
                    state.tempChar.otherSkills.push("Kits");
                }
            }
        }

        function nextCreatorStep() {
            if (state.creatorStep === 0 && !state.tempChar.name) { alert("Dê um nome ao personagem!"); return; }
            if (state.creatorStep === 2) {
                if (state.attrTab === 'COMPRA') { const cost = calculateTotalCost(state.tempChar.attributes); if (cost > 20) { alert("Você excedeu o limite de pontos de compra (20)!"); return; } } 
                else { const values = Object.values(state.tempChar.attributes); if (values.some(v => v === null)) { alert("Aloque todos os valores do pool para os atributos!"); return; } }
            }
            if (state.creatorStep === 3) {
                if (!state.tempChar.background) { alert("Selecione um Antecedente!"); return; }
                if (!state.tempChar.backgroundFeature) { alert("Escolha uma característica do Antecedente!"); return; }
            }
            if (state.creatorStep === 4) {
                const posCost = state.tempChar.inclinations.positive.reduce((acc, i) => acc + i.custo, 0);
                const negVal = state.tempChar.inclinations.negative.reduce((acc, i) => acc + i.valor, 0);
                const sortedPos = [...state.tempChar.inclinations.positive].sort((a,b) => b.custo - a.custo);
                const freeCost = sortedPos.length > 0 ? sortedPos[0].custo : 0;
                const paidCost = Math.max(0, posCost - freeCost);
                const balance = negVal - paidCost;
                
                if (balance < 0) { alert("Suas inclinações não estão balanceadas! Adicione negativas ou remova positivas extras."); return; }
                if (negVal > 10) { alert("O máximo de compensação negativa é 10 pontos."); return; }
                
                // Pre-apply background skills before next step
                applyBackgroundProficiencies();
            }
            if (state.creatorStep === 5) {
                 const bgSkillsText = state.tempChar.background ? SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background).proficiencias : "";
                 
                 // Validação: Exatamente 5 manuais
                 const currentManualCount = state.tempChar.skills.filter(s => !bgSkillsText.includes(s)).length;
                 
                 if (currentManualCount !== 5) { alert(`Você deve selecionar exatamente 5 perícias manuais (além das concedidas pelo antecedente). Atualmente: ${currentManualCount}`); return; }
            }
            state.creatorStep++; render();
        }

        function finishCreator() {
            // Apply allocations first to the tempChar attributes
            Object.entries(state.allocations).forEach(([key, val]) => {
                state.tempChar.attributes[key] += val;
            });

            // 1. Coleta Inventário do Antecedente
            const bgData = SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background);
            const initialInv = bgData ? bgData.equipamento.map(i => ({ name: i, qty: 1 })) : [];

            // 2. Cálculo de Atributos Finais (Base + Racial Fixos que não eram Escolha)
            const raceData = SYSTEM_DB.racas.find(r => r.nome === state.tempChar.race);
            const finalAttrs = { ...state.tempChar.attributes };
            
            // Only apply FIXED racial bonuses here if they weren't handled by the allocator
            if (raceData && typeof raceData.aumento_atributo === 'object') {
                const req = getBonusRequirements(state.tempChar.race);
                if (!req) { 
                    // Standard fixed bonuses (Human, Fanalis, etc)
                    Object.entries(raceData.aumento_atributo).forEach(([key, val]) => {
                        if (finalAttrs[key] !== undefined) {
                            finalAttrs[key] += val;
                        }
                    });
                } else if (req.type === 'choice') {
                    // Implicitly handled by allocator
                }
            }

            // 3. Recálculo de Vitais com Atributos Finais
            const modCon = getMod(finalAttrs.CON || 10);
            const modInt = getMod(finalAttrs.INT || 10);
            const modSab = getMod(finalAttrs.SAB || 10);

            // CORPO DE GIGANTE: Base +5 HP Logic
            const hasGiantBody = state.tempChar.inclinations.positive.some(i => i.nome === "Corpo de Gigante");
            let hpInitial = 15 + modCon;
            if (hasGiantBody) hpInitial += 5;

            const newChar = {
                id: generateId(), 
                name: state.tempChar.name, 
                class: state.tempChar.class, 
                race: state.tempChar.race, 
                background: state.tempChar.background, 
                backgroundFeature: state.tempChar.backgroundFeature,
                inclinations: state.tempChar.inclinations,
                level: 0, 
                xp: 0, 
                xp_next: 50, 
                money: 0,
                alignment: 'Neutro', // Default Alignment
                playerName: '', // Default Player Name
                attributes: {}, 
                skills: [...state.tempChar.skills, ...state.tempChar.otherSkills], 
                expertise: [], 
                raceTraits: state.tempChar.raceTraits || [],
                vitals: { 
                    hp: hpInitial, 
                    hpMax: hpInitial, 
                    aura: 100, 
                    auraMax: 100, 
                    san: 10 + modInt, 
                    sanMax: 10 + modInt, 
                    ca: 10 + modCon, 
                    rea: 7 + modSab,
                    desl: 9 
                },
                inventory: initialInv, 
                history: []
            };

            // Mapeia atributos finais para estrutura do objeto
            Object.entries(finalAttrs).forEach(([k,v]) => { 
                const hasSave = state.tempChar.skills.includes(`TR de ${k}`);
                newChar.attributes[k] = { value: v || 10, save: hasSave }; 
            });

            saveCharacter(newChar); 
            state.currentChar = newChar; 
            state.view = 'SHEET'; 
            state.activeTab = 'FICHA'; 
            render();
        }

        function setTab(tab) { state.activeTab = tab; render(); }
        function setRollMode(mode) { state.rollMode = mode; render(); }
        
        function updateSheetAttr(key, delta) { 
            state.currentChar.attributes[key].value += delta; 
            saveCharacter(state.currentChar); 
            render(); 
        }
        
        function toggleSave(key) { }

        function toggleAttrPopup(key) {
            if (state.openAttrPopup === key) state.openAttrPopup = null;
            else state.openAttrPopup = key;
            render();
        }

        function handleAttributeClick(key) {
            if (state.clickTimer) {
                clearTimeout(state.clickTimer);
                state.clickTimer = null;
                const attr = state.currentChar.attributes[key];
                rollDice(key, getMod(attr.value));
            } else {
                state.clickTimer = setTimeout(() => {
                    state.clickTimer = null;
                    toggleAttrPopup(key);
                }, 250);
            }
        }

        function handleShieldClick(key) {
            if (state.clickTimer) {
                clearTimeout(state.clickTimer);
                state.clickTimer = null;
                const skillName = `TR de ${key}`;
                rollSkill(skillName, key);
            } else {
                state.clickTimer = setTimeout(() => {
                    state.clickTimer = null;
                    handleSkillStatus(`TR de ${key}`);
                }, 250);
            }
        }
        
        function handleSkillStatus(skillName) {
            const char = state.currentChar;
            const isTrained = char.skills.includes(skillName);
            const isExpert = (char.expertise || []).includes(skillName);
            
            if (!isTrained) {
                if (confirm(`Deseja adicionar proficiência em ${skillName}?`)) {
                    state.currentChar.skills.push(skillName);
                    saveCharacter(state.currentChar);
                    render();
                }
            } else {
                state.skillSelectionModal = skillName;
                render();
            }
        }
        
        function closeSkillModal() { state.skillSelectionModal = null; render(); }
        
        function setSkillLevel(skillName, level) {
            const char = state.currentChar;
            if (!char.expertise) char.expertise = [];
            
            if (level === 'remove') {
                char.skills = char.skills.filter(s => s !== skillName);
                char.expertise = char.expertise.filter(s => s !== skillName);
            } else if (level === 'trained') {
                if (!char.skills.includes(skillName)) char.skills.push(skillName);
                char.expertise = char.expertise.filter(s => s !== skillName);
            } else if (level === 'expert') {
                if (!char.skills.includes(skillName)) char.skills.push(skillName);
                if (!char.expertise.includes(skillName)) char.expertise.push(skillName);
            }
            saveCharacter(char); closeSkillModal();
        }

        function updateVital(type, delta) { 
            const v = state.currentChar.vitals; 
            if (type === 'pv') v.hp += delta; 
            if (type === 'aura') v.aura += delta; 
            if (type === 'san') v.san += delta; 
            if (type === 'rea') {
                // Inicializa a reação no objeto de vitais caso não exista (baseado em SAB)
                if (v.rea === undefined) v.rea = 7 + getMod(state.currentChar.attributes.SAB.value);
                v.rea += delta;
            }
            saveCharacter(state.currentChar); 
            render(); 
        }

        function updateCharProperty(prop, val) {
            state.currentChar[prop] = val;
            saveCharacter(state.currentChar);
            render();
        }

        function changeLevel(delta) {
            const char = state.currentChar;
            const newLevel = char.level + delta;
            if (newLevel < 0) return;

            if (delta > 0) {
                // Level Up Logic with HP Calculation
                const hasGiantBody = char.inclinations.positive.some(i => i.nome === "Corpo de Gigante");
                const bonus = hasGiantBody ? 3 : 0;
                const conMod = getMod(char.attributes.CON.value);
                
                const rollInput = prompt(`SUBIR DE NÍVEL (${newLevel})\n\nInsira o valor da rolagem de vida (Dado de Vida da Classe):`, "5");
                if (rollInput === null) return; // Cancelled
                
                const roll = parseInt(rollInput) || 0;
                const totalGain = roll + conMod + bonus;
                
                char.vitals.hpMax += totalGain;
                char.vitals.hp += totalGain;
                
                alert(`Nível ${newLevel} alcançado!\n\nVida aumentada em ${totalGain}:\n• Rolagem: ${roll}\n• CON: ${conMod}\n• Corpo de Gigante: +${bonus}`);
            } else {
                if(!confirm("Reduzir nível não desfaz automaticamente os ganhos de vida. Continuar?")) return;
            }

            char.level = newLevel;
            saveCharacter(char);
            render();
        }

        function toggleSheetAccordion() {
            state.sheetOtherSkillsOpen = !state.sheetOtherSkillsOpen;
            render();
        }

        function handleArmorClick() {
            alert('Funcionalidade de Armadura em desenvolvimento.');
        }

        function addItem() { const name = document.getElementById('new-item-name').value; if (name) { state.currentChar.inventory.push({ name, qty: 1 }); saveCharacter(state.currentChar); render(); } }
        function updateItemQty(idx, delta) { const item = state.currentChar.inventory[idx]; item.qty += delta; if (item.qty <= 0) state.currentChar.inventory.splice(idx, 1); saveCharacter(state.currentChar); render(); }
        function updateMoney(val) { state.currentChar.money = parseInt(val) || 0; saveCharacter(state.currentChar); }
        
        function getRollResult(mode) {
             const r1 = Math.floor(Math.random() * 20) + 1;
             const r2 = Math.floor(Math.random() * 20) + 1;
             
             if (mode === 'NORMAL') return { total: r1, dice: [r1], label: 'Normal' };
             if (mode === 'VANTAGEM') return { total: Math.max(r1, r2), dice: [r1, r2], label: 'Vantagem' };
             if (mode === 'DESVANTAGEM') return { total: Math.min(r1, r2), dice: [r1, r2], label: 'Desvantagem' };
             if (mode === 'ÊNFASE') {
                 // Valor mais afastado de 10.5
                 const dist1 = Math.abs(r1 - 10.5);
                 const dist2 = Math.abs(r2 - 10.5);
                 return { total: dist1 > dist2 ? r1 : r2, dice: [r1, r2], label: 'Ênfase' };
             }
             return { total: r1, dice: [r1], label: 'Normal' };
        }

        function rollDice(attrName, mod) { 
            const roll = getRollResult(state.rollMode);
            const total = roll.total + mod; 
            const entry = { time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}), label: `${attrName} (${roll.label})`, dice: roll.dice.join(', '), mod: mod, total: total }; 
            state.currentChar.history.push(entry); 
            if (state.currentChar.history.length > 50) state.currentChar.history.shift(); 
            saveCharacter(state.currentChar); 
            
            const diceMsg = roll.dice.length > 1 ? `Dados: [${roll.dice.join(', ')}] -> Escolhido: ${roll.total}` : `Dado: [${roll.total}]`;
            alert(`🎲 ${attrName} (${roll.label})\n\n${diceMsg}\n\n${roll.total} + ${mod} = ${total}`); 
            state.activeTab = 'DADOS'; 
            render(); 
        }
        
        function rollSkill(skillName, attrKey) {
            const char = state.currentChar;
            const mod = getMod(char.attributes[attrKey].value);
            const isTrained = char.skills.includes(skillName);
            const isExpert = (char.expertise || []).includes(skillName);
            const pb = getProficiencyBonus(char.level);
            let totalMod = mod;
            let proficiencyLabel = "";
            if (isExpert) { totalMod += (pb * 2); proficiencyLabel = ` (Mod ${mod} + 2xPB ${pb*2})`; } 
            else if (isTrained) { totalMod += pb; proficiencyLabel = ` (Mod ${mod} + PB ${pb})`; } 
            else { proficiencyLabel = ` (Mod ${mod})`; }
            
            const roll = getRollResult(state.rollMode);
            const total = roll.total + totalMod;
            const entry = { time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}), label: `${skillName} ${isExpert ? "(Exp)" : ""} (${roll.label})`, dice: roll.dice.join(', '), mod: totalMod, total: total };
            state.currentChar.history.push(entry); if (state.currentChar.history.length > 50) state.currentChar.history.shift(); saveCharacter(state.currentChar);
            
            const diceMsg = roll.dice.length > 1 ? `Dados: [${roll.dice.join(', ')}] -> Escolhido: ${roll.total}` : `Dado: [${roll.total}]`;
            alert(`🎲 ${skillName} (${roll.label})\n\n${diceMsg}\n\n${roll.total} + ${totalMod}${proficiencyLabel} = ${total}`); 
            state.activeTab = 'DADOS'; 
            render();
        }

        function clearHistory() { if(confirm('Limpar histórico?')) { state.currentChar.history = []; saveCharacter(state.currentChar); render(); } }

        window.addEventListener('DOMContentLoaded', () => { loadCharacters(); setThemeColor('#00ff9d'); render(); });
    </script>
</body>
</html>
