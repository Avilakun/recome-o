<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunter x Hunter RPG Sheet</title>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['Orbitron', 'sans-serif'],
              sans: ['Rajdhani', 'sans-serif'],
            },
            colors: {
              'neon-green': '#00ff9d',
              'neon-blue': '#00f0ff',
              'neon-red': '#ff0055',
              'neon-yellow': '#ffe600',
              'neon-theme': 'var(--theme-color-hex, #00ff9d)',
              'neon-dark': '#0a0a0f',
              'neon-card': '#0e0e14',
            }
          }
        }
      }
    </script>

    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color-hex: #00ff9d;
            --theme-rgb: 0, 255, 157;
        }

        body {
            background-color: #050505;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* App-like feel */
        }

        /* Utilitários de Scroll */
        .custom-scrollbar { overflow-y: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animações simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs limpos */
        input, select { background: transparent; outline: none; }
        
        /* Containers */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px; /* Mobile width constraint on desktop */
            margin: 0 auto;
            background-color: #0a0a0f;
            position: relative;
            border-left: 1px solid #1f2937;
            border-right: 1px solid #1f2937;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Nen Hexagon Styles */
        .nen-node {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .nen-node:active {
            transform: scale(0.95) !important;
        }
        
        /* Pool Animation */
        .pool-item-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 2000px; /* Increased for content */
            opacity: 1;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Custom glow for shield */
        .shield-glow {
            filter: drop-shadow(0 0 4px currentColor);
        }
        .shield-expert {
            filter: drop-shadow(0 0 6px #ffe600);
        }
        
        /* Radio Button Custom Styling */
        .custom-radio:checked + div {
            border-color: var(--theme-color-hex);
            background-color: rgba(var(--theme-rgb), 0.1);
        }
        .custom-radio:checked + div .radio-indicator {
            background-color: var(--theme-color-hex);
            border-color: var(--theme-color-hex);
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- O conteúdo será injetado aqui via JavaScript -->
    </div>

    <!-- DB e Lógica -->
    <script>
        // --- DADOS DO SISTEMA ---
        const SYSTEM_DB = {
            classes: [
                { id: 'INTENSIFICAÇÃO', color: '#00ff9d', label: 'INTENSIFICAÇÃO', angle: 270, desc: 'Aura expressa maior poder, cura e resistência' }, 
                { id: 'TRANSFORMAÇÃO', color: '#d946ef', label: 'TRANSFORMAÇÃO', angle: 330, desc: 'Aura assume outra(s) propriedades(s)' },
                { id: 'MATERIALIZAÇÃO', color: '#ff0055', label: 'MATERIALIZAÇÃO', angle: 30, desc: 'Aura cria e altera matéria física' },
                { id: 'ESPECIALIZAÇÃO', color: '#00f0ff', label: 'ESPECIALIZAÇÃO', angle: 90, desc: 'Aura se apresenta de maneira inovadora' },
                { id: 'MANIPULAÇÃO', color: '#9ca3af', label: 'MANIPULAÇÃO', angle: 150, desc: 'Aura manipula objetos, matéria ou seres vivos' },
                { id: 'EMISSÃO', color: '#ffe600', label: 'EMISSÃO', angle: 210, desc: 'Aura se mantém forte fora do corpo e em longas distâncias' }
            ],
            xpTable: [50, 150, 350, 500, 800, 1000, 1500, 2500, 3200, 4000, 5000, 6500],
            racas: [
                // Humanos e Tribos
                {
                    nome: "Humano Comum",
                    descricao: "Raça mais comum no mundo, com variações de aparências e características físicas.",
                    aumento_atributo: { "FOR": 1, "DES": 1, "CON": 1, "INT": 1, "SAB": 1, "CAR": 1 },
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Fanalis",
                    descricao: "Composição física descomunal e cabelos vermelhos.",
                    aumento_atributo: { "FOR": 4, "CON": 2, "DES": -2, "INT": -2, "SAB": -2, "CAR": -2 },
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Gyudondond",
                    descricao: "Conhecidos como 'Homens Flauta'.",
                    aumento_atributo: "Distribua 3 pontos em qualquer atributo",
                    caracteristicas: [
                        { nome: "Alarido de Guerra", efeito: "Pode utilizar Intimidação como ação de movimento ao performar uma dança." }
                    ],
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                {
                    nome: "Imuchack",
                    descricao: "Guerreiros de até 4 metros que vivem em áreas gélidas.",
                    aumento_atributo: { "FOR": 2, "CON": 1, "INT": -2 },
                    opcoes_caracteristica: [
                        { nome: "Imunidade ao Frio", efeito: "Imune a baixas temperaturas e dano de gelo/frio." },
                        { nome: "Caça Aquática", efeito: "Sem penalidade de movimento para nadar; prende respiração por mais tempo." }
                    ],
                    fonte: "[3, 4]",
                    categoria: "Humanos e Tribos"
                },
                // Clãs Especiais
                {
                    nome: "Kurta",
                    descricao: "Aldeões conhecidos pelos Olhos Escarlates.",
                    aumento_atributo: { "INT_ou_SAB": 2 },
                    caracteristicas: [
                        { nome: "Mudança Escarlate", efeito: "+1 em todos os atributos enquanto os olhos estiverem vermelhos." },
                        { nome: "Caça Fascinante", efeito: "Pode ser procurado e caçado caso descubram sua origem." },
                        { nome: "Sofrimento Profundo", efeito: "Gatilhos emocionais ativam os olhos." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Clãs Especiais"
                },
                // Formigas Quimera
                {
                    nome: "Formiga Quimera",
                    descricao: "Iniciam sem Antecedentes. Não recebem aumento de atributo direto.",
                    aumento_atributo: "Nenhum (Ver Regra Especial)",
                    hierarquia_config: [
                        "Peões/Soldados: 1 slot traço",
                        "Oficiais: 2 slots traços",
                        "Líderes de Esquadrão: 3 slots traços",
                        "Guardas Reais: 5 slots traços"
                    ],
                    caracteristicas: [
                            { nome: "Arma natural", efeito: "Bico, Cauda, Chifres, Garras, Ferrão ou Tentáculos." },
                            { nome: "Corpo Adaptável", efeito: "Mudança corporal ou resistência a impacto." },
                            { nome: "Criatura de Cerco", efeito: "Dano crítico em construções e Constructos." },
                            { nome: "Destreza animal", efeito: "Vantagem em TR de Destreza." },
                            { nome: "Escudo Natural", efeito: "Resistência a dano cortante, perfurante e/ou impacto." },
                            { nome: "Evasão", efeito: "+2 na Reação de Esquiva." },
                            { nome: "Investida", efeito: "Aumenta dano ou aplica condição com base no deslocamento." },
                            { nome: "Rasante", efeito: "Ataque aéreo sem provocar AdO." },
                            { nome: "Regeneração", efeito: "Recuperação gradual de vida." },
                            { nome: "Telepatia", efeito: "Comunicação entre espécies." },
                            { nome: "Veneno/Peçonha", efeito: "Aplicação de veneno no contato." }
                    ],
                    fonte: "[1, 2]",
                    categoria: "Formigas Quimera"
                },
                // Modificados e Fantasia
                {
                    nome: "Wormorfos",
                    descricao: "Humanos modificados geneticamente ('povo verme').",
                    aumento_atributo: "Não recebem aumento",
                    caracteristicas: [
                        { nome: "Visão", efeito: "Ecolocalização de 3m; não depende de visão/audição no solo." },
                        { nome: "Corpo Malemolente", efeito: "Resistência a dano de impacto/concussão." },
                        { nome: "Enterrada", efeito: "Agarre contra CA; ação bônus para submergir." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Elfos e Meio-Elfos",
                    descricao: "Seres com herança feérica.",
                    aumento_atributo: "Escolha +2 em DES, SAB, INT ou CAR",
                    caracteristicas: [
                        { nome: "Ancestral Feérico", efeito: "Vantagem contra intimidação e persuasão." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Meio-Orcs",
                    descricao: "Guerreiros robustos com ancestralidade orc.",
                    aumento_atributo: { "FOR": 1, "CON": 1 },
                    caracteristicas: [
                        { nome: "Resistência Implacável", efeito: "Se reduzido a 0 HP, volta para 1 HP (Proficiência/dia)." }
                    ],
                    fonte: "[5, 6]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Anões",
                    descricao: "Seres robustos habitantes das montanhas.",
                    aumento_atributo: { "CON": 2 },
                    caracteristicas: [
                        { nome: "Resiliência Anã", efeito: "Vantagem contra venenos e resistência a dano de veneno." }
                    ],
                    fonte: "[7]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Draconatos",
                    descricao: "Humanoides com herança de dragões.",
                    aumento_atributo: "Escolha +2 em FOR, DES ou CAR",
                    caracteristicas: [
                        { nome: "Arma de Sopro", efeito: "2d6 dano (escala no nv 6 e 11).", tabela_ancestral: "Tipo de dragão define elemento" }
                    ],
                    fonte: "[7]",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Halflings (Pequeninos)",
                    descricao: "Pequenos e ágeis, conhecidos pela sorte.",
                    aumento_atributo: { "DES": 1, "INT": 2 },
                    opcoes_caracteristica: [
                        { nome: "Sortudo", efeito: "Rerolar 1 natural em ataques/testes." },
                        { nome: "Bravura", efeito: "Vantagem contra medo/intimidação." },
                        { nome: "Agilidade Halfling", efeito: "Mover-se pelo espaço de criaturas maiores." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Gnomos",
                    descricao: "Pequenos inventores e ilusionistas.",
                    aumento_atributo: "Escolha +2 em DES ou INT",
                    caracteristicas: [
                        { nome: "Esperteza Gnômica", efeito: "Vantagem em INT, SAB e CAR contra magia." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                {
                    nome: "Golias",
                    descricao: "Gigantes das montanhas com pele de pedra.",
                    aumento_atributo: "Escolha +2 em FOR ou CON",
                    caracteristicas: [
                        { nome: "Resistência de Pedra", efeito: "Reação para reduzir dano físico pela metade." }
                    ],
                    fonte: "Extra",
                    categoria: "Modificados e Fantasia"
                },
                // Tecnológicos e Sobrenaturais
                {
                    nome: "Neans (Andróides)",
                    descricao: "Constructos quase indistinguíveis de humanos.",
                    aumento_atributo: "Varia (Atualização de Disco)",
                    caracteristicas: [
                        { nome: "Atualização de Disco Rígido", efeito: "Altera todos os pontos de atributo no início de cada dia." },
                        { nome: "Curto Circuito", efeito: "Dano elétrico causa curto; sem exaustão biológica." }
                    ],
                    fonte: "[8, 9]",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                {
                    nome: "Vampiros",
                    descricao: "Seres noturnos que se alimentam de aura e sangue.",
                    aumento_atributo: { "INT": 2, "Físico": 1 },
                    caracteristicas: [
                        { nome: "Sugar Aura", efeito: "Ação Bônus, Mordida, Rouba 10% da aura." },
                        { nome: "Exposição Solar", efeito: "-CA quando exposto ao sol." }
                    ],
                    fonte: "[8, 9]",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                {
                    nome: "Djins",
                    descricao: "Criaturas de Nen Post-Mortem.",
                    aumento_atributo: "Escolha +2 em SAB ou CAR",
                    caracteristicas: [
                        { nome: "Interpretação Travessa", efeito: "Rolar dado aleatório com Restrições para ignorar sorte (1x/dia)." }
                    ],
                    fonte: "Extra",
                    categoria: "Tecnológicos e Sobrenaturais"
                },
                // Raças Incomuns
                {
                    nome: "Bugbears",
                    descricao: "Humanoides peludos e brutais.",
                    aumento_atributo: { "FOR": 2, "DES": 1 },
                    caracteristicas: [
                        { nome: "Ataque Surpresa", efeito: "+2d6 de dano no primeiro ataque contra alvo surpreso." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Dahllans (Meio-Dríades)",
                    descricao: "Seres ligados à natureza com pele de casca.",
                    aumento_atributo: { "SAB": 4, "INT": -1, "CAR": -1 },
                    caracteristicas: [
                        { nome: "Herança Natural", efeito: "Visão na penumbra 18m." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Firbolgs",
                    descricao: "Guardiões da natureza gentis e gigantes.",
                    aumento_atributo: { "SAB": 2, "FOR": 1 },
                    caracteristicas: [
                        { nome: "Passo Oculto", efeito: "Ação bônus para ficar invisível até o próximo turno." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                },
                {
                    nome: "Goblins",
                    descricao: "Pequenos, maliciosos e adaptáveis.",
                    aumento_atributo: "Escolha +2 em FOR, DES ou CAR",
                    caracteristicas: [
                        { nome: "Fúria do Pequeno Nanico", efeito: "Bônus de dano contra alvos maiores (1x/descanso)." }
                    ],
                    fonte: "Extra",
                    categoria: "Raças Incomuns"
                }
            ],
            antecedentes: [
              { nome: "Amigo dos Animais", descricao: "Pessoas que se importam com o equilíbrio da natureza...", proficiencias: "Adestrar Animais e Natureza", equipamento: ["Qualquer arma simples", "Qualquer arma simples", "Kit de Caça ou Kit Médico"], caracteristicas: [{nome: "Habitat Natural", efeito: "Animais te consideram não hostil."}, {nome: "Tarzan/Jane", efeito: "Entende linguagem animal básica."}, {nome: "Companheiro Inabalável", efeito: "Possui um pet auxiliar."}] },
              { nome: "Aristocrata", descricao: "Pessoas que entendem de riqueza, poder e privilégios...", proficiencias: "História e Religião", equipamento: ["Celular/Câmera", "Computador", "Mala", "Arma Simples"], caracteristicas: [{nome: "Posição Privilegiada", efeito: "Bem-vindo na alta sociedade."}, {nome: "Mauricinho / Patricinha", efeito: "Recebe mesada semanal."}] },
              { nome: "Artista", descricao: "Pessoas com as mais variadas capacidades de entretenimento...", proficiencias: "Kit Ofício e escolha 3 (Acrobacia, Atuação, Intuição, Prestidigitação)", equipamento: ["Mala/Mochila", "Câmera/Celular", "Kit Ofício"], caracteristicas: [{nome: "Tudo no @", efeito: "Pagar com merchandising."}, {nome: "Fascinar Espectadores", efeito: "Vantagem em CAR após performance."}] },
              { nome: "Assassino (Marcial)", descricao: "A arte de matar de forma rápida.", proficiencias: "Acrobacia e Furtividade", equipamento: ["Adaga", "Veneno", "Pochete", "Kit Disfarce/Falsificação"], caracteristicas: [{nome: "Eco do Ritmo", efeito: "Desvantagem para te atacar."}, {nome: "Sumidão", efeito: "Vantagem furtividade."}, {nome: "Máquina de Matar", efeito: "Dano dobrado furtivo."}] },
              { nome: "Caçador de Feras", descricao: "Busca criaturas desconhecidas e hostis.", proficiencias: "Natureza e Sobrevivência", equipamento: ["Espingarda/Tazer", "Kit Caça/Antídoto", "Arma Simples/Marcial", "Rede"], caracteristicas: [{nome: "Temos que Pegar!", efeito: "Vantagem rastrear feras."}, {nome: "Desbravador", efeito: "+2 Sobrevivência, sem penalidade terreno."}] },
              { nome: "Cientista/Técnico", descricao: "Estudo e dedicação experimental.", proficiencias: "Escolha 3 (História, Invest, Med, Nat, Prest, Rel, Sob)", equipamento: ["Arma Simples", "Mochila", "Kit Médico/Antídoto", "Kit Armas/Forense/Hacker"], caracteristicas: [{nome: "Explorar Fraqueza", efeito: "Vantagem após análise."}, {nome: "Mestre do Planejamento", efeito: "Ganha 1d6 em testes com itens 3x/dia."}] },
              { nome: "Criminoso", descricao: "Vivem à margem da lei.", proficiencias: "Enganação e Furtividade", equipamento: ["Arma Simples/Marcial", "Pochete", "Item variante (Celular/Kit)"], caracteristicas: [{nome: "Cleptomaníaco", efeito: "Inicia com celular roubado."}, {nome: "Estelionatário", efeito: "Kits de golpe."}, {nome: "Político Corrupto", efeito: "Infos privilegiadas."}, {nome: "Traficante", efeito: "Recursos financeiros ilícitos."}] },
              { nome: "Discípulo", descricao: "Orientado por um mestre.", proficiencias: "Kit Ofício e escolha 3 quaisquer", equipamento: ["Celular mestre", "Arma Simples/Marcial", "Kit Ofício"], caracteristicas: [{nome: "Abre-te Sésamo", efeito: "Acesso por influência do mestre."}, {nome: "Mateus 28.18-20", efeito: "Herança do mestre falecido."}] },
              { nome: "Guarda Costas", descricao: "Treinados para proteção.", proficiencias: "Atletismo e Intimidação", equipamento: ["Pistola", "Arma Simples/Marcial"], caracteristicas: [{nome: "Artista Marcial", efeito: "Dano desarmado 1d6."}, {nome: "Horário de Trabalho", efeito: "Foco em proteger alvo (+2 Percepção)."}] },
              { nome: "Líder", descricao: "Muda a sociedade e lidera aliados.", proficiencias: "Escolha 3 (Enganação, História, Invest, Persuasão)", equipamento: ["Pílulas", "Arma Simples", "Kit"], caracteristicas: [{nome: "Presença de Liderança", efeito: "Concede 1d4 a aliados."}] },
              { nome: "Marinheiro", descricao: "Navegou mares e tormentas.", proficiencias: "Atletismo e Percepção", equipamento: ["Corrente/Rede", "Arma Simples/Marcial"], caracteristicas: [{nome: "Grande Herói", efeito: "Transporte grátis, patente."}, {nome: "Imperador do Mar", efeito: "Equipamento extra e busca por NEN."}] },
              { nome: "Mentalista", descricao: "Conhecedores da mente.", proficiencias: "Intuição e (Enganação ou Persuasão)", equipamento: ["Arma Simples", "Kit Falsificação/Ofício"], caracteristicas: [{nome: "Perceptivo", efeito: "+2 Percepção."}, {nome: "Referência Bibliográfica", efeito: "Vantagem em CAR contra humanoides inteligentes."}] },
              { nome: "Negociante", descricao: "Lidar com público e oratória.", proficiencias: "Atuação, Persuasão, Prestidigitação", equipamento: ["Equipamento $2000", "Mala"], caracteristicas: [{nome: "Camelô", efeito: "Venda por valor total."}, {nome: "Pechincheiro", efeito: "Compra com 30% desconto."}] },
              { nome: "Ninja", descricao: "Esgueirando-se na noite.", proficiencias: "Furtividade e (Acrobacia ou Atletismo)", equipamento: ["Kit Ninja", "Kit Disfarce/Falsificação", "Explosivos", "Arma Simples/Marcial"], caracteristicas: [{nome: "Furtividade Superior", efeito: "Vantagem furtividade."}, {nome: "Clone das Sombras", efeito: "Cria clone sólido."}, {nome: "Substituição", efeito: "Reação para fuga."}] },
              { nome: "Órfão", descricao: "Cresceu nas ruas.", proficiencias: "Furtividade e (Intuição ou Prestidigitação)", equipamento: ["Kit Disfarce", "Kit Ofício/Armas", "Arma Simples"], caracteristicas: [{nome: "Segredos da Cidade", efeito: "Viagem rápida na cidade."}, {nome: "Zé-Pequeno", efeito: "Vantagem CAR com submundo."}, {nome: "Insignificante", efeito: "Ignorado por inimigos."}] },
              { nome: "Recluso", descricao: "Viveu isolado.", proficiencias: "Intuição, Medicina, Religião", equipamento: ["Arma Simples/Marcial", "Kit Armas/Caça"], caracteristicas: [{nome: "Monge", efeito: "Vantagem CON, dano 1d6."}, {nome: "Escravo", efeito: "Resistente a intimidação."}] },
              { nome: "Soldado", descricao: "A guerra na vida.", proficiencias: "Atletismo e (Intimidação ou Sobrevivência)", equipamento: ["Arma Simples/Marcial", "Kit Armas/Caça", "Mala"], caracteristicas: [{nome: "Batedor", efeito: "Vantagem Invest/Furt sozinho."}, {nome: "Médico de Combate", efeito: "Anula efeito colateral pílula."}, {nome: "Atirador de Elite", efeito: "Ignora cobertura, sharpshooter."}] },
              { nome: "Agente de Saúde", descricao: "Compromisso com a vida.", proficiencias: "Medicina e Percepção", equipamento: ["Arma Simples", "Kit Médico", "Kit Antídoto/Pílulas"], caracteristicas: [{nome: "Técnica Medicinal", efeito: "Cura + INTx2."}, {nome: "Primeiros Socorros", efeito: "+3 estabilizar, kit rende mais."}, {nome: "Médico Experimental", efeito: "Cria antídoto com natureza."}] },
              { nome: "Atleta", descricao: "Físico primoroso.", proficiencias: "Atletismo e (Acrobacia ou Intuição ou Percepção)", equipamento: ["Arma Simples", "Pílula"], caracteristicas: [{nome: "Bolt", efeito: "Movimento extra ou salto."}, {nome: "Implacável", efeito: "Rerolar TR falho."}] },
              { nome: "Chef", descricao: "Ótimo cozinheiro.", proficiencias: "Sobrevivência, Percepção, História", equipamento: ["Arma Simples", "Kit Cozinha", "Kit Caça"], caracteristicas: [{nome: "Sabor Único", efeito: "Bônus CAR com quem comeu."}, {nome: "Sabor de Casa", efeito: "Comida vale descanso curto."}] },
              { nome: "Circense", descricao: "Sobrevivia com performances.", proficiencias: "Acrobacia, Atuação, (Persuasão ou Enganação)", equipamento: ["Arma Simples", "Kit Disfarce", "Roupa Chique"], caracteristicas: [{nome: "Performance", efeito: "+5 Acrobacia/Prestidigitação show."}, {nome: "Mimetismo", efeito: "Imita sons e vozes."}] },
              { nome: "Gamer", descricao: "Telas eram o mundo.", proficiencias: "História, Intuição", equipamento: ["Arma Simples", "PEM", "Eletrônicos", "Kit Hacker"], caracteristicas: [{nome: "Dormir não dá XP", efeito: "Energético substitui descanso."}, {nome: "Procrastinador", efeito: "Faz tudo na metade do tempo."}] },
              { nome: "Investigador", descricao: "Detetive.", proficiencias: "Investigação e (Atuação/Intuição/Percepção/Enganação)", equipamento: ["Pistola", "Kit Forense", "Rádio"], caracteristicas: [{nome: "Detetive", efeito: "Info extra automática."}, {nome: "Rede de Contatos", efeito: "5 infos grátis/campanha."}] },
              { nome: "Piloto", descricao: "Manda bem no volante.", proficiencias: "Percepção, Intuição, Prestidigitação (Pilotar)", equipamento: ["Arma Simples", "Moto"], caracteristicas: [{nome: "Manobras Maníacas", efeito: "Desvia auto de menores."}, {nome: "Piloto de Fuga", efeito: "Dobra velocidade."}, {nome: "Experiência no Volante", efeito: "+3 pilotar."}] },
              { nome: "Religioso", descricao: "Procura fiéis.", proficiencias: "Religião, História", equipamento: ["Arma Simples", "Livro Sagrado"], caracteristicas: [{nome: "Pregar", efeito: "+3 Religião acalmar."}, {nome: "Orador Público", efeito: "Dobro proficiência discursando."}, {nome: "Benção Divina", efeito: "+1 Mod SAB temp."}] },
              { nome: "Mestre de RPG", descricao: "Narrador épico.", proficiencias: "Atuação, História, Enganação", equipamento: ["Celular/Dados", "Computador", "Casaco"], caracteristicas: [{nome: "Mestre do Improviso", efeito: "Imune surpresa, vantagem convencer improviso."}, {nome: "Sombra do Verdadeiro Mestre", efeito: "Uma fala vira verdade (Mestre decide)."}] }
            ],
            inclinacoes: {
                positivas: [
                    { nome: "Aliado", custo: 1, desc: "Possui velho amigo para ajuda." },
                    { nome: "Contatos (Info Rápida)", custo: 1, desc: "Info em 24h por $500." },
                    { nome: "Contatos (Info Confiança)", custo: 2, desc: "Infos completas e confiáveis." },
                    { nome: "Contatos (Info Barata)", custo: 1, desc: "Desconto na info rápida." },
                    { nome: "Corpo de Gigante", custo: 5, desc: "+5 HP inicial, +3/nível. Grande." },
                    { nome: "Empatia com Animais", custo: 1, desc: "Entende estado emocional animal." },
                    { nome: "Fôlego", custo: 2, desc: "Prende respiração 5-15 min." },
                    { nome: "Inventor", custo: 1, desc: "Modifica itens (Dano/Alvos/Peso/CA)." },
                    { nome: "Ligação com Máfia", custo: 3, desc: "Influência e favores mafiosos." },
                    { nome: "Sentidos Aguçados", custo: 1, desc: "+2 em um sentido específico." },
                    { nome: "Sorte Grande", custo: 3, desc: "Rerolar 1 dado por sessão." },
                    { nome: "Vida Estendida", custo: 3, desc: "Ciclo de vida +20 anos por fase." },
                    { nome: "Visão no Escuro", custo: 2, desc: "Vê 9m no escuro." }
                ],
                negativas: [
                    { nome: "Avareza", valor: 2, desc: "Dificuldade em gastar dinheiro." },
                    { nome: "Azar Grande", valor: 3, desc: "Rerolar primeiro crítico da sessão." },
                    { nome: "Desatencioso", valor: 1, desc: "-1 em testes de Influência." },
                    { nome: "Dívida", valor: 3, desc: "Deve favor perigoso a alguém." },
                    { nome: "Esquecido", valor: 1, desc: "Esquece nomes/lugares sem item." },
                    { nome: "Honestidade", valor: 2, desc: "Obrigado a seguir a lei." },
                    { nome: "Indeciso", valor: 5, desc: "-3 Inic. Teste para agir." },
                    { nome: "Inimigo (Fraco)", valor: 1, desc: "Inimigo atrapalha." },
                    { nome: "Inimigo (Rival)", valor: 2, desc: "Rival tenta te vencer." },
                    { nome: "Inimigo (Poderoso)", valor: 5, desc: "Vilão quer te matar/recrutar." },
                    { nome: "Inveja", valor: 1, desc: "Reação ruim a quem é melhor." },
                    { nome: "Perda Auditiva", valor: 1, desc: "-3 testes de Audição." },
                    { nome: "Veracidade", valor: 2, desc: "Passa mal ao mentir." }
                ]
            },
            skills: [
                'TR de FOR', 'TR de DES', 'TR de CON', 'TR de INT', 'TR de SAB', 'TR de CAR',
                'Acrobacia', 'Arcanismo', 'Atletismo', 'Atuação', 'Enganação',
                'Furtividade', 'História', 'Intimidação', 'Intuição', 'Investigação',
                'Lidar com Animais', 'Medicina', 'Natureza', 'Percepção', 'Persuasão',
                'Prestidigitação', 'Religião', 'Sobrevivência'
            ],
            otherSkills: [
                'Armas de Cerco',
                'Equipamentos de Proteção e Armaduras Médias',
                'Equipamentos de Proteção e Armaduras Pesadas',
                'Equipamentos Improvisados/Manufaturados (Bugigangas e Armas de Hatsus Criativos)',
                'Científicas/Explosivas',
                'Etiqueta', 'Pilotagem', 'Tecnologia', 'Ocultismo', 'Falsificação', 'Jogos', 'Instrumentos',
                'Linguagem: Hunter Antigo', 'Linguagem: Inglês', 'Linguagem: Japonês'
            ],
            pointBuyCosts: {
                30: 50, 29: 47, 28: 44, 27: 41, 26: 38, 25: 35, 24: 32, 23: 29, 22: 26, 21: 23,
                20: 20, 19: 17, 18: 14, 17: 11, 16: 8, 15: 6, 14: 4, 13: 3, 12: 2, 11: 1,
                10: 0, 9: -1, 8: -2, 7: -4, 6: -6, 5: -8, 4: -11, 3: -14, 2: -17, 1: -20
            }
        };

        const SKILL_MAP = {
            'FOR': ['Atletismo'],
            'DES': ['Acrobacia', 'Furtividade', 'Prestidigitação'],
            'CON': [],
            'INT': ['Arcanismo', 'História', 'Investigação', 'Natureza', 'Religião'],
            'SAB': ['Lidar com Animais', 'Intuição', 'Medicina', 'Percepção', 'Sobrevivência'],
            'CAR': ['Atuação', 'Enganação', 'Intimidação', 'Persuasão']
        };

        // --- ESTADO GLOBAL ---
        const state = {
            view: 'LIST', // LIST, CREATOR, SHEET
            activeTab: 'FICHA',
            characters: [],
            currentChar: null,
            creatorStep: 0,
            tempChar: null, // Usado no criador
            attrTab: 'ROLAGEM',
            attrMethodLocked: false,
            attrPool: [], 
            selectedPoolIdx: null,
            openSkillAccordion: null, // Inicia fechado
            openAttrPopup: null, // Popup de atributo na ficha
            skillSelectionModal: null, // Modal de decisão de proficiência
            clickTimer: null, // Para diferenciar clique unico e duplo
            bgSelected: null // Para controle de UI do antecedente
        };

        // --- GERENCIAMENTO DE STORAGE ---
        function loadCharacters() {
            const chars = [];
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('hxhrpg_')) {
                    try { chars.push(JSON.parse(localStorage.getItem(key))); } catch(e) {}
                }
            }
            state.characters = chars.sort((a,b) => new Date(b.lastMod) - new Date(a.lastMod));
        }

        function saveCharacter(char) {
            char.lastMod = new Date().toISOString();
            localStorage.setItem('hxhrpg_' + char.id, JSON.stringify(char));
            loadCharacters();
        }

        function deleteCharacter(id) {
            if(confirm('Tem certeza que deseja apagar esta ficha?')) {
                localStorage.removeItem('hxhrpg_' + id);
                loadCharacters();
                if (state.currentChar && state.currentChar.id === id) {
                    state.view = 'LIST';
                    state.currentChar = null;
                }
                render();
            }
        }

        // --- UTILITÁRIOS ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function getMod(val) { return val ? Math.floor((val - 10) / 2) : 0; }
        function getModStr(val) { const m = getMod(val); return m >= 0 ? `+${m}` : `${m}`; }
        function getPointBuyCost(val) { return SYSTEM_DB.pointBuyCosts[val] !== undefined ? SYSTEM_DB.pointBuyCosts[val] : 0; }
        function getProficiencyBonus(level) { return Math.max(2, Math.floor((level - 1) / 4) + 2); }
        
        function calculateTotalCost(attrs) {
            let total = 0;
            Object.values(attrs).forEach(val => { total += getPointBuyCost(val); });
            return total;
        }

        function setThemeColor(hex) {
            document.documentElement.style.setProperty('--theme-color-hex', hex);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if(result) {
                const r = parseInt(result[1], 16);
                const g = parseInt(result[2], 16);
                const b = parseInt(result[3], 16);
                document.documentElement.style.setProperty('--theme-rgb', `${r}, ${g}, ${b}`);
            }
        }

        function getNenPercentages(selectedId) {
            const types = ['INTENSIFICAÇÃO', 'TRANSFORMAÇÃO', 'MATERIALIZAÇÃO', 'ESPECIALIZAÇÃO', 'MANIPULAÇÃO', 'EMISSÃO'];
            const selectedIndex = types.indexOf(selectedId);
            const matrix = {};
            types.forEach((type, index) => {
                let diff = Math.abs(index - selectedIndex);
                if (diff > 3) diff = 6 - diff;
                let pct = 0;
                if (diff === 0) pct = 100; else if (diff === 1) pct = 80; else if (diff === 2) pct = 60; else if (diff === 3) pct = 40;
                if (type === 'ESPECIALIZAÇÃO' && diff !== 0) {
                    pct = 0;
                    if (selectedId === 'MATERIALIZAÇÃO' || selectedId === 'MANIPULAÇÃO') pct = 1;
                }
                matrix[type] = pct;
            });
            return matrix;
        }

        // --- RENDERIZADORES ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.view === 'LIST') renderList(app);
            else if (state.view === 'CREATOR') renderCreator(app);
            else if (state.view === 'SHEET') renderSheet(app);
            if (window.lucide) lucide.createIcons();
        }

        function renderList(container) {
            setThemeColor('#00ff9d');
            const level0 = state.characters.filter(c => c.level === 0);
            const levelHigh = state.characters.filter(c => c.level > 0);
            let html = `
                <div class="p-6 flex flex-col h-full fade-in">
                    <div class="text-center mb-8 mt-4">
                        <h1 class="font-display font-black text-3xl tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">HxH 5e RPG</h1>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Banco de Dados</p>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar space-y-8 pb-20">
            `;
            html += `<div><div class="flex items-center gap-2 mb-3"><i data-lucide="circle-dashed" class="text-gray-500 w-4 h-4"></i><h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Iniciantes (Nível 0)</h2></div>`;
            if (level0.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhuma ficha de nível 0 encontrada.</div>`;
            else {
                level0.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-gray-600 transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')"><div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="user" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">${char.race} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div><div><div class="flex items-center gap-2 mb-3"><i data-lucide="zap" class="text-neon-green w-4 h-4"></i><h2 class="text-xs font-bold text-neon-green uppercase tracking-widest">Usuários de Nen (Nível 1-12)</h2></div>`;
            if (levelHigh.length === 0) html += `<div class="h-24 flex items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 text-xs bg-gray-900/20">Nenhum Hunter registrado.</div>`;
            else {
                levelHigh.forEach(char => {
                    const color = SYSTEM_DB.classes.find(c => c.id === char.class)?.color || '#fff';
                    html += `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center gap-4 hover:border-[${color}] transition-all cursor-pointer relative group mb-2" onclick="selectChar('${char.id}')" style="border-left: 3px solid ${color}"><div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center border border-gray-700 text-gray-500"><i data-lucide="shield" size="16"></i></div><div class="flex-1"><h3 class="font-display font-bold text-white text-base">${char.name}</h3><p class="text-[10px] text-gray-400 uppercase">LVL ${char.level} • <span style="color:${color}">${char.class}</span></p></div><button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="p-2 text-gray-600 hover:text-neon-red transition-colors"><i data-lucide="trash-2" size="16"></i></button></div>`;
                });
            }
            html += `</div></div><div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent max-w-[480px] mx-auto"><button onclick="startCreator()" class="w-full py-4 bg-neon-green text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 shadow-[0_0_20px_rgba(0,255,157,0.4)] transition-all flex items-center justify-center gap-2"><i data-lucide="plus"></i> CRIAR NOVA FICHA</button></div></div>`;
            container.innerHTML = html;
        }

        function renderCreator(container) {
            if (!state.tempChar) {
                state.tempChar = { name: '', class: 'INTENSIFICAÇÃO', race: 'Humano Comum', attributes: { FOR:10, DES:10, CON:10, INT:10, SAB:10, CAR:10 }, skills: [], otherSkills: [], raceTraits: [], background: null, backgroundFeature: null, inclinations: { positive: [], negative: [] } };
            }
            if (!state.tempChar.raceTraits) state.tempChar.raceTraits = [];
            if (!state.tempChar.inclinations) state.tempChar.inclinations = { positive: [], negative: [] };
            
            const step = state.creatorStep;
            let contentHtml = '';
            let title = '';

            if (step === 0) {
                title = 'IDENTIDADE';
                const percentages = getNenPercentages(state.tempChar.class);
                const currentClass = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class);
                const hexNodes = SYSTEM_DB.classes.map(c => {
                    const isSelected = state.tempChar.class === c.id;
                    const pct = percentages[c.id];
                    const rad = (c.angle * Math.PI) / 180;
                    const radius = 35; 
                    const left = 50 + (radius * Math.cos(rad));
                    const top = 50 + (radius * Math.sin(rad));
                    const nodeStyle = isSelected ? `background-color: ${c.color}; border-color: ${c.color}; color: #000; box-shadow: 0 0 20px ${c.color}80;` : `background-color: #0a0a0f; border-color: ${c.color}; color: ${c.color};`;
                    const transformScale = isSelected ? 'scale(1.15)' : 'scale(1.0)';
                    const zIndex = isSelected ? 'z-10' : 'z-0';
                    return `<div class="absolute w-20 h-20 flex items-center justify-center cursor-pointer nen-node ${zIndex}" style="top: ${top}%; left: ${left}%; transform: translate(-50%, -50%) ${transformScale};" onclick="selectNenType('${c.id}')"><div class="w-14 h-14 rounded-full border-2 flex items-center justify-center transition-all duration-300 relative shadow-lg" style="${nodeStyle}"><span class="font-display font-bold text-lg leading-none">${pct}%</span></div></div>`;
                }).join('');
                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="relative"><label class="text-[10px] font-bold text-neon-theme uppercase tracking-widest mb-2 block pl-2">Nome do Candidato</label><input type="text" id="creator-name" value="${state.tempChar.name}" placeholder="INSIRA SEU NOME..." class="w-full bg-gray-900 border border-gray-700 rounded-xl p-4 text-white text-center font-display font-bold tracking-wider focus:border-neon-theme focus:shadow-[0_0_15px_rgba(var(--theme-rgb),0.2)] transition-all uppercase placeholder-gray-600" oninput="state.tempChar.name = this.value"></div><div class="text-center transition-all"><h3 class="text-3xl font-display font-black tracking-widest uppercase drop-shadow-[0_0_15px_rgba(var(--theme-rgb),0.6)]" style="color: ${currentClass.color}; text-shadow: 0 0 10px ${currentClass.color}40;">${state.tempChar.class}</h3></div><div class="bg-gray-900/20 rounded-full border border-gray-800/50 p-4 aspect-square relative max-w-[360px] mx-auto"><svg class="absolute inset-0 w-full h-full pointer-events-none opacity-30" viewBox="0 0 100 100"><polygon points="50,15 80.3,32.5 80.3,67.5 50,85 19.7,67.5 19.7,32.5" fill="none" stroke="currentColor" stroke-width="0.8" class="text-white" /><line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="32.5" x2="19.7" y2="67.5" stroke="currentColor" stroke-width="0.5" class="text-white" /><line x1="80.3" y1="67.5" x2="19.7" y2="32.5" stroke="currentColor" stroke-width="0.5" class="text-white" /></svg>${hexNodes}</div><div class="text-center px-4 bg-gray-900/50 p-3 rounded-xl border border-gray-800/50"><p class="text-sm font-medium text-gray-300 italic">"${currentClass.desc}"</p></div></div>`;
            }
            else if (step === 1) {
                title = 'RAÇA';
                contentHtml = `<div class="space-y-4 animate-in slide-in-from-right duration-300">`;
                let lastCat = '';
                SYSTEM_DB.racas.forEach(r => {
                    if (r.categoria && r.categoria !== lastCat) {
                        contentHtml += `<div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-4 mb-2 pl-2">${r.categoria}</div>`;
                        lastCat = r.categoria;
                    }
                    const isSelected = state.tempChar.race === r.nome;
                    const borderColor = isSelected ? 'border-neon-theme ring-2 ring-neon-theme/20' : 'border-gray-800';
                    const bgColor = isSelected ? 'bg-neon-theme/5' : 'bg-gray-900';
                    const textColor = isSelected ? 'text-neon-theme' : 'text-white';
                    
                    let attrHtml = typeof r.aumento_atributo === 'object' ? Object.entries(r.aumento_atributo).map(([k,v]) => `<span class="bg-gray-900 border border-gray-700 rounded-full px-3 py-1 text-[10px] font-bold text-gray-300 shadow-sm flex items-center gap-1">${k.replace(/_/g, ' ')} <span class="${v>0?'text-neon-theme':'text-red-500'}">${v>0?'+':''}${v}</span></span>`).join('') : `<span class="text-xs text-gray-400 italic">${r.aumento_atributo}</span>`;
                    
                    let featuresHtml = '';
                    if (r.nome === 'Formiga Quimera') {
                         const selectedCount = (state.tempChar.raceTraits || []).length;
                         const maxTraits = 3;
                         featuresHtml = `<div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2 flex justify-between">Características da Espécie <span id="trait-counter" class="${selectedCount >= maxTraits ? 'text-neon-theme' : 'text-gray-500'}">(${selectedCount}/${maxTraits})</span></h4><div class="bg-gray-950/50 rounded-lg p-2 border border-gray-800/50 grid grid-cols-1 gap-2">${r.caracteristicas.map(f => {
                                const isTraitSelected = (state.tempChar.raceTraits || []).includes(f.nome);
                                return `<div id="trait-btn-${f.nome.replace(/\s/g,'-')}" onclick="event.stopPropagation(); toggleRaceTrait('${f.nome}')" class="p-2 rounded border cursor-pointer transition-all flex items-start gap-2 ${isTraitSelected ? 'bg-neon-theme/10 border-neon-theme text-white' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800'}"><div class="mt-0.5 pointer-events-none">${isTraitSelected ? '<i data-lucide="check-square" size="14"></i>' : '<i data-lucide="square" size="14"></i>'}</div><div class="pointer-events-none"><span class="text-[10px] font-bold block">${f.nome}</span><span class="text-[9px] block leading-tight opacity-70">${f.efeito || f.mecanica || ''}</span></div></div>`;
                            }).join('')}</div></div>`;
                    } else {
                        const features = [...(r.caracteristicas || []), ...(r.opcoes_caracteristica || [])];
                        if (features.length > 0) featuresHtml = `<div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2">Características</h4><div class="bg-gray-950/50 rounded-lg p-3 border border-gray-800/50">${features.map(f => `<div class="mb-2 last:mb-0"><span class="text-[11px] font-bold text-gray-300 block">${f.nome}</span><span class="text-[10px] text-gray-500 block leading-tight">${f.efeito || f.mecanica || ''} ${f.tabela_ancestral ? '('+f.tabela_ancestral+')' : ''}</span></div>`).join('')}</div></div>`;
                    }
                    
                    const checkIcon = `<span id="check-${r.nome.replace(/\s/g,'-')}" class="transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'} flex items-center"><i data-lucide="check" size="16"></i></span>`;
                    const chevronClass = isSelected ? 'rotate-0' : '-rotate-90';

                    contentHtml += `
                    <div id="race-card-${r.nome.replace(/\s/g,'-')}" onclick="selectRace('${r.nome}')" class="w-full text-left rounded-2xl border ${borderColor} ${bgColor} transition-all duration-300 cursor-pointer group relative overflow-hidden mb-2">
                        <div class="p-4 flex items-start justify-between">
                            <div><h3 class="font-display font-bold text-lg uppercase tracking-wider ${textColor} flex items-center gap-2">${r.nome} ${checkIcon}</h3><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1 pr-6 leading-tight">${r.descricao}</p></div>
                            <div id="chevron-${r.nome.replace(/\s/g,'-')}" class="transition-transform duration-300 ${chevronClass} ${isSelected ? 'text-neon-theme' : 'text-gray-600'}"><i data-lucide="chevron-down" size="20"></i></div>
                        </div>
                        <div id="race-content-${r.nome.replace(/\s/g,'-')}" class="accordion-content px-4 ${isSelected ? 'open pb-4' : ''}"><div class="h-px w-full bg-gray-800 mb-4"></div><div class="mb-4"><h4 class="text-[9px] font-black text-neon-theme uppercase tracking-widest mb-2">Bônus de Atributo</h4><div class="flex flex-wrap gap-2">${attrHtml}</div></div>${featuresHtml}<div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500"><div class="col-span-2 text-right italic text-gray-600">Fonte: ${r.fonte}</div></div></div>
                    </div>`;
                });
                contentHtml += `</div>`;
            }
            else if (step === 2) {
                title = 'ATRIBUTOS';
                const totalCost = calculateTotalCost(state.tempChar.attributes);
                const maxCost = 20;

                const tabBtn = (id, label, icon) => {
                    const isActive = state.attrTab === id;
                    const isLocked = state.attrMethodLocked && !isActive;
                    let baseClasses = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest border rounded-lg transition-all flex items-center justify-center gap-2";
                    let stateClasses = isActive ? "bg-neon-theme/20 border-neon-theme text-neon-theme shadow-[0_0_10px_rgba(var(--theme-rgb),0.2)]" : (isLocked ? "bg-gray-900 border-gray-800 text-gray-600 opacity-50 cursor-not-allowed" : "bg-gray-900 border-gray-800 text-gray-500 hover:text-gray-300 cursor-pointer");
                    return `<button onclick="${isLocked ? '' : `setAttrTab('${id}')`}" class="${baseClasses} ${stateClasses}">${isLocked ? '<i data-lucide="lock" size="14"></i>' : `<i data-lucide="${icon}" size="14"></i>`} ${label}</button>`;
                };

                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="bg-[#2a0e14] border border-neon-red/30 p-4 rounded-xl text-center relative overflow-hidden shadow-[0_0_15px_rgba(255,0,85,0.1)]"><p class="text-[10px] text-neon-red font-bold uppercase tracking-widest flex items-center justify-center gap-2 relative z-10"><i data-lucide="alert-triangle" size="14"></i> Atenção: Apenas um modo pode ser escolhido. Ao iniciar, os outros serão bloqueados.</p></div><div class="flex gap-2 p-1 bg-gray-900 rounded-xl border border-gray-800">${tabBtn('ROLAGEM', 'Rolagem', 'dices')}${tabBtn('ARRAY', 'Array', 'list')}${tabBtn('COMPRA', 'Compra', 'coins')}</div>`;

                if (state.attrTab === 'ROLAGEM' || state.attrTab === 'ARRAY') {
                    contentHtml += `<div class="space-y-4">${!state.attrMethodLocked ? (state.attrTab === 'ROLAGEM' ? `<button onclick="rollAllStats()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl font-display font-bold text-white tracking-widest hover:brightness-110 active:scale-95 transition-all shadow-lg flex items-center justify-center gap-2 border border-white/10"><i data-lucide="dices"></i> ROLAR ATRIBUTOS</button>` : `<button onclick="applyStandardArray()" class="w-full py-4 bg-neon-blue/10 text-neon-blue border border-neon-blue/50 rounded-xl font-display font-bold tracking-widest hover:bg-neon-blue hover:text-black active:scale-95 transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(0,240,255,0.2)]"><i data-lucide="list"></i> USAR ARRAY PADRÃO</button>`) : ''}${state.attrMethodLocked ? `<div class="bg-gray-900/50 border border-gray-700 rounded-xl p-4"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 text-center">Banco de Atributos</p>${state.attrPool.length === 0 ? '<div class="text-center text-xs text-gray-600 py-2 italic">Todos os valores alocados.</div>' : `<div class="flex flex-wrap gap-2 justify-center">${state.attrPool.map((val, idx) => `<button onclick="selectPoolItem(${idx})" class="w-10 h-10 rounded-lg font-display font-bold text-lg flex items-center justify-center transition-all pool-item-enter ${state.selectedPoolIdx === idx ? 'bg-neon-theme text-black shadow-[0_0_10px_var(--theme-color-hex)] scale-110' : 'bg-gray-800 text-white hover:bg-gray-700'}">${val}</button>`).join('')}</div>`}<p class="text-[9px] text-gray-500 text-center mt-3">${state.selectedPoolIdx !== null ? 'Selecione um atributo abaixo para aplicar.' : 'Clique em um número para selecionar.'}</p></div>` : ''}</div>`;
                } else if (state.attrTab === 'COMPRA') {
                     contentHtml += `<div id="buy-container" class="bg-gray-900 border border-gray-800 p-4 rounded-xl relative overflow-hidden"><div class="flex justify-between items-center relative z-10"><span class="text-xs text-gray-400 uppercase font-bold tracking-widest">Pontos Gastos</span><div class="flex items-center gap-1"><span id="buy-total" class="font-display font-bold text-2xl ${totalCost > maxCost ? 'text-red-500' : 'text-white'} transition-all">${totalCost}</span><span class="font-display text-gray-600 text-lg">/ ${maxCost}</span></div></div><div class="absolute bottom-0 left-0 h-1 bg-gray-800 w-full"><div id="buy-bar" class="h-full ${totalCost > maxCost ? 'bg-red-500' : 'bg-neon-theme'} transition-all duration-300" style="width: ${Math.min(100, (totalCost/maxCost)*100)}%"></div></div></div>`;
                }

                contentHtml += `<div class="grid grid-cols-2 gap-3">${Object.keys(state.tempChar.attributes).map(attr => {
                    const val = state.tempChar.attributes[attr];
                    const isPoolMode = state.attrTab !== 'COMPRA';
                    return `<div class="bg-gray-900 rounded-xl p-3 border transition-all relative overflow-hidden group ${state.selectedPoolIdx !== null && isPoolMode ? 'border-neon-theme/50 cursor-pointer hover:border-neon-theme' : 'border-gray-800'} ${val === null && isPoolMode ? 'border-dashed' : ''}" onclick="${isPoolMode ? (val === null ? `assignToSlot('${attr}')` : `returnToPool('${attr}')`) : ''}"><div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${attr}</span>${val !== null ? `<span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 rounded border border-gray-700">Mod ${getModStr(val)}</span>` : ''}</div>${state.attrTab === 'COMPRA' ? `<div class="flex items-center justify-between"><button onclick="buyStat('${attr}', -1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="minus" size="14"></i></button><span id="attr-val-${attr}" class="text-xl font-display font-bold text-white transition-all">${val}</span><button onclick="buyStat('${attr}', 1)" class="w-8 h-8 bg-black/30 rounded text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-colors"><i data-lucide="plus" size="14"></i></button></div><div class="text-center mt-1"><span class="text-[8px] text-gray-600">Custo: ${getPointBuyCost(val)}</span></div>` : `<div class="text-center py-1 h-10 flex items-center justify-center">${val !== null ? `<span class="text-3xl font-display font-bold text-white transition-colors pool-item-enter">${val}</span>` : `<span class="text-[10px] text-gray-700 uppercase font-bold tracking-widest">Vazio</span>`}</div>${isPoolMode && val !== null ? '<div class="absolute inset-0 bg-red-500/10 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"><i data-lucide="x" class="text-red-500"></i></div>' : ''}`}</div>`;
                }).join('')}</div></div>`;
            }
            else if (step === 3) {
                // ANTECEDENTES
                title = 'ANTECEDENTE';
                contentHtml = `<div class="space-y-4 animate-in slide-in-from-right duration-300">`;
                
                SYSTEM_DB.antecedentes.forEach(bg => {
                    const isSelected = state.tempChar.background === bg.nome;
                    const borderColor = isSelected ? 'border-neon-blue ring-2 ring-neon-blue/20' : 'border-gray-800';
                    const bgColor = isSelected ? 'bg-neon-blue/5' : 'bg-gray-900';
                    const textColor = isSelected ? 'text-neon-blue' : 'text-white';
                    
                    const checkIcon = `<span class="transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'} flex items-center"><i data-lucide="check" size="16" class="text-neon-blue"></i></span>`;
                    const chevronClass = isSelected ? 'rotate-0' : '-rotate-90';

                    contentHtml += `
                    <div id="bg-card-${bg.nome.replace(/\s/g,'-')}" onclick="selectBackground('${bg.nome}')" class="w-full text-left rounded-2xl border ${borderColor} ${bgColor} transition-all duration-300 cursor-pointer group relative overflow-hidden mb-2">
                        <div class="p-4 flex items-start justify-between">
                            <div><h3 class="font-display font-bold text-lg uppercase tracking-wider ${textColor} flex items-center gap-2">${bg.nome} ${checkIcon}</h3><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1 pr-6 leading-tight line-clamp-1">${bg.descricao}</p></div>
                            <div class="transition-transform duration-300 ${chevronClass} ${isSelected ? 'text-neon-blue' : 'text-gray-600'}"><i data-lucide="chevron-down" size="20"></i></div>
                        </div>
                        <div class="accordion-content px-4 ${isSelected ? 'open pb-4' : ''}">
                            <div class="h-px w-full bg-gray-800 mb-4"></div>
                            <p class="text-xs text-gray-400 italic mb-4">"${bg.descricao}"</p>
                            
                            <!-- Proficiências -->
                            <div class="bg-gray-950/50 border border-cyan-500/30 rounded-xl p-3 mb-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                                <h4 class="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-1 flex items-center gap-2"><i data-lucide="graduation-cap" size="12"></i> Proficiências</h4>
                                <p class="text-xs text-gray-300 font-bold">${bg.proficiencias}</p>
                                <p class="text-[9px] text-gray-500 italic mt-1">Estas perícias serão adicionadas automaticamente.</p>
                            </div>

                            <!-- Equipamento -->
                            <div class="bg-gray-950/50 border border-green-500/30 rounded-xl p-3 mb-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                <h4 class="text-[10px] font-black text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="backpack" size="12"></i> Equipamento</h4>
                                <div class="space-y-1">
                                    ${bg.equipamento.map(item => `<div class="bg-gray-900 border border-gray-800 px-2 py-1 rounded text-[10px] text-gray-300 font-mono">${item}</div>`).join('')}
                                </div>
                            </div>

                            <!-- Características (Escolha) -->
                            <div class="bg-gray-950/50 border border-purple-500/30 rounded-xl p-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                                <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="star" size="12"></i> Escolha uma Característica</h4>
                                <div class="space-y-2">
                                    ${bg.caracteristicas.map(c => `
                                        <label class="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors">
                                            <div class="relative flex items-center mt-0.5">
                                                <input type="radio" name="bg-feature" value="${c.nome}" class="peer sr-only" onclick="selectBackgroundFeature('${c.nome}')" ${state.tempChar.backgroundFeature === c.nome ? 'checked' : ''}>
                                                <div class="w-4 h-4 border-2 border-gray-600 rounded-full peer-checked:border-purple-500 peer-checked:bg-purple-500/20 transition-all flex items-center justify-center">
                                                    <div class="w-2 h-2 rounded-full bg-transparent peer-checked:bg-purple-500 transition-colors radio-indicator"></div>
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <span class="text-xs font-bold text-white block ${state.tempChar.backgroundFeature === c.nome ? 'text-purple-400' : ''}">${c.nome}</span>
                                                <span class="text-[10px] text-gray-500 leading-tight block">${c.efeito}</span>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                contentHtml += `</div>`;
            }
            else if (step === 4) {
                // INCLINAÇÕES
                title = 'INCLINAÇÃO';
                const posCost = state.tempChar.inclinations.positive.reduce((acc, i) => acc + i.custo, 0);
                const negVal = state.tempChar.inclinations.negative.reduce((acc, i) => acc + i.valor, 0);
                // Lógica: 1 grátis + negativos >= positivos extras (total positivos - 1 grátis de maior valor)
                // Simplificação: Saldo = (1 + Pontos Negativos) - (Custo Positivo) >= 0.
                // Mas a regra diz: "1ª Grátis (Maior Valor)". Então subtraímos o maior custo positivo do total de custo positivo antes de comparar.
                const sortedPos = [...state.tempChar.inclinations.positive].sort((a,b) => b.custo - a.custo);
                const freeCost = sortedPos.length > 0 ? sortedPos[0].custo : 0;
                const paidCost = Math.max(0, posCost - freeCost);
                const balance = (negVal) - paidCost; // Se >= 0, tá OK. Se < 0, falta compensar.
                const isOk = balance >= 0;

                contentHtml = `
                <div class="space-y-6 animate-in slide-in-from-right duration-300">
                    <!-- HUD -->
                    <div class="grid grid-cols-3 gap-2 bg-gray-900 border border-gray-800 rounded-xl p-3">
                        <div class="text-center border-r border-gray-800">
                            <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block">Custo Positivo</span>
                            <span class="text-xl font-display font-bold text-white">${posCost} <span class="text-[10px] text-gray-600">pts</span></span>
                        </div>
                        <div class="text-center border-r border-gray-800">
                            <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block">Compensação</span>
                            <div class="flex items-center justify-center gap-2">
                                <i data-lucide="scale" size="16" class="${isOk ? 'text-neon-green' : 'text-neon-red'}"></i>
                                <span class="text-xl font-display font-bold ${isOk ? 'text-neon-green' : 'text-neon-red'}">${isOk ? 'OK' : balance}</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block">Pontos Neg.</span>
                            <span class="text-xl font-display font-bold text-neon-red">${negVal} <span class="text-[10px] text-gray-600">/ 10</span></span>
                        </div>
                    </div>

                    <!-- Positivas -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-xs font-black text-neon-green uppercase tracking-widest flex items-center gap-2"><i data-lucide="thumbs-up" size="14"></i> Gerais Positivas</h4>
                            <span class="text-[9px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded border border-gray-700">1ª Grátis (Maior Valor)</span>
                        </div>
                        <div class="space-y-2">
                            ${SYSTEM_DB.inclinacoes.positivas.map(inc => {
                                const isSelected = state.tempChar.inclinations.positive.some(i => i.nome === inc.nome);
                                return `
                                <div onclick="toggleInclination('positive', '${inc.nome}', ${inc.custo})" class="bg-gray-900 border ${isSelected ? 'border-neon-green shadow-[0_0_10px_rgba(0,255,157,0.2)]' : 'border-gray-800'} rounded-xl p-3 cursor-pointer transition-all hover:border-gray-600 group relative overflow-hidden">
                                    ${isSelected ? '<div class="absolute top-0 right-0 p-1"><i data-lucide="check" size="14" class="text-neon-green"></i></div>' : ''}
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold ${isSelected ? 'text-neon-green' : 'text-white'}">${inc.nome}</span>
                                        <span class="text-[9px] font-mono bg-black/50 px-1.5 rounded text-gray-400 border border-gray-700">${inc.custo} pts</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 leading-tight group-hover:text-gray-400 transition-colors">${inc.desc}</p>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Negativas -->
                    <div>
                        <h4 class="text-xs font-black text-neon-red uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="thumbs-down" size="14"></i> Gerais Negativas</h4>
                        <div class="space-y-2">
                            ${SYSTEM_DB.inclinacoes.negativas.map(inc => {
                                const isSelected = state.tempChar.inclinations.negative.some(i => i.nome === inc.nome);
                                return `
                                <div onclick="toggleInclination('negative', '${inc.nome}', ${inc.valor})" class="bg-gray-900 border ${isSelected ? 'border-neon-red shadow-[0_0_10px_rgba(255,0,85,0.2)]' : 'border-gray-800'} rounded-xl p-3 cursor-pointer transition-all hover:border-gray-600 group relative overflow-hidden">
                                    ${isSelected ? '<div class="absolute top-0 right-0 p-1"><i data-lucide="check" size="14" class="text-neon-red"></i></div>' : ''}
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold ${isSelected ? 'text-neon-red' : 'text-white'}">${inc.nome}</span>
                                        <span class="text-[9px] font-mono bg-black/50 px-1.5 rounded text-gray-400 border border-gray-700">+${inc.valor} pts</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 leading-tight group-hover:text-gray-400 transition-colors">${inc.desc}</p>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            }
            else if (step === 5) {
                // TREINAMENTOS (ANTIGO STEP 3)
                // Filter skills already gained from Background
                const bgSkillsText = state.tempChar.background ? SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background).proficiencias : "";
                // Simple parsing logic: This is brittle but works for the MVP. Real implementation would map strings to IDs.
                // For now, we assume user reads and doesn't select duplicates, or we visually indicate it.
                // Let's parse basic names.
                
                title = 'TREINAMENTOS';
                window.toggleAccordion = (section) => { state.openSkillAccordion = state.openSkillAccordion === section ? null : section; render(); };
                const mainCount = state.tempChar.skills.length;
                const otherCount = state.tempChar.otherSkills.length;
                const maxMain = 5;
                const maxOther = 4;

                const renderAccordionHeader = (id, label, count, max, isOpen, colorClass, labelColorClass) => {
                    return `
                    <div onclick="toggleAccordion('${id}')" class="flex items-center justify-between p-4 bg-gray-900 border ${isOpen ? `border-${colorClass.split('-')[1]}-${colorClass.split('-')[2]}` : 'border-gray-800'} rounded-xl cursor-pointer hover:bg-gray-800 transition-all mb-2 relative group overflow-hidden">
                         <div class="absolute left-0 top-0 bottom-0 w-1 ${isOpen ? 'bg-' + colorClass.replace('text-', '') : 'bg-transparent'} transition-colors"></div>
                        <div class="flex items-center gap-3 pl-2">
                             <div>
                                <h3 class="font-display font-bold text-sm text-white uppercase tracking-wider ${isOpen ? colorClass : ''}">${label}</h3>
                                <div class="flex items-baseline gap-2 mt-0.5">
                                    <span class="text-[10px] text-gray-500 font-bold tracking-wider">SELECIONADO</span>
                                    <span id="counter-text-${id}" class="font-display font-bold text-xs ${count >= max ? colorClass : 'text-gray-400'}">${count} <span class="text-gray-600 text-[10px]">/ ${max} ${id === 'MAIN' ? '(Mín 2)' : ''}</span></span>
                                </div>
                             </div>
                        </div>
                        <div class="${isOpen ? colorClass + ' rotate-180' : 'text-gray-600'} transition-transform duration-300">
                            <i data-lucide="chevron-down" size="20"></i>
                        </div>
                    </div>`;
                };

                contentHtml = `<div class="space-y-4 animate-in slide-in-from-right duration-300 pt-2">
                    <div class="text-center mb-4"><h3 class="font-display font-black text-2xl text-white tracking-widest">TREINAMENTO</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Defina suas competências de combate e perícias</p></div>
                    
                    ${bgSkillsText ? `<div class="bg-gray-900/50 border border-gray-800 p-3 rounded-xl mb-4 text-center"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Perícias de Antecedente (Automático)</p><p class="text-xs text-neon-blue font-bold">${bgSkillsText}</p></div>` : ''}

                    ${renderAccordionHeader('MAIN', 'PERÍCIAS E RESISTÊNCIAS', mainCount, maxMain, state.openSkillAccordion === 'MAIN', 'text-neon-blue', 'text-neon-blue')}
                    ${state.openSkillAccordion === 'MAIN' ? `<div class="pl-1 pr-1 pb-4 pt-1 animate-in fade-in slide-in-from-top-1 duration-200">
                        <div class="grid grid-cols-1 gap-2">
                            ${SYSTEM_DB.skills.map(skill => {
                                const isSelected = state.tempChar.skills.includes(skill);
                                const isFromBg = bgSkillsText.includes(skill); // Simple check
                                return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="${isFromBg ? '' : `toggleCreatorSkill('${skill}', 'main')`}" class="flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${isFromBg ? 'bg-gray-800 border-gray-700 opacity-70 cursor-not-allowed' : (isSelected ? 'bg-neon-blue/10 border-neon-blue text-white shadow-[0_0_10px_rgba(0,240,255,0.1)]' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700')} group">
                                    <span class="text-xs font-bold uppercase tracking-wide pointer-events-none group-hover:text-gray-300 transition-colors ${isSelected || isFromBg ? 'text-neon-blue' : ''}">${skill} ${isFromBg ? '<span class="text-[8px] bg-gray-900 px-1 rounded ml-2 border border-gray-700 text-gray-400">ANTECEDENTE</span>' : ''}</span>
                                    <div class="pointer-events-none ${isSelected || isFromBg ? 'text-neon-blue' : 'text-gray-700'}">
                                        ${isSelected || isFromBg ? '<i data-lucide="check-square" size="18"></i>' : '<i data-lucide="square" size="18"></i>'}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>` : ''}

                    ${renderAccordionHeader('OTHER', 'OUTROS TREINAMENTOS', otherCount, maxOther, state.openSkillAccordion === 'OTHER', 'text-neon-yellow', 'text-neon-yellow')}
                    ${state.openSkillAccordion === 'OTHER' ? `<div class="pl-1 pr-1 pb-4 pt-1 animate-in fade-in slide-in-from-top-1 duration-200">
                        <p class="text-[9px] text-gray-500 italic mb-3 px-2">A 5ª escolha é atribuída automaticamente pelo kit de antecedente.</p>
                        <div class="grid grid-cols-1 gap-2">
                            ${SYSTEM_DB.otherSkills.map(skill => {
                                const isSelected = state.tempChar.otherSkills.includes(skill);
                                return `<div id="skill-btn-${skill.replace(/\s/g,'-')}" onclick="toggleCreatorSkill('${skill}', 'other')" class="flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${isSelected ? 'bg-neon-yellow/10 border-neon-yellow text-white shadow-[0_0_10px_rgba(255,230,0,0.1)]' : 'bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700'} group">
                                    <div class="flex items-center gap-3 pointer-events-none">
                                         <i data-lucide="hammer" size="14" class="${isSelected ? 'text-neon-yellow' : 'text-gray-600'}"></i>
                                         <span class="text-xs font-bold uppercase tracking-wide group-hover:text-gray-300 transition-colors ${isSelected ? 'text-neon-yellow' : ''}">${skill}</span>
                                    </div>
                                    <div class="pointer-events-none ${isSelected ? 'text-neon-yellow' : 'text-gray-700'}">
                                        ${isSelected ? '<i data-lucide="check-square" size="18"></i>' : '<i data-lucide="square" size="18"></i>'}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>` : ''}
                </div>`;
            }
            else if (step === 6) {
                // REVIEW (ANTIGO 4)
                title = 'REVISÃO';
                const color = SYSTEM_DB.classes.find(c => c.id === state.tempChar.class).color;
                contentHtml = `<div class="space-y-6 animate-in slide-in-from-right duration-300"><div class="text-center"><h2 class="text-3xl font-display font-bold text-white mb-1">${state.tempChar.name || 'Sem Nome'}</h2><span class="bg-[${color}]/20 text-[${color}] px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest border border-[${color}]/30">${state.tempChar.class}</span></div>
                
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 space-y-4">
                    <div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-xs text-gray-500 uppercase">Raça</span><span class="text-sm font-bold text-white">${state.tempChar.race}</span></div>
                    <div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-xs text-gray-500 uppercase">Antecedente</span><span class="text-sm font-bold text-white">${state.tempChar.background || '-'}</span></div>
                    
                    ${state.tempChar.raceTraits && state.tempChar.raceTraits.length > 0 ? `<div><span class="text-xs text-gray-500 uppercase block mb-2">Traços Raciais Selecionados</span><div class="flex flex-wrap gap-1">${state.tempChar.raceTraits.map(t => `<span class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">${t}</span>`).join('')}</div></div>` : ''}
                    
                    <div><span class="text-xs text-gray-500 uppercase block mb-2">Atributos</span><div class="grid grid-cols-6 gap-1 text-center">${Object.entries(state.tempChar.attributes).map(([k,v]) => `<div class="bg-black rounded p-1"><div class="text-[8px] text-gray-500">${k}</div><div class="text-xs font-bold text-white">${v}</div></div>`).join('')}</div></div>
                    
                    <div><span class="text-xs text-gray-500 uppercase block mb-2">Treinamentos</span><div class="flex flex-wrap gap-1 mb-2">${state.tempChar.skills.length > 0 ? state.tempChar.skills.map(s => `<span class="text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento principal</span>'}</div><div class="flex flex-wrap gap-1">${state.tempChar.otherSkills.length > 0 ? state.tempChar.otherSkills.map(s => `<span class="text-[10px] bg-gray-800 text-neon-blue/70 px-2 py-1 rounded border border-gray-700">${s}</span>`).join('') : '<span class="text-[10px] text-gray-600 italic">Nenhum treinamento extra</span>'}</div></div>
                    
                    <div>
                        <span class="text-xs text-gray-500 uppercase block mb-2">Inclinações</span>
                        <div class="space-y-1">
                            ${state.tempChar.inclinations.positive.map(i => `<div class="text-[10px] text-neon-green flex justify-between"><span>+ ${i.nome}</span><span>${i.custo}</span></div>`).join('')}
                            ${state.tempChar.inclinations.negative.map(i => `<div class="text-[10px] text-neon-red flex justify-between"><span>- ${i.nome}</span><span>${i.valor}</span></div>`).join('')}
                        </div>
                    </div>
                </div></div>`;
            }

            container.innerHTML = `<div class="flex flex-col h-full bg-gray-950 fade-in"><div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50"><button onclick="state.view='LIST'; render()" class="text-gray-500 hover:text-white flex items-center gap-1 text-[10px] uppercase font-bold"><i data-lucide="chevron-left" size="14"></i> Cancelar</button><div class="flex gap-1">${[0,1,2,3,4,5,6].map(i => `<div class="w-4 h-1 rounded-full ${i <= step ? 'bg-neon-theme shadow-[0_0_5px_var(--theme-color-hex)]' : 'bg-gray-800'} transition-all duration-300"></div>`).join('')}</div><div class="w-16"></div></div><div class="flex-1 p-6 overflow-y-auto custom-scrollbar relative"><h2 class="text-2xl font-display font-bold text-white text-center mb-6 tracking-widest drop-shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]">${title}</h2>${contentHtml}</div><div class="p-6 border-t border-gray-800 flex gap-4 bg-gray-900/50">${step > 0 ? `<button onclick="state.creatorStep--; render()" class="w-1/3 py-4 bg-transparent border border-gray-700 rounded-xl text-gray-400 font-bold hover:text-white hover:border-gray-500 transition-colors text-xs uppercase tracking-wider">Voltar</button>` : '<div class="w-1/3"></div>'}${step < 6 ? `<button onclick="nextCreatorStep()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl hover:brightness-110 transition-colors text-xs uppercase tracking-wider shadow-[0_0_15px_rgba(var(--theme-rgb),0.4)]">PRÓXIMO <i data-lucide="chevron-right" size="14" class="inline mb-0.5"></i></button>` : `<button onclick="finishCreator()" class="flex-1 py-4 bg-neon-theme text-black font-bold rounded-xl shadow-[0_0_20px_rgba(var(--theme-rgb),0.6)] hover:brightness-110 transition-colors text-xs uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="save" size="16"></i> FINALIZAR</button>`}</div></div>`;
        }

        function renderSheet(container) {
            const char = state.currentChar;
            const clsData = SYSTEM_DB.classes.find(c => c.id === char.class);
            const themeColor = clsData ? clsData.color : '#00ff9d';
            setThemeColor(themeColor);
            const nextXp = char.xp_next || 100;
            const xpPct = Math.min(100, (char.xp / nextXp) * 100);
            let tabContent = '';
            
            if (state.activeTab === 'FICHA') {
                tabContent = `<div class="grid grid-cols-2 gap-3 p-4 fade-in">${Object.entries(char.attributes).map(([key, attr]) => {
                    const mod = getMod(attr.value);
                    const isOpen = state.openAttrPopup === key;
                    const skillsList = SKILL_MAP[key] || [];
                    
                    // Logic for Shield visual based on skills array
                    const saveSkillName = `TR de ${key}`;
                    const isTrained = char.skills.includes(saveSkillName);
                    const isExpert = (char.expertise || []).includes(saveSkillName);
                    
                    let shieldClass = 'text-gray-700 opacity-20';
                    let shieldIconClass = '';
                    
                    if (isExpert) {
                        shieldClass = 'text-neon-yellow opacity-100 shield-expert';
                        shieldIconClass = 'fill-neon-yellow/20';
                    } else if (isTrained) {
                        shieldClass = `text-[${themeColor}] opacity-100 shield-glow`;
                        shieldIconClass = 'fill-current';
                    }
                    
                    return `
                    <div class="relative group select-none">
                        <div class="bg-gray-900/60 border border-gray-800 rounded-2xl p-4 flex flex-col items-center hover:border-[${themeColor}] transition-colors cursor-pointer" onclick="handleAttributeClick('${key}')">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 group-hover:text-[${themeColor}] transition-colors">${key}</span>
                            <div class="flex items-center gap-3">
                                <button onclick="event.stopPropagation(); updateSheetAttr('${key}', -1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="minus" size="12"></i></button>
                                <span class="text-3xl font-display font-bold text-white shadow-black drop-shadow-lg">${attr.value}</span>
                                <button onclick="event.stopPropagation(); updateSheetAttr('${key}', 1)" class="text-gray-600 hover:text-white p-1"><i data-lucide="plus" size="12"></i></button>
                            </div>
                            <div class="mt-2 bg-gray-800 px-3 py-0.5 rounded-full text-xs font-bold text-[${themeColor}] border border-gray-700">${mod >= 0 ? '+'+mod : mod}</div>
                            
                            <div onclick="event.stopPropagation(); handleShieldClick('${key}')" class="absolute top-2 right-2 transition-all ${shieldClass} hover:scale-110 active:scale-95 cursor-pointer p-2 -mr-2 -mt-2">
                                <i data-lucide="shield" size="14" class="${shieldIconClass}"></i>
                                ${isTrained ? `<span class="absolute bottom-0 right-0 text-[8px] font-bold ${isExpert ? 'text-neon-yellow' : ''}">+2</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
                
                <!-- Popup Centralizado Overlay -->
                ${state.openAttrPopup ? (() => {
                    const key = state.openAttrPopup;
                    const attr = char.attributes[key];
                    const mod = getMod(attr.value);
                    const skillsList = SKILL_MAP[key] || [];

                    return `
                    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onclick="toggleAttrPopup(null)">
                        <div class="bg-gray-900 border-2 border-[${themeColor}] rounded-2xl p-6 w-[85%] max-w-[320px] shadow-[0_0_50px_rgba(0,0,0,0.8)] relative transform scale-100 animate-in zoom-in-95 duration-200" onclick="event.stopPropagation()">
                            
                            <!-- Close Button -->
                            <button onclick="toggleAttrPopup(null)" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x" size="20"></i></button>

                            <div class="text-center mb-6">
                                <h2 class="text-2xl font-display font-black text-white uppercase tracking-widest drop-shadow-[0_0_10px_${themeColor}]">${key}</h2>
                                <div class="flex justify-center items-center gap-4 mt-2">
                                    <div class="text-4xl font-display font-bold text-[${themeColor}]">${attr.value}</div>
                                    <div class="bg-gray-800 px-4 py-1 rounded-full text-sm font-bold text-white border border-gray-700">Mod ${mod >= 0 ? '+'+mod : mod}</div>
                                </div>
                            </div>

                            <div class="space-y-3 mb-6">
                                <h4 class="text-[10px] font-bold text-gray-500 uppercase border-b border-gray-800 pb-2 text-center">Perícias Associadas</h4>
                                <div class="flex flex-col gap-2 max-h-[200px] overflow-y-auto custom-scrollbar">
                                    ${skillsList.length > 0 ? skillsList.map(s => {
                                        const isTrained = char.skills.includes(s);
                                        const isExpert = (char.expertise || []).includes(s);
                                        const pb = getProficiencyBonus(char.level);
                                        let totalBonus = mod;
                                        if (isExpert) totalBonus += (pb * 2);
                                        else if (isTrained) totalBonus += pb;

                                        let iconName = 'circle';
                                        let iconColorClass = 'text-gray-600';
                                        
                                        if (isExpert) {
                                            iconName = 'badge-check';
                                            iconColorClass = 'text-neon-yellow fill-neon-yellow/20';
                                        } else if (isTrained) {
                                            iconName = 'check-circle-2';
                                            iconColorClass = `text-[${themeColor}]`;
                                        }

                                        return `
                                        <div class="flex items-center justify-between p-3 rounded-xl border transition-all group ${isTrained ? `bg-[${themeColor}]/10 border-[${themeColor}]/30` : 'bg-gray-950 border-gray-800 hover:border-gray-600'}">
                                            <div class="flex items-center gap-3 cursor-pointer" onclick="handleSkillStatus('${s}')">
                                                 <i data-lucide="${iconName}" size="20" class="${iconColorClass} hover:scale-110 transition-transform"></i>
                                                 <span class="text-xs font-bold uppercase tracking-wide ${isTrained ? 'text-white' : 'text-gray-400'}">${s}</span>
                                            </div>
                                            <div class="flex items-center gap-2 cursor-pointer" onclick="rollSkill('${s}', '${key}')">
                                                 <span class="text-xs font-mono font-bold ${isExpert ? 'text-neon-yellow' : (isTrained ? `text-[${themeColor}]` : 'text-gray-500')}">${totalBonus >= 0 ? '+'+totalBonus : totalBonus}</span>
                                                 <i data-lucide="dices" size="16" class="text-gray-600 group-hover:text-white transition-colors"></i>
                                            </div>
                                        </div>`
                                    }).join('') : '<span class="text-xs text-gray-600 italic block text-center py-2">Nenhuma perícia associada.</span>'}
                                </div>
                            </div>

                            <button onclick="rollDice('${key}', ${mod}); toggleAttrPopup(null)" class="w-full py-3 bg-[${themeColor}] text-black font-black font-display tracking-widest rounded-xl hover:brightness-110 transition-all flex items-center justify-center gap-2 shadow-[0_0_20px_${themeColor}40]">
                                <i data-lucide="dices" size="18"></i> ROLAR ATRIBUTO PURO
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal de Decisão de Proficiência -->
                    ${state.skillSelectionModal ? `
                    <div class="fixed inset-0 z-[110] flex items-center justify-center bg-black/90 animate-in fade-in duration-200" onclick="closeSkillModal()">
                        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-[85%] max-w-[300px] shadow-2xl relative" onclick="event.stopPropagation()">
                             <h3 class="text-lg font-display font-bold text-white mb-1">${state.skillSelectionModal}</h3>
                             <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest">Selecione o nível de treinamento</p>
                             
                             <div class="space-y-2">
                                <button onclick="setSkillLevel('${state.skillSelectionModal}', 'remove')" class="w-full p-3 rounded-lg border border-red-900/50 bg-red-500/10 text-red-500 font-bold text-xs uppercase hover:bg-red-500 hover:text-white transition-colors flex items-center gap-2">
                                    <i data-lucide="x" size="16"></i> Remover Proficiência
                                </button>
                                <button onclick="setSkillLevel('${state.skillSelectionModal}', 'trained')" class="w-full p-3 rounded-lg border border-gray-700 bg-gray-800 text-gray-300 font-bold text-xs uppercase hover:bg-gray-700 hover:text-white transition-colors flex items-center gap-2">
                                    <i data-lucide="check-circle-2" size="16"></i> Normal (1x Bônus)
                                </button>
                                <button onclick="setSkillLevel('${state.skillSelectionModal}', 'expert')" class="w-full p-3 rounded-lg border border-neon-yellow/30 bg-neon-yellow/10 text-neon-yellow font-bold text-xs uppercase hover:bg-neon-yellow hover:text-black transition-colors flex items-center gap-2">
                                    <i data-lucide="badge-check" size="16"></i> Especialização (2x Bônus)
                                </button>
                             </div>
                             
                             <button onclick="closeSkillModal()" class="mt-4 w-full py-2 text-xs text-gray-500 hover:text-white uppercase font-bold tracking-widest">Cancelar</button>
                        </div>
                    </div>
                    ` : ''}

                    `;
                })() : ''}
                </div>`;
            } else if (state.activeTab === 'TRACOS') {
                const raceData = SYSTEM_DB.racas.find(r => r.nome === char.race);
                const bgData = SYSTEM_DB.antecedentes.find(b => b.nome === char.background);
                
                let traitsHtml = '';
                // Race Traits
                if (char.race === 'Formiga Quimera') {
                    if (char.raceTraits && char.raceTraits.length > 0) {
                         traitsHtml = char.raceTraits.map(tName => {
                            const tData = raceData.caracteristicas.find(c => c.nome === tName);
                            return `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl"><h4 class="font-bold text-neon-theme text-sm mb-1">${tName}</h4><p class="text-xs text-gray-400 leading-relaxed">${tData ? (tData.efeito || tData.mecanica) : 'Descrição não encontrada.'}</p></div>`;
                         }).join('');
                    }
                } else {
                    const fixedFeatures = [...(raceData.caracteristicas || []), ...(raceData.opcoes_caracteristica || [])];
                    if (fixedFeatures.length > 0) {
                        traitsHtml = fixedFeatures.map(f => `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl"><h4 class="font-bold text-neon-theme text-sm mb-1">${f.nome}</h4><p class="text-xs text-gray-400 leading-relaxed">${f.efeito || f.mecanica || ''}</p>${f.tabela_ancestral ? `<p class="text-[10px] text-gray-500 mt-2 italic">${f.tabela_ancestral}</p>` : ''}</div>`).join('');
                    }
                }

                // Background Traits
                let bgHtml = '';
                if (bgData && char.backgroundFeature) {
                    const feature = bgData.caracteristicas.find(f => f.nome === char.backgroundFeature);
                    bgHtml = `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl border-l-4 border-l-neon-blue"><h4 class="font-bold text-neon-blue text-sm mb-1">${feature.nome} <span class="text-[9px] text-gray-500 uppercase">(Antecedente)</span></h4><p class="text-xs text-gray-400 leading-relaxed">${feature.efeito}</p></div>`;
                }

                // Inclinations
                let incHtml = '';
                if (char.inclinations) {
                    const pos = char.inclinations.positive.map(i => `<li class="text-neon-green">${i.nome}</li>`).join('');
                    const neg = char.inclinations.negative.map(i => `<li class="text-neon-red">${i.nome}</li>`).join('');
                    if (pos || neg) {
                        incHtml = `<div class="bg-gray-900 border border-gray-800 p-4 rounded-xl"><h4 class="font-bold text-white text-sm mb-2">Inclinações</h4><ul class="text-xs list-disc pl-4 space-y-1">${pos}${neg}</ul></div>`;
                    }
                }

                // Lógica de Outros Treinamentos
                const otherTrainings = char.skills.filter(s => SYSTEM_DB.otherSkills.includes(s));
                let otherSkillsHtml = '';
                if (otherTrainings.length > 0) {
                    otherSkillsHtml = `<div class="space-y-2 mt-6 border-t border-gray-800 pt-6">
                        <div class="flex items-center gap-3 mb-2"><div class="bg-gray-800 p-2 rounded text-neon-yellow"><i data-lucide="hammer" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">Outros Treinamentos</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Equipamentos, Linguagens e Ferramentas</p></div></div>
                        <div class="grid grid-cols-1 gap-2">
                        ${otherTrainings.map(s => `<div class="bg-gray-900 border border-gray-800 p-3 rounded-xl flex items-center gap-2"><i data-lucide="check-circle" size="14" class="text-neon-yellow"></i><span class="text-xs text-gray-300 font-bold">${s}</span></div>`).join('')}
                        </div>
                    </div>`;
                }

                tabContent = `<div class="p-4 fade-in space-y-4"><div class="flex items-center gap-3 mb-2"><div class="bg-gray-800 p-2 rounded text-[${themeColor}]"><i data-lucide="dna" size="20"></i></div><div><h3 class="font-bold text-white uppercase tracking-wider text-sm">${char.race}</h3><p class="text-[10px] text-gray-500 uppercase tracking-widest">Características</p></div></div><div class="space-y-3">${traitsHtml}${bgHtml}${incHtml}</div>${otherSkillsHtml}</div>`;
            } else if (state.activeTab === 'INV') {
                tabContent = `<div class="p-4 fade-in space-y-4"><div class="flex gap-2"><input type="text" id="new-item-name" placeholder="Nome do item..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-[${themeColor}]"><button onclick="addItem()" class="bg-[${themeColor}] text-black px-4 rounded-lg font-bold hover:brightness-110"><i data-lucide="plus"></i></button></div><div class="space-y-2">${char.inventory.length === 0 ? '<div class="text-center text-gray-600 text-xs py-8 border border-dashed border-gray-800 rounded-xl">Mochila vazia.</div>' : ''}${char.inventory.map((item, idx) => `<div class="bg-gray-900 border border-gray-800 rounded-xl p-3 flex justify-between items-center"><span class="text-sm font-bold text-white">${item.name}</span><div class="flex items-center gap-3"><button onclick="updateItemQty(${idx}, -1)" class="text-gray-500 hover:text-white"><i data-lucide="minus" size="14"></i></button><span class="text-sm w-4 text-center">${item.qty}</span><button onclick="updateItemQty(${idx}, 1)" class="text-gray-500 hover:text-white"><i data-lucide="plus" size="14"></i></button></div></div>`).join('')}</div><div class="flex justify-between items-center pt-4 border-t border-gray-800 text-xs text-gray-400"><span class="uppercase font-bold tracking-widest">Jenny (Dinheiro)</span><div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-700"><span class="text-[${themeColor}] font-bold">$</span><input type="number" value="${char.money}" onchange="updateMoney(this.value)" class="w-24 text-right bg-transparent text-white font-mono outline-none"></div></div></div>`;
            } else if (state.activeTab === 'DADOS') {
                tabContent = `<div class="p-4 fade-in h-full flex flex-col"><div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-950 pb-2 border-b border-gray-800 z-10"><h3 class="font-bold text-white uppercase tracking-wider text-xs">Histórico de Rolagens</h3><button onclick="clearHistory()" class="text-[10px] text-red-500 uppercase font-bold hover:text-red-400 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Limpar Log</button></div><div class="flex-1 overflow-y-auto space-y-2 text-sm pb-4">${char.history.length === 0 ? '<div class="text-center text-gray-600 italic py-10">Sem rolagens recentes.</div>' : ''}${char.history.slice().reverse().map(h => `<div class="bg-gray-900/50 p-3 rounded-lg border-l-2 border-[${themeColor}] flex flex-col gap-1"><div class="flex justify-between text-[10px] text-gray-500"><span>${h.time}</span><span class="uppercase font-bold tracking-wider text-gray-400">${h.label}</span></div><div class="flex justify-between items-center mt-1"><div class="flex flex-col"><span class="text-xs text-gray-500">Resultado</span><span class="text-2xl font-bold ${h.dice===20?'text-neon-yellow':h.dice===1?'text-neon-red':'text-white'} font-display">${h.total}</span></div><div class="text-right"><span class="text-xs text-gray-600 block">D20 + Mod</span><span class="text-gray-300 font-mono text-sm">[${h.dice}] ${h.mod>=0?'+':''}${h.mod}</span></div></div></div>`).join('')}</div></div>`;
            } else { tabContent = `<div class="flex flex-col items-center justify-center h-full text-gray-600 fade-in gap-4"><i data-lucide="construction" size="48" class="opacity-20"></i><span class="text-xs uppercase tracking-widest">Em desenvolvimento</span></div>`; }

            container.innerHTML = `<div class="flex flex-col h-full bg-gray-950"><div class="relative pt-8 pb-4 px-6 bg-gradient-to-b from-gray-900 to-transparent"><button onclick="state.view='LIST'; render()" class="absolute top-4 left-4 text-gray-500 hover:text-white bg-black/30 p-2 rounded-full backdrop-blur-sm"><i data-lucide="arrow-left" size="20"></i></button><div class="mt-4"><h1 class="font-display font-black text-2xl text-white uppercase tracking-wider truncate drop-shadow-lg">${char.name}</h1><div class="flex items-center gap-3 mt-2"><div class="h-2 flex-1 bg-gray-800 rounded-full overflow-hidden border border-gray-700"><div class="h-full bg-[${themeColor}] shadow-[0_0_10px_rgba(var(--theme-rgb),0.5)]" style="width: ${xpPct}%"></div></div><div class="flex flex-col items-end leading-none"><span class="text-[10px] font-bold text-gray-500 uppercase">Nível</span><span class="text-lg font-display font-bold text-white">${char.level}</span></div></div></div></div><div class="grid grid-cols-5 gap-1 px-2 py-2 border-t border-b border-gray-800 bg-[#0e0e14]">${renderVitalBlock('PV', char.vitals.hp, char.vitals.hpMax, 'text-neon-red')}${renderVitalBlock('AURA', char.vitals.aura, char.vitals.auraMax, `text-[${themeColor}]`)}${renderVitalBlock('SAN', char.vitals.san, char.vitals.sanMax, 'text-white')}${renderVitalBlock('REA', char.vitals.rea || (7 + getMod(char.attributes.SAB.value)), null, 'text-white')}${renderVitalBlock('CA', char.vitals.ca, null, 'text-white')}</div><div class="flex-1 overflow-y-auto custom-scrollbar relative">${tabContent}</div><div class="h-16 bg-[#0e0e14] border-t border-gray-800 flex items-center justify-around px-2 relative z-50">${renderNavItem('FICHA', 'user', themeColor)}${renderNavItem('NEN', 'flame', themeColor)}${renderNavItem('TRACOS', 'dna', themeColor)}${renderNavItem('INV', 'backpack', themeColor)}${renderNavItem('DADOS', 'dices', themeColor)}</div></div>`;
        }

        // Helpers de renderização
        function renderVitalBlock(label, val, max, colorClass) { return `<div class="flex flex-col items-center justify-center py-1"><span class="text-[8px] font-bold text-gray-500 uppercase tracking-wider mb-1">${label}</span><div class="flex items-center gap-1 bg-gray-900/50 px-2 py-1 rounded border border-gray-800">${max ? `<button onclick="updateVital('${label.toLowerCase()}', -1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-left" size="10"></i></button>` : ''}<span class="font-display font-bold text-sm ${colorClass} w-6 text-center">${val}</span>${max ? `<button onclick="updateVital('${label.toLowerCase()}', 1)" class="text-gray-600 text-[10px] hover:text-white"><i data-lucide="chevron-right" size="10"></i></button>` : ''}</div></div>`; }
        function renderNavItem(id, icon, color) { const active = state.activeTab === id; return `<button onclick="setTab('${id}')" class="flex flex-col items-center justify-center w-full h-full gap-1 group relative">${active ? `<div class="absolute top-0 w-8 h-0.5 bg-[${color}] shadow-[0_0_10px_${color}]"></div>` : ''}<i data-lucide="${icon}" size="${active ? 20 : 18}" class="${active ? `text-[${color}] drop-shadow-[0_0_5px_${color}]` : 'text-gray-600 group-hover:text-gray-400'} transition-all"></i><span class="text-[7px] font-bold tracking-widest ${active ? `text-[${color}]` : 'text-gray-600'}">${id}</span></button>`; }

        // --- CONTROLLERS ---
        function selectChar(id) { state.currentChar = state.characters.find(c => c.id === id); state.view = 'SHEET'; state.activeTab = 'FICHA'; render(); }
        function startCreator() { state.creatorStep = 0; state.tempChar = null; state.attrMethodLocked = false; state.view = 'CREATOR'; render(); }
        function selectNenType(cls) { state.tempChar.class = cls; const clsData = SYSTEM_DB.classes.find(c => c.id === cls); if(clsData) setThemeColor(clsData.color); render(); }
        
        // NOVO: Seleção de Background
        function selectBackground(bgName) {
            if (state.tempChar.background === bgName) {
                // Se clicar no mesmo, não faz nada ou colapsa (opcional)
                // Vamos manter expandido para interação
            } else {
                state.tempChar.background = bgName;
                state.tempChar.backgroundFeature = null; // Reset feature choice
            }
            render();
        }

        function selectBackgroundFeature(featureName) {
            state.tempChar.backgroundFeature = featureName;
            // Não precisa de render, o input radio já marca visualmente, mas se quiser atualizar algo mais, chame render()
            // render(); 
        }

        // NOVO: Toggle Inclinações
        function toggleInclination(type, name, value) {
            const list = state.tempChar.inclinations[type];
            const existsIdx = list.findIndex(i => i.nome === name);
            
            if (existsIdx >= 0) {
                list.splice(existsIdx, 1);
            } else {
                list.push({ nome: name, [type === 'positive' ? 'custo' : 'valor']: value });
            }
            render();
        }

        // NOVO: Seleção de Raça sem Re-render
        function selectRace(raceName) {
            state.tempChar.race = raceName;
            SYSTEM_DB.racas.forEach(r => {
                const card = document.getElementById(`race-card-${r.nome.replace(/\s/g,'-')}`);
                const content = document.getElementById(`race-content-${r.nome.replace(/\s/g,'-')}`);
                const checkWrapper = document.getElementById(`check-${r.nome.replace(/\s/g,'-')}`);
                const chevronWrapper = document.getElementById(`chevron-${r.nome.replace(/\s/g,'-')}`);
                
                if (r.nome === raceName) {
                    // Activate styles
                    card.classList.remove('border-gray-800', 'bg-gray-900');
                    card.classList.add('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    
                    // Text Color
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-white');
                    h3.classList.add('text-neon-theme');

                    // Checkmark Wrapper Opacity
                    checkWrapper.classList.remove('opacity-0');
                    checkWrapper.classList.add('opacity-100');

                    // Chevron Wrapper Rotation and Color
                    chevronWrapper.classList.remove('-rotate-90', 'text-gray-600');
                    chevronWrapper.classList.add('rotate-0', 'text-neon-theme');

                    // Content
                    content.classList.add('open', 'pb-4');
                } else {
                    // Deactivate styles
                    card.classList.remove('border-neon-theme', 'ring-2', 'ring-neon-theme/20', 'bg-neon-theme/5');
                    card.classList.add('border-gray-800', 'bg-gray-900');

                    // Text Color
                    const h3 = card.querySelector('h3');
                    h3.classList.remove('text-neon-theme');
                    h3.classList.add('text-white');

                    // Checkmark Wrapper Opacity
                    checkWrapper.classList.remove('opacity-100');
                    checkWrapper.classList.add('opacity-0');

                    // Chevron Wrapper Rotation and Color
                    chevronWrapper.classList.remove('rotate-0', 'text-neon-theme');
                    chevronWrapper.classList.add('-rotate-90', 'text-gray-600');

                    // Content
                    content.classList.remove('open', 'pb-4');
                }
            });
        }

        // NOVO: Toggle Traits sem Re-render
        function toggleRaceTrait(traitName) {
            const list = state.tempChar.raceTraits || [];
            const idx = list.indexOf(traitName);
            if (idx >= 0) list.splice(idx, 1);
            else {
                if (list.length >= 3) { alert("Você só pode escolher até 3 características."); return; }
                list.push(traitName);
            }
            state.tempChar.raceTraits = list;
            
            // DOM Update
            const btn = document.getElementById(`trait-btn-${traitName.replace(/\s/g,'-')}`);
            if (idx >= 0) { // Removed
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>';
            } else { // Added
                btn.className = "p-2 rounded border cursor-pointer transition-all flex items-start gap-2 bg-neon-theme/10 border-neon-theme text-white";
                btn.querySelector('div:first-child').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
            }
            document.getElementById('trait-counter').innerText = `(${list.length}/3)`;
            document.getElementById('trait-counter').className = list.length >= 3 ? 'text-neon-theme' : 'text-gray-500';
        }

        // NOVO: Toggle Skills sem Re-render e sem scroll reset
        function toggleCreatorSkill(skill, type = 'main') {
            const list = type === 'main' ? state.tempChar.skills : state.tempChar.otherSkills;
            const limit = type === 'main' ? 5 : 4;
            const idx = list.indexOf(skill);
            
            if (idx >= 0) {
                list.splice(idx, 1);
            } else {
                if (list.length >= limit) { alert(`Limite de ${limit} atingido.`); return; }
                list.push(skill);
            }

            // DOM Updates (No Render to avoid scroll reset)
            const btn = document.getElementById(`skill-btn-${skill.replace(/\s/g,'-')}`);
            const baseClass = type === 'main' ? 'bg-neon-blue/10 border-neon-blue text-white shadow-[0_0_10px_rgba(0,240,255,0.1)]' : 'bg-neon-yellow/10 border-neon-yellow text-white shadow-[0_0_10px_rgba(255,230,0,0.1)]';
            const iconColor = type === 'main' ? 'text-neon-blue' : 'text-neon-yellow';
            const maxColorClass = type === 'main' ? 'text-neon-blue' : 'text-neon-yellow';
            
            if (idx >= 0) { // Removed
                btn.className = "flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all bg-gray-900 border-gray-800 text-gray-500 hover:bg-gray-800 hover:border-gray-700 group";
                const checkContainer = btn.querySelector('div:last-child');
                checkContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>';
                checkContainer.classList.remove(iconColor);
                checkContainer.classList.add('text-gray-700');
                
                const textSpan = btn.querySelector('span');
                textSpan.classList.remove(iconColor);
                
                if (type === 'other') {
                    const hammer = btn.querySelector('div:first-child i');
                    if(hammer) { hammer.classList.remove('text-neon-yellow'); hammer.classList.add('text-gray-600'); }
                }

            } else { // Added
                btn.className = `flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${baseClass} group`;
                const checkContainer = btn.querySelector('div:last-child');
                checkContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`;
                checkContainer.classList.remove('text-gray-700');
                checkContainer.classList.add(iconColor);
                
                const textSpan = btn.querySelector('span');
                textSpan.classList.add(iconColor);
                
                if (type === 'other') {
                     const hammer = btn.querySelector('div:first-child i');
                     if(hammer) { hammer.classList.remove('text-gray-600'); hammer.classList.add('text-neon-yellow'); }
                }
            }

            // Update Counter Header
            const counterEl = document.getElementById('counter-text-' + (type === 'main' ? 'MAIN' : 'OTHER'));
            if(counterEl) {
                const count = list.length;
                counterEl.innerHTML = `${count} <span class="text-gray-600 text-[10px]">/ ${limit} ${type === 'main' ? '(Mín 2)' : ''}</span>`;
                counterEl.className = `font-display font-bold text-xs ${count >= limit ? maxColorClass : 'text-gray-400'}`;
            }
        }

        // NOVO: Point Buy com Limite e Feedback Visual
        function buyStat(attr, delta) {
            lockAttributeMethod();
            const current = state.tempChar.attributes[attr];
            const next = current + delta;
            
            if (next >= 1 && next <= 30) {
                const currentCost = calculateTotalCost(state.tempChar.attributes);
                // Calculate diff
                const costDiff = getPointBuyCost(next) - getPointBuyCost(current);
                const MAX = 20;

                // Check Budget (Only prevent increase if over budget)
                if (costDiff > 0 && (currentCost + costDiff > MAX)) {
                    // Feedback Visual de Erro
                    const bar = document.getElementById('buy-bar');
                    const totalEl = document.getElementById('buy-total');
                    totalEl.classList.add('text-red-500', 'shake');
                    setTimeout(() => totalEl.classList.remove('shake'), 500);
                    return; // Block change
                }

                // Apply Change
                state.tempChar.attributes[attr] = next;
                
                // DOM Updates (No Render)
                const newTotal = currentCost + costDiff;
                document.getElementById(`attr-val-${attr}`).innerText = next;
                
                const totalEl = document.getElementById('buy-total');
                totalEl.innerText = newTotal;
                
                // Update Bar
                const bar = document.getElementById('buy-bar');
                bar.style.width = `${Math.min(100, (newTotal/MAX)*100)}%`;
                
                // Color Logic
                if (newTotal > MAX) { // Shouldn't happen due to check, but safety
                    bar.classList.remove('bg-neon-theme'); bar.classList.add('bg-red-500');
                    totalEl.classList.add('text-red-500'); totalEl.classList.remove('text-white');
                } else {
                    bar.classList.add('bg-neon-theme'); bar.classList.remove('bg-red-500');
                    totalEl.classList.add('text-white'); totalEl.classList.remove('text-red-500');
                }
            }
        }
        
        function setAttrTab(mode) {
             if (state.attrMethodLocked) return; 
             state.attrTab = mode; state.selectedPoolIdx = null;
             if(mode === 'COMPRA') { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = 10); state.attrPool = []; } 
             else { Object.keys(state.tempChar.attributes).forEach(k => state.tempChar.attributes[k] = null); state.attrPool = []; }
             render();
        }
        function lockAttributeMethod() { if(!state.attrMethodLocked) { state.attrMethodLocked = true; render(); } }
        function rollAllStats() { lockAttributeMethod(); let newPool = []; for(let k=0; k<6; k++) { let dice = []; for(let i=0; i<4; i++) { let d = Math.floor(Math.random()*6)+1; if(d === 1) d = Math.floor(Math.random()*6)+1; dice.push(d); } dice.sort((a,b) => b-a); newPool.push(dice[0] + dice[1] + dice[2]); } state.attrPool = newPool.sort((a,b) => b-a); render(); }
        function applyStandardArray() { lockAttributeMethod(); state.attrPool = [15, 14, 13, 12, 10, 8]; render(); }
        function selectPoolItem(idx) { if (state.selectedPoolIdx === idx) state.selectedPoolIdx = null; else state.selectedPoolIdx = idx; render(); }
        function assignToSlot(attr) { if (state.selectedPoolIdx === null) return; if (state.tempChar.attributes[attr] !== null) state.attrPool.push(state.tempChar.attributes[attr]); const val = state.attrPool[state.selectedPoolIdx]; state.tempChar.attributes[attr] = val; state.attrPool.splice(state.selectedPoolIdx, 1); state.attrPool.sort((a,b) => b-a); state.selectedPoolIdx = null; render(); }
        function returnToPool(attr) { const val = state.tempChar.attributes[attr]; if (val !== null) { state.attrPool.push(val); state.attrPool.sort((a,b) => b-a); state.tempChar.attributes[attr] = null; render(); } }

        function nextCreatorStep() {
            if (state.creatorStep === 0 && !state.tempChar.name) { alert("Dê um nome ao personagem!"); return; }
            if (state.creatorStep === 2) {
                if (state.attrTab === 'COMPRA') { const cost = calculateTotalCost(state.tempChar.attributes); if (cost > 20) { alert("Você excedeu o limite de pontos de compra (20)!"); return; } } 
                else { const values = Object.values(state.tempChar.attributes); if (values.some(v => v === null)) { alert("Aloque todos os valores do pool para os atributos!"); return; } }
            }
            if (state.creatorStep === 3) {
                if (!state.tempChar.background) { alert("Selecione um Antecedente!"); return; }
                if (!state.tempChar.backgroundFeature) { alert("Escolha uma característica do Antecedente!"); return; }
            }
            if (state.creatorStep === 4) {
                const posCost = state.tempChar.inclinations.positive.reduce((acc, i) => acc + i.custo, 0);
                const negVal = state.tempChar.inclinations.negative.reduce((acc, i) => acc + i.valor, 0);
                const sortedPos = [...state.tempChar.inclinations.positive].sort((a,b) => b.custo - a.custo);
                const freeCost = sortedPos.length > 0 ? sortedPos[0].custo : 0;
                const paidCost = Math.max(0, posCost - freeCost);
                const balance = negVal - paidCost;
                
                if (balance < 0) { alert("Suas inclinações não estão balanceadas! Adicione negativas ou remova positivas extras."); return; }
                if (negVal > 10) { alert("O máximo de compensação negativa é 10 pontos."); return; }
            }
            if (state.creatorStep === 5) {
                 if (state.tempChar.skills.length !== 5) { alert("Você deve selecionar exatamente 5 perícias (o máximo permitido) para continuar."); return; }
            }
            state.creatorStep++; render();
        }

        function finishCreator() {
            // Collect BG Inventory
            const bgData = SYSTEM_DB.antecedentes.find(b => b.nome === state.tempChar.background);
            const initialInv = bgData ? bgData.equipamento.map(i => ({ name: i, qty: 1 })) : [];

            const newChar = {
                id: generateId(), name: state.tempChar.name, class: state.tempChar.class, race: state.tempChar.race, 
                background: state.tempChar.background, backgroundFeature: state.tempChar.backgroundFeature,
                inclinations: state.tempChar.inclinations,
                level: 0, xp: 0, xp_next: 50, money: 0,
                attributes: {}, skills: [...state.tempChar.skills, ...state.tempChar.otherSkills], expertise: [], raceTraits: state.tempChar.raceTraits || [],
                vitals: { hp: 15 + getMod(state.tempChar.attributes.CON), hpMax: 15 + getMod(state.tempChar.attributes.CON), aura: 100, auraMax: 100, san: 10 + getMod(state.tempChar.attributes.INT), sanMax: 10 + getMod(state.tempChar.attributes.INT), ca: 10 + getMod(state.tempChar.attributes.CON), rea: 7 + getMod(state.tempChar.attributes.SAB) },
                inventory: initialInv, history: []
            };
            Object.entries(state.tempChar.attributes).forEach(([k,v]) => { 
                const hasSave = state.tempChar.skills.includes(`TR de ${k}`);
                newChar.attributes[k] = { value: v || 10, save: hasSave }; 
            });
            saveCharacter(newChar); state.currentChar = newChar; state.view = 'SHEET'; state.activeTab = 'FICHA'; render();
        }

        function setTab(tab) { state.activeTab = tab; render(); }
        
        function updateSheetAttr(key, delta) { 
            state.currentChar.attributes[key].value += delta; 
            saveCharacter(state.currentChar); 
            render(); 
        }
        
        function toggleSave(key) { 
            // state.currentChar.attributes[key].save = !state.currentChar.attributes[key].save; 
            // saveCharacter(state.currentChar); 
            // render(); 
            // DESABILITADO PARA EVITAR EDIÇÃO MANUAL NA FICHA
        }

        function toggleAttrPopup(key) {
            if (state.openAttrPopup === key) state.openAttrPopup = null;
            else state.openAttrPopup = key;
            render();
        }

        // --- HANDLERS DE CLIQUE DUPLO ---
        function handleAttributeClick(key) {
            if (state.clickTimer) {
                clearTimeout(state.clickTimer);
                state.clickTimer = null;
                // Clique duplo: Rolar Atributo Puro
                const attr = state.currentChar.attributes[key];
                rollDice(key, getMod(attr.value));
            } else {
                state.clickTimer = setTimeout(() => {
                    state.clickTimer = null;
                    // Clique único: Abrir Popup
                    toggleAttrPopup(key);
                }, 250);
            }
        }

        function handleShieldClick(key) {
            if (state.clickTimer) {
                clearTimeout(state.clickTimer);
                state.clickTimer = null;
                // Clique duplo: Rolar TR
                const skillName = `TR de ${key}`;
                rollSkill(skillName, key);
            } else {
                state.clickTimer = setTimeout(() => {
                    state.clickTimer = null;
                    // Clique único: Abrir Configuração
                    handleSkillStatus(`TR de ${key}`);
                }, 250);
            }
        }
        
        // --- FUNÇÕES DE STATUS DE PERÍCIA ---
        function handleSkillStatus(skillName) {
            const char = state.currentChar;
            const isTrained = char.skills.includes(skillName);
            const isExpert = (char.expertise || []).includes(skillName);
            
            if (!isTrained) {
                // Se destreinado, confirmação simples para adicionar
                if (confirm(`Deseja adicionar proficiência em ${skillName}?`)) {
                    state.currentChar.skills.push(skillName);
                    saveCharacter(state.currentChar);
                    render();
                }
            } else {
                // Se já treinado ou expert, abre modal de decisão
                state.skillSelectionModal = skillName;
                render();
            }
        }
        
        function closeSkillModal() {
            state.skillSelectionModal = null;
            render();
        }
        
        function setSkillLevel(skillName, level) {
            const char = state.currentChar;
            if (!char.expertise) char.expertise = [];
            
            if (level === 'remove') {
                // Remover tudo
                char.skills = char.skills.filter(s => s !== skillName);
                char.expertise = char.expertise.filter(s => s !== skillName);
            } else if (level === 'trained') {
                // Garantir que está em skills, remover de expertise
                if (!char.skills.includes(skillName)) char.skills.push(skillName);
                char.expertise = char.expertise.filter(s => s !== skillName);
            } else if (level === 'expert') {
                // Garantir que está em skills e em expertise
                if (!char.skills.includes(skillName)) char.skills.push(skillName);
                if (!char.expertise.includes(skillName)) char.expertise.push(skillName);
            }
            
            saveCharacter(char);
            closeSkillModal();
        }

        function updateVital(type, delta) { const v = state.currentChar.vitals; if (type === 'pv') v.hp += delta; if (type === 'aura') v.aura += delta; if (type === 'san') v.san += delta; saveCharacter(state.currentChar); render(); }
        function addItem() { const name = document.getElementById('new-item-name').value; if (name) { state.currentChar.inventory.push({ name, qty: 1 }); saveCharacter(state.currentChar); render(); } }
        function updateItemQty(idx, delta) { const item = state.currentChar.inventory[idx]; item.qty += delta; if (item.qty <= 0) state.currentChar.inventory.splice(idx, 1); saveCharacter(state.currentChar); render(); }
        function updateMoney(val) { state.currentChar.money = parseInt(val) || 0; saveCharacter(state.currentChar); }
        function rollDice(attrName, mod) { const d20 = Math.floor(Math.random() * 20) + 1; const total = d20 + mod; const entry = { time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}), label: attrName, dice: d20, mod: mod, total: total }; state.currentChar.history.push(entry); if (state.currentChar.history.length > 50) state.currentChar.history.shift(); saveCharacter(state.currentChar); alert(`🎲 ${attrName}\n\n[${d20}] + ${mod} = ${total}`); state.activeTab = 'DADOS'; render(); }
        
        function rollSkill(skillName, attrKey) {
            const char = state.currentChar;
            const mod = getMod(char.attributes[attrKey].value);
            const isTrained = char.skills.includes(skillName);
            const isExpert = (char.expertise || []).includes(skillName);
            
            const pb = getProficiencyBonus(char.level);
            let totalMod = mod;
            let proficiencyLabel = "";
            
            if (isExpert) {
                totalMod += (pb * 2);
                proficiencyLabel = ` (Mod ${mod} + 2xPB ${pb*2})`;
            } else if (isTrained) {
                totalMod += pb;
                proficiencyLabel = ` (Mod ${mod} + PB ${pb})`;
            } else {
                proficiencyLabel = ` (Mod ${mod})`;
            }

            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + totalMod;
            const entry = { time: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}), label: skillName + (isExpert ? " (Exp)" : ""), dice: d20, mod: totalMod, total: total };
            
            state.currentChar.history.push(entry);
            if (state.currentChar.history.length > 50) state.currentChar.history.shift();
            saveCharacter(state.currentChar);
            
            alert(`🎲 ${skillName}\n\n[${d20}] + ${totalMod}${proficiencyLabel} = ${total}`);
            // Opcional: Fechar popup
            // state.openAttrPopup = null;
            state.activeTab = 'DADOS';
            render();
        }

        function clearHistory() { if(confirm('Limpar histórico?')) { state.currentChar.history = []; saveCharacter(state.currentChar); render(); } }

        window.addEventListener('DOMContentLoaded', () => { loadCharacters(); setThemeColor('#00ff9d'); render(); });
    </script>
</body>
</html>
